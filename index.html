<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å®¢æˆ·ç®¡ç†ç³»ç»Ÿ v2.1 - CELNæ¨¡å‹ + æ¢éœ€ä¹é—® [ä¼˜åŒ–ç‰ˆ]</title>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for expert radar chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        /* è§’è‰²åˆ‡æ¢å™¨ */
        .role-switcher {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .role-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .role-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        .role-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            align-items: start;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 22px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 10px;
            border-radius: 2px;
        }

        .input-section {
            position: sticky;
            top: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
            min-height: 260px;
            transition: all 0.3s;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.5;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            box-shadow: none;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
            box-shadow: none;
        }

        .result-section {
            margin-bottom: 20px;
        }

        .result-section h3 {
            font-size: 17px;
            color: #333;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        /* CELNæ ‡ç­¾ */
        .celn-tags {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 18px;
        }

        .celn-tag {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .celn-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .celn-tag .dimension {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .celn-tag .name {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        .celn-tag .value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .celn-tag.high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .celn-tag.high .dimension,
        .celn-tag.high .name,
        .celn-tag.high .value {
            color: white;
        }

        .celn-tag.medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .celn-tag.medium .dimension,
        .celn-tag.medium .name,
        .celn-tag.medium .value {
            color: white;
        }

        /* æ¢éœ€ä¹é—® + å…³é”®è¯ç»“åˆå±•ç¤º */
        .probe-grid {
            display: grid;
            gap: 10px;
        }

        .probe-item {
            background: #f8f9fa;
            padding: 12px 14px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .probe-item.incomplete {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .probe-item.partial {
            border-left-color: #ffa500;
            background: #fff8e6;
        }

        .probe-item .question-label {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .probe-item.incomplete .question-label {
            color: #ff6b6b;
        }

        .probe-item.partial .question-label {
            color: #ffa500;
        }

        .probe-item .answer {
            font-size: 13px;
            color: #333;
            line-height: 1.5;
            flex: 1;
        }

        .probe-item .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            margin-left: 10px;
        }

        .probe-item .status-badge.complete {
            background: #d4edda;
            color: #155724;
        }

        .probe-item .status-badge.incomplete {
            background: #f8d7da;
            color: #721c24;
        }

        .probe-item .status-badge.partial {
            background: #fff3cd;
            color: #856404;
        }

        /* è¯æœ¯æ¨è */
        .script-box {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            position: relative;
        }

        .script-box h4 {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
            padding-right: 80px;
        }

        .script-box p {
            font-size: 13px;
            color: #333;
            line-height: 1.8;
        }

        /* å¤åˆ¶æŒ‰é’® */
        .copy-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 6px 14px;
            background: rgba(255, 255, 255, 0.9);
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .copy-btn:hover {
            background: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
        }

        .copy-btn.copied {
            background: #4caf50;
            color: white;
        }

        .script-box.probing {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .script-box.closing {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .script-box.objection_handling {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 56px;
            margin-bottom: 14px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .key-points {
            background: #f0f7ff;
            padding: 14px;
            border-radius: 10px;
            margin-top: 14px;
        }

        .key-points h4 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .key-points ul {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            font-size: 12px;
            color: #333;
            line-height: 1.8;
            padding-left: 16px;
            position: relative;
        }

        .key-points li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .example-box {
            background: #fff9e6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 14px;
            border-left: 3px solid #faad14;
        }

        .example-box .title {
            font-size: 12px;
            color: #faad14;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .example-box .content {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        /* åº—é•¿é¡µé¢æ ·å¼ */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.drag-over {
            border-color: #764ba2;
            background: #e8ebff;
        }

        .upload-area .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-area p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-area .hint {
            font-size: 12px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 6px;
        }

        .stat-card .subtext {
            font-size: 12px;
            color: #999;
        }

        /* æ¢éœ€å®Œæˆåº¦æ¡ */
        .probe-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .probe-bar .label {
            font-size: 12px;
            color: #666;
            min-width: 120px;
        }

        .probe-bar .bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .probe-bar .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .probe-bar .bar-fill.low {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .probe-bar .bar-fill.medium {
            background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
        }

        .probe-bar .percentage {
            font-size: 11px;
            color: white;
            font-weight: 600;
        }

        /* ä¸“å®¶åˆ—è¡¨ */
        .expert-list {
            display: grid;
            gap: 20px;
        }

        .expert-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .expert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expert-header:hover {
            background: #f8f9ff;
            margin: -5px -10px 15px -10px;
            padding: 5px 10px 20px 10px;
            border-radius: 8px;
        }

        .expert-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            font-size: 14px;
            color: #667eea;
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .expert-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
        }

        .expert-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .expert-details {
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .expert-details.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .weakness-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .weakness-item {
            background: #fff5f5;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #ff6b6b;
            font-size: 12px;
        }

        .weakness-item .label {
            color: #d32f2f;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .weakness-item .count {
            color: #666;
            font-size: 11px;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .customer-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #e8e8e8;
        }

        .customer-table td {
            padding: 10px;
            font-size: 12px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }

        .customer-table tr:hover {
            background: #f8f9ff;
        }

        .issue-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .issue-badge.critical {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .issue-badge.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .level-badge.A {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .level-badge.B {
            background: #fff3e0;
            color: #f57c00;
        }

        .level-badge.C {
            background: #e3f2fd;
            color: #1976d2;
        }

        .level-badge.FC {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .level-badge.é•¿æœŸ {
            background: #e8f5e9;
            color: #388e3c;
        }

        .level-badge.å·²æˆ˜è´¥ {
            background: #fafafa;
            color: #757575;
        }

        .level-badge.å·²é”å• {
            background: #fff9c4;
            color: #f57f17;
        }

        .level-badge.å…¶ä»– {
            background: #f5f5f5;
            color: #616161;
        }

        /* æœç´¢å’Œç­›é€‰åŒºåŸŸ */
        .search-filter-bar {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 16px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box .search-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            font-size: 16px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            padding: 10px 14px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 13px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-select:focus {
            outline: none;
            border-color: #667eea;
        }

        .filter-btn {
            padding: 10px 18px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px;
            font-size: 13px;
            color: #666;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .filter-btn:hover {
            background: #e8e8e8;
        }

        .filter-btn.active {
            background: #667eea;
            color: white;
        }

        /* ä¸“å®¶é›·è¾¾å›¾æ ·å¼ */
        .expert-radar-container {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .expert-radar-container h4 {
            font-size: 15px;
            color: #333;
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
        }

        .expert-radar-canvas {
            max-width: 350px;
            max-height: 350px;
            margin: 0 auto;
            display: block;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .input-section {
                position: relative;
                top: 0;
            }

            .celn-tags {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— æ™ºèƒ½å®¢æˆ·ç®¡ç†ç³»ç»Ÿ v2.1</h1>
            <p>åŸºäºCELNæ¨¡å‹ + æ¢éœ€ä¹é—®çš„æ™ºèƒ½å®¢æˆ·ç”»åƒåˆ†æç³»ç»Ÿ | æ–°å¢ï¼šå†å²è®°å½•ã€ä¸€é”®å¤åˆ¶ã€å¿«é€Ÿç­›é€‰</p>
        </div>

        <!-- è§’è‰²åˆ‡æ¢å™¨ -->
        <div class="role-switcher">
            <button class="role-btn active" onclick="switchRole('expert')">
                ğŸ¯ ä¸“å®¶è§†å›¾
            </button>
            <button class="role-btn" onclick="switchRole('manager')">
                ğŸ“Š åº—é•¿è§†å›¾
            </button>
        </div>

        <!-- ä¸“å®¶è§†å›¾ -->
        <div id="expertPage" class="page active">
            <div class="main-grid">
                <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
                <div class="input-section">
                    <div class="card">
                        <h2>å®¢æˆ·ä¿¡æ¯å½•å…¥</h2>

                        <div class="example-box">
                            <div class="title">ğŸ’¡ è¾“å…¥æç¤º</div>
                            <div class="content">
                                è¯·ç”¨è‡ªç„¶è¯­è¨€æè¿°å®¢æˆ·ï¼ŒåŒ…å«ï¼šèƒ½æºå½¢å¼ã€ç”¨è½¦æƒ…å†µã€ç”¨è½¦åœºæ™¯ã€è´­è½¦é¢„ç®—ã€å®¶åº­ç»“æ„ã€å†³ç­–äººã€å…³æ³¨åŠŸèƒ½ã€ç«å“å¯¹æ¯”ã€è´­ä¹°æ—¶é—´ç­‰ä¿¡æ¯
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                <span>å®¢æˆ·æè¿°ï¼ˆè‡ªç„¶è¯­è¨€è¾“å…¥ï¼‰</span>
                            </label>
                            <textarea id="customerInput" placeholder="ä¾‹å¦‚ï¼š

å®¢æˆ·æ˜¯ä¸€ä½30å²çš„ç”·æ€§ï¼Œç›®å‰åœ¨ä¸€å®¶äº’è”ç½‘å…¬å¸æ‹…ä»»äº§å“ç»ç†ã€‚ä»–æƒ³ä¹°ä¸€è¾†æ–°èƒ½æºSUVï¼Œé¢„ç®—åœ¨30-35ä¸‡ä¹‹é—´ï¼Œä¸»è¦ç”¨äºå®¶åº­å‡ºè¡Œå’Œå‘¨æœ«å¸¦å­©å­å»éƒŠæ¸¸ã€‚

å†³ç­–äººæ˜¯ä»–æœ¬äººï¼Œä½†éœ€è¦å’Œå¦»å­å•†é‡ã€‚ä»–ç›®å‰åœ¨å¯¹æ¯”ç†æƒ³L7å’Œè”šæ¥ES6è¿™ä¸¤æ¬¾è½¦å‹ï¼Œè®¡åˆ’åœ¨3ä¸ªæœˆå†…å®Œæˆè´­ä¹°ã€‚

ä»–æ¯”è¾ƒå…³æ³¨çš„æ˜¯ç»­èˆªé‡Œç¨‹å’Œæ™ºèƒ½é©¾é©¶åŠŸèƒ½ï¼Œæ‹…å¿ƒæ–°èƒ½æºè½¦åœ¨å†¬å¤©ç»­èˆªä¼šå¤§å¹…ç¼©æ°´ï¼ŒåŒæ—¶ä¹Ÿå…³å¿ƒå……ç”µä¾¿åˆ©æ€§ã€‚

ä»–ä½åœ¨æœé˜³åŒºï¼Œä¹‹å‰åœ¨ä¸‰é‡Œå±¯å’Œæœ›äº¬çš„ç†æƒ³é—¨åº—éƒ½çœ‹è¿‡è½¦ã€‚æ²Ÿé€šè®°å½•ï¼š1.24ç”µè¯æ²Ÿé€šã€1.17åˆ°åº—è¯•é©¾ã€1.10é¦–æ¬¡æ¥è§¦ã€‚ä»–ä¸»è¦é¡¾è™‘è¿˜æ˜¯åœ¨ç«å“å¯¹æ¯”ä¸Šï¼Œå¯¹é‡‘èæ”¿ç­–æ¯”è¾ƒæ•æ„Ÿï¼Œæƒ³äº†è§£ä½æ¯è´·æ¬¾æ–¹æ¡ˆï¼Œæ‰‹ä¸Šæœ‰ä¸€è¾†å®é©¬3ç³»æƒ³ç½®æ¢ã€‚"></textarea>
                            <div class="hint">ğŸ” ç³»ç»Ÿå°†æ™ºèƒ½è¯†åˆ«å…³é”®è¯ï¼Œå¹¶åŸºäºæ¢éœ€ä¹é—®è¿›è¡Œåˆ†æ</div>
                        </div>

                        <button class="btn" onclick="analyzeCustomer()">
                            ğŸ¤– æ™ºèƒ½åˆ†æå®¢æˆ·ç”»åƒ
                        </button>

                        <button class="btn btn-secondary" onclick="showHistoryList()">
                            ğŸ“‹ æŸ¥çœ‹å†å²è®°å½•
                        </button>

                        <button class="btn btn-secondary" onclick="fillExample()">
                            ğŸ“ å¡«å……ç¤ºä¾‹æ•°æ®
                        </button>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šåˆ†æç»“æœ -->
                <div class="card">
                    <h2>AIåˆ†æç»“æœ</h2>
                    <div id="resultArea">
                        <div class="empty-state">
                            <div class="icon">ğŸ“Š</div>
                            <p>è¯·åœ¨å·¦ä¾§è¾“å…¥å®¢æˆ·ä¿¡æ¯åç‚¹å‡»"æ™ºèƒ½åˆ†æ"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº—é•¿è§†å›¾ -->
        <div id="managerPage" class="page">
            <div class="card">
                <h2>å®¢æˆ·ç®¡ç†Excelå¯¼å…¥</h2>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('excelFile').click()">
                    <div class="icon">ğŸ“</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å®¢æˆ·ç®¡ç†Excelæ–‡ä»¶</p>
                    <div class="hint">æ”¯æŒ .xlsx / .xls æ ¼å¼ï¼Œéœ€åŒ…å«ï¼šä¸“å®¶å§“åã€å®¢æˆ·å§“åã€å•†æœºç­‰çº§(A/B/C/FC)ã€å®¢æˆ·æè¿°ç­‰å­—æ®µ</div>
                </div>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileUpload(event)">

                <div id="managerAnalysis" style="display: none;">
                    <!-- æœç´¢å’Œç­›é€‰æ  -->
                    <div class="search-filter-bar">
                        <div class="search-box">
                            <input type="text" id="searchInput" placeholder="ğŸ” æœç´¢å®¢æˆ·å§“åæˆ–ä¸“å®¶å§“å..." oninput="applyFilters()">
                            <span class="search-icon">ğŸ”</span>
                        </div>
                        <div class="filter-group">
                            <select id="levelFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨å•†æœºç­‰çº§</option>
                                <option value="A">Aç±»å•†æœº</option>
                                <option value="B">Bç±»å•†æœº</option>
                                <option value="C">Cç±»å•†æœº</option>
                                <option value="FC">FCå•†æœº</option>
                                <option value="é•¿æœŸ">é•¿æœŸå®¢æˆ·</option>
                                <option value="å·²é”å•">å·²é”å•</option>
                                <option value="å·²æˆ˜è´¥">å·²æˆ˜è´¥</option>
                            </select>
                            <select id="completionFilter" class="filter-select" onchange="applyFilters()">
                                <option value="">å…¨éƒ¨å®Œæˆåº¦</option>
                                <option value="high">é«˜(â‰¥70%)</option>
                                <option value="medium">ä¸­(40-70%)</option>
                                <option value="low">ä½(<40%)</option>
                            </select>
                            <button class="filter-btn" onclick="resetFilters()">é‡ç½®ç­›é€‰</button>
                        </div>
                    </div>

                    <!-- æ•´ä½“ç»Ÿè®¡ -->
                    <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">ğŸ“ˆ æ•´ä½“å•†æœºç»Ÿè®¡</h3>
                    <div class="stats-grid">
                        <!-- ç»Ÿè®¡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- æ¢éœ€è–„å¼±é¡¹åˆ†æ -->
                    <h3 style="font-size: 18px; margin: 25px 0 15px; color: #333;">âš ï¸ å›¢é˜Ÿæ¢éœ€è–„å¼±é¡¹ TOP5ï¼ˆæŒ‰å®Œæˆåº¦ä»ä½åˆ°é«˜ï¼‰</h3>
                    <div id="weaknessAnalysis"></div>

                    <!-- ä¸“å®¶åˆ—è¡¨ -->
                    <h3 style="font-size: 18px; margin: 25px 0 15px; color: #333;">ğŸ‘¥ å„ä¸“å®¶è¯¦ç»†åˆ†æ</h3>
                    <div id="expertList" class="expert-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let managerData = null;
        let currentAnalysisResult = null; // å½“å‰åˆ†æç»“æœ
        let filteredData = null; // ç­›é€‰åçš„æ•°æ®
        const MAX_HISTORY_ITEMS = 10; // æœ€å¤šä¿å­˜10æ¡å†å²è®°å½•
        let expertRadarDataGlobal = {}; // å­˜å‚¨æ‰€æœ‰ä¸“å®¶çš„é›·è¾¾å›¾æ•°æ®

        // å¸‚åœºè½¦å‹ä»·æ ¼åº“ï¼ˆå•ä½ï¼šä¸‡å…ƒï¼‰
        const VEHICLE_PRICE_DB = {
            // ç†æƒ³è½¦å‹
            'L6': { brand: 'ç†æƒ³', price: 25, range: [24, 28] },
            'L7': { brand: 'ç†æƒ³', price: 35, range: [33, 38] },
            'L8': { brand: 'ç†æƒ³', price: 40, range: [40, 50] },
            'L9': { brand: 'ç†æƒ³', price: 50, range: [45, 55] },
            'MEGA': { brand: 'ç†æƒ³', price: 56, range: [55, 60] },
            'i6': { brand: 'ç†æƒ³', price: 27, range: [25, 30] },
            'i8': { brand: 'ç†æƒ³', price: 41, range: [36, 46] },

            // è”šæ¥
            'ES6': { brand: 'è”šæ¥', price: 35, range: [35, 44] },
            'ES7': { brand: 'è”šæ¥', price: 43, range: [42, 52] },
            'ES8': { brand: 'è”šæ¥', price: 50, range: [49, 59] },
            'ET5': { brand: 'è”šæ¥', price: 30, range: [29, 35] },
            'ET7': { brand: 'è”šæ¥', price: 43, range: [42, 52] },
            'EC6': { brand: 'è”šæ¥', price: 36, range: [35, 44] },

            // å°é¹
            'G6': { brand: 'å°é¹', price: 23, range: [20, 28] },
            'G9': { brand: 'å°é¹', price: 30, range: [26, 40] },
            'P7': { brand: 'å°é¹', price: 25, range: [23, 33] },
            'X9': { brand: 'å°é¹', price: 36, range: [36, 42] },

            // é—®ç•Œ
            'M5': { brand: 'é—®ç•Œ', price: 26, range: [25, 30] },
            'M7': { brand: 'é—®ç•Œ', price: 28, range: [25, 35] },
            'M9': { brand: 'é—®ç•Œ', price: 47, range: [47, 57] },

            // ç‰¹æ–¯æ‹‰
            'Model 3': { brand: 'ç‰¹æ–¯æ‹‰', price: 26, range: [23, 34] },
            'Model Y': { brand: 'ç‰¹æ–¯æ‹‰', price: 28, range: [25, 36] },
            'Model S': { brand: 'ç‰¹æ–¯æ‹‰', price: 70, range: [70, 85] },
            'Model X': { brand: 'ç‰¹æ–¯æ‹‰', price: 75, range: [75, 90] },

            // æ¯”äºšè¿ª
            'æ±‰': { brand: 'æ¯”äºšè¿ª', price: 22, range: [18, 32] },
            'å”': { brand: 'æ¯”äºšè¿ª', price: 23, range: [20, 33] },
            'æµ·è±¹': { brand: 'æ¯”äºšè¿ª', price: 22, range: [18, 28] },
            'ä»°æœ›U8': { brand: 'æ¯”äºšè¿ª', price: 110, range: [110, 120] },

            // è…¾åŠ¿
            'D9': { brand: 'è…¾åŠ¿', price: 37, range: [34, 47] },
            'N7': { brand: 'è…¾åŠ¿', price: 30, range: [30, 38] },
            'N8': { brand: 'è…¾åŠ¿', price: 32, range: [32, 40] },

            // ææ°ª
            '001': { brand: 'ææ°ª', price: 30, range: [27, 38] },
            '009': { brand: 'ææ°ª', price: 50, range: [50, 59] },
            'X': { brand: 'ææ°ª', price: 30, range: [30, 38] },

            // ä¼ ç»Ÿè±ªåå“ç‰Œ
            'GL8': { brand: 'åˆ«å…‹', price: 28, range: [23, 53] },
            'åŸƒå°”æ³•': { brand: 'ä¸°ç”°', price: 85, range: [82, 92] },
            'Vçº§': { brand: 'å¥”é©°', price: 50, range: [48, 65] },
            'Q5': { brand: 'å¥¥è¿ª', price: 41, range: [39, 50] },
            'Q7': { brand: 'å¥¥è¿ª', price: 70, range: [69, 86] },
            '3ç³»': { brand: 'å®é©¬', price: 32, range: [30, 40] },
            '5ç³»': { brand: 'å®é©¬', price: 44, range: [43, 66] },
            'X3': { brand: 'å®é©¬', price: 40, range: [39, 48] },
            'X5': { brand: 'å®é©¬', price: 62, range: [60, 85] },
            'GLC': { brand: 'å¥”é©°', price: 42, range: [40, 50] },
            'GLE': { brand: 'å¥”é©°', price: 71, range: [70, 90] }
        };

        // è½¦å‹åç§°çš„å„ç§å˜ä½“ï¼ˆç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
        const VEHICLE_ALIASES = {
            // ç‰¹æ–¯æ‹‰
            'model3': 'Model 3',
            'modely': 'Model Y',
            'models': 'Model S',
            'modelx': 'Model X',
            'tsl': 'Tesla',
            'tsla': 'Tesla',

            // åˆ«å…‹
            'gl8': 'GL8',

            // å¥¥è¿ª
            'q5': 'Q5',
            'q7': 'Q7',

            // å®é©¬
            'x3': 'X3',
            'x5': 'X5',
            'bmw': 'BMW',

            // è”šæ¥
            'es6': 'ES6',
            'es7': 'ES7',
            'es8': 'ES8',
            'et5': 'ET5',
            'et7': 'ET7',
            'ec6': 'EC6',
            'nio': 'è”šæ¥',
            'wl': 'è”šæ¥',

            // å°é¹
            'g6': 'G6',
            'g9': 'G9',
            'p7': 'P7',
            'x9': 'X9',
            'xp': 'å°é¹',
            'xpeng': 'å°é¹',

            // é—®ç•Œ
            'm5': 'M5',
            'm7': 'M7',
            'm9': 'M9',
            'wj': 'é—®ç•Œ',
            'aito': 'é—®ç•Œ',

            // è…¾åŠ¿
            'd9': 'D9',
            'n7': 'N7',
            'n8': 'N8',
            'denza': 'è…¾åŠ¿',

            // ç†æƒ³
            'l6': 'L6',
            'l7': 'L7',
            'l8': 'L8',
            'l9': 'L9',
            'i6': 'i6',
            'i8': 'i8',
            'lx': 'ç†æƒ³',
            'li': 'ç†æƒ³',
            'mega': 'MEGA',

            // ææ°ª
            'ææ°ª001': '001',
            'ææ°ª009': '009',
            'ææ°ªx': 'X',
            'zeekr': 'ææ°ª',

            // æ¯”äºšè¿ª
            'byd': 'æ¯”äºšè¿ª',
            'ä»°æœ›u8': 'ä»°æœ›U8',
            'u8': 'ä»°æœ›U8'
        };

        // å“ç‰Œåˆ«åæ˜ å°„ï¼ˆç”¨äºè¯†åˆ«å“ç‰Œç®€å†™ï¼‰
        const BRAND_ALIASES = {
            'tsl': 'ç‰¹æ–¯æ‹‰',
            'tsla': 'ç‰¹æ–¯æ‹‰',
            'tesla': 'ç‰¹æ–¯æ‹‰',
            'nio': 'è”šæ¥',
            'wl': 'è”šæ¥',
            'xp': 'å°é¹',
            'xpeng': 'å°é¹',
            'wj': 'é—®ç•Œ',
            'aito': 'é—®ç•Œ',
            'lx': 'ç†æƒ³',
            'li': 'ç†æƒ³',
            'bmw': 'å®é©¬',
            'benz': 'å¥”é©°',
            'mercedes': 'å¥”é©°',
            'audi': 'å¥¥è¿ª',
            'byd': 'æ¯”äºšè¿ª',
            'zeekr': 'ææ°ª',
            'denza': 'è…¾åŠ¿'
        };

        // æå–æ—¥æœŸï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        function extractDates(text) {
            const dates = new Set();
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // æ ¼å¼1: 0126, 1226 (MMDD)
            const pattern1 = /(\d{4})(?![.\-å¹´æœˆ])/g;
            let match;
            while ((match = pattern1.exec(text)) !== null) {
                const str = match[1];
                const month = parseInt(str.substring(0, 2));
                const day = parseInt(str.substring(2, 4));
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // åˆ¤æ–­å¹´ä»½ï¼šå¦‚æœæœˆä»½>å½“å‰æœˆä»½ï¼Œè¯´æ˜æ˜¯å»å¹´çš„
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            // æ ¼å¼2: 1-26, 12-26 (M-DD æˆ– MM-DD)
            const pattern2 = /(\d{1,2})-(\d{1,2})(?![å¹´æœˆ])/g;
            while ((match = pattern2.exec(text)) !== null) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            // æ ¼å¼3: 1.26, 12.26 (M.DD æˆ– MM.DD)
            const pattern3 = /(\d{1,2})\.(\d{1,2})(?![å¹´æœˆ])/g;
            while ((match = pattern3.exec(text)) !== null) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            // æ ¼å¼4: 1æœˆ26æ—¥, 12æœˆ26æ—¥
            const pattern4 = /(\d{1,2})æœˆ(\d{1,2})[æ—¥å·]/g;
            while ((match = pattern4.exec(text)) !== null) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            return Array.from(dates).sort();
        }

        // è¯†åˆ«è½¦å‹ï¼ˆæ™ºèƒ½åŒ¹é…ï¼Œé¿å…è¯¯åˆ¤ï¼‰
        function extractVehicles(text) {
            const found = new Set();
            const textLower = text.toLowerCase().replace(/\s+/g, '');

            // é¦–å…ˆï¼Œç›´æ¥åŒ¹é…è½¦å‹åº“ä¸­çš„å®Œæ•´åç§°ï¼ˆç²¾ç¡®åŒ¹é…ï¼‰
            for (const model of Object.keys(VEHICLE_PRICE_DB)) {
                const modelLower = model.toLowerCase().replace(/\s+/g, '');
                // ä½¿ç”¨å•è¯è¾¹ç•Œï¼Œé¿å…è¯¯åŒ¹é…ï¼ˆå¦‚gl8ä¸åŒ¹é…l8ï¼‰
                const regex = new RegExp(`(?:^|[^a-z0-9])${modelLower}(?:[^a-z0-9]|$)`, 'i');
                if (regex.test(textLower)) {
                    found.add(model);
                }
            }

            // åˆ«ååŒ¹é…ï¼ˆæ›´ä¸¥æ ¼ï¼Œé¿å…è¯¯åŒ¹é…ï¼‰
            for (const [alias, standard] of Object.entries(VEHICLE_ALIASES)) {
                const aliasLower = alias.toLowerCase();

                // å¯¹äºå•å­—æ¯+æ•°å­—çš„è½¦å‹ï¼ˆå¦‚L6, L7, L8ï¼‰ï¼Œéœ€è¦ç‰¹åˆ«å°å¿ƒ
                if (/^[a-z]\d+$/.test(aliasLower)) {
                    // æ£€æŸ¥æ˜¯å¦åœ¨gl8ç­‰è¯ä¸­ï¼ˆå¦‚gl8ä¸åº”è¯¥åŒ¹é…l8ï¼‰
                    const regex = new RegExp(`(?:^|[^a-z])${aliasLower}(?:[^a-z0-9]|$)`, 'i');
                    if (regex.test(textLower)) {
                        // é¢å¤–æ£€æŸ¥ï¼šç¡®ä¿ä¸æ˜¯gl8, ml8ç­‰æƒ…å†µ
                        const contextRegex = new RegExp(`[a-z]${aliasLower}`, 'i');
                        if (!contextRegex.test(textLower)) {
                            if (VEHICLE_PRICE_DB[standard]) {
                                found.add(standard);
                            }
                        }
                    }
                } else {
                    // æ™®é€šåˆ«ååŒ¹é…
                    if (textLower.includes(aliasLower)) {
                        // å¦‚æœæ˜¯å“ç‰Œåˆ«åï¼Œè·³è¿‡ï¼ˆå“ç‰Œç”±å“ç‰Œè¯†åˆ«å¤„ç†ï¼‰
                        if (!BRAND_ALIASES[aliasLower]) {
                            if (VEHICLE_PRICE_DB[standard]) {
                                found.add(standard);
                            }
                        }
                    }
                }
            }

            return Array.from(found);
        }

        // è¯†åˆ«è½¦å‹å¹¶åŒºåˆ†ç±»å‹ï¼ˆæ„å‘/ç«å“/ç½®æ¢ï¼‰
        function extractVehiclesWithContext(text) {
            const allVehicles = extractVehicles(text);
            const result = {
                ideal: [], // ç†æƒ³å“ç‰Œè½¦å‹ï¼ˆæ„å‘è½¦å‹ï¼‰
                competitors: [], // ç«å“è½¦å‹
                tradeIn: null // ç½®æ¢è½¦å‹
            };

            // ä¸Šä¸‹æ–‡å…³é”®è¯
            const intentionKeywords = ['å…³æ³¨', 'æƒ³ä¹°', 'çœ‹ä¸­', 'æ„å‘', 'è€ƒè™‘', 'æ‰“ç®—ä¹°'];
            const tradeInKeywords = ['ç°åœ¨æœ‰', 'ç›®å‰å¼€', 'æ—§è½¦', 'ç½®æ¢', 'æ‰‹ä¸Šæœ‰', 'ä¹‹å‰å¼€', 'ç°åœ¨å¼€'];
            const compareKeywords = ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'è¿˜åœ¨çœ‹', 'ä¹Ÿåœ¨çœ‹'];

            allVehicles.forEach(vehicle => {
                const vehicleInfo = VEHICLE_PRICE_DB[vehicle];
                if (!vehicleInfo) return;

                // æŸ¥æ‰¾è½¦å‹åœ¨æ–‡æœ¬ä¸­çš„ä½ç½®å’Œä¸Šä¸‹æ–‡
                const vehicleIndex = text.toLowerCase().indexOf(vehicle.toLowerCase());
                const contextBefore = text.substring(Math.max(0, vehicleIndex - 20), vehicleIndex);
                const contextAfter = text.substring(vehicleIndex, Math.min(text.length, vehicleIndex + vehicle.length + 20));
                const context = contextBefore + contextAfter;

                if (vehicleInfo.brand === 'ç†æƒ³') {
                    // ç†æƒ³å“ç‰Œ â†’ æ„å‘è½¦å‹
                    result.ideal.push(vehicle);
                } else {
                    // åˆ¤æ–­æ˜¯ç½®æ¢è½¦å‹è¿˜æ˜¯ç«å“
                    const isTradeIn = tradeInKeywords.some(kw => context.includes(kw));
                    const isCompare = compareKeywords.some(kw => context.includes(kw));

                    if (isTradeIn && !isCompare) {
                        // ç½®æ¢è½¦å‹
                        if (!result.tradeIn) {
                            result.tradeIn = `${vehicleInfo.brand} ${vehicle}`;
                        }
                    } else {
                        // ç«å“è½¦å‹
                        result.competitors.push(`${vehicleInfo.brand} ${vehicle}`);
                    }
                }
            });

            return result;
        }

        // æ ¹æ®è½¦å‹æ¨æ–­é¢„ç®—åŒºé—´
        function estimateBudgetFromVehicles(vehicles) {
            if (vehicles.length === 0) return null;

            const prices = vehicles.map(v => VEHICLE_PRICE_DB[v]).filter(p => p);
            if (prices.length === 0) return null;

            // å–æ‰€æœ‰è½¦å‹ä»·æ ¼çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä½œä¸ºé¢„ç®—åŒºé—´
            const minPrice = Math.min(...prices.map(p => p.range[0]));
            const maxPrice = Math.max(...prices.map(p => p.range[1]));

            return {
                min: minPrice,
                max: maxPrice,
                avg: Math.round((minPrice + maxPrice) / 2)
            };
        }

        // è§’è‰²åˆ‡æ¢
        function switchRole(role) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢é¡µé¢
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            if (role === 'expert') {
                document.getElementById('expertPage').classList.add('active');
            } else if (role === 'manager') {
                document.getElementById('managerPage').classList.add('active');
            }
        }

        // æ¢éœ€ä¹é—®é…ç½®
        const NINE_QUESTIONS = [
            {
                id: 'energy_intention',
                label: '1. èƒ½æºå½¢å¼-è´­è½¦æ„å‘',
                question: 'æ‰“ç®—ä¹°å¢ç¨‹è¿˜æ˜¯çº¯ç”µï¼Ÿ',
                keywords: ['å¢ç¨‹', 'çº¯ç”µ', 'æ–°èƒ½æº', 'ç”µåŠ¨'],
                extract: (text) => {
                    if (text.includes('å¢ç¨‹')) return { answer: 'å¢ç¨‹', status: 'complete' };
                    if (text.includes('çº¯ç”µ')) return { answer: 'çº¯ç”µ', status: 'complete' };
                    if (text.includes('æ–°èƒ½æº') || text.includes('ç”µåŠ¨')) return { answer: 'æ–°èƒ½æºï¼ˆæœªæ˜ç¡®å¢ç¨‹/çº¯ç”µï¼‰', status: 'partial' };
                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'current_car',
                label: '2. ç”¨è½¦æƒ…å†µ',
                question: 'ç°åœ¨å¼€ä»€ä¹ˆè½¦ï¼Ÿç½®æ¢è¿˜æ˜¯å¢è´­ï¼Ÿ',
                keywords: ['ç½®æ¢', 'å¢è´­', 'æ—§è½¦', 'ç°åœ¨å¼€', 'ç›®å‰å¼€'],
                extract: (text) => {
                    let answer = [];
                    let status = 'incomplete';

                    if (text.includes('ç½®æ¢') || text.includes('ä»¥æ—§æ¢æ–°')) {
                        answer.push('ç½®æ¢');
                        status = 'partial';
                    } else if (text.includes('å¢è´­') || text.includes('ç¬¬äºŒè¾†')) {
                        answer.push('å¢è´­');
                        status = 'partial';
                    }

                    const carBrands = ['å¥”é©°', 'å®é©¬', 'BMW', 'å¥¥è¿ª', 'ç‰¹æ–¯æ‹‰', 'è”šæ¥', 'å°é¹', 'ç†æƒ³', 'æ¯”äºšè¿ª', 'ä¸°ç”°', 'æœ¬ç”°', 'å¤§ä¼—'];
                    const foundBrands = carBrands.filter(brand => text.includes(brand));
                    if (foundBrands.length > 0) {
                        answer.push(`å½“å‰è½¦ï¼š${foundBrands.join('ã€')}`);
                        status = answer.length >= 2 ? 'complete' : 'partial';
                    }

                    return {
                        answer: answer.length > 0 ? answer.join('ï¼Œ') : 'æ¢éœ€ä¸åˆ°ä½',
                        status: answer.length === 0 ? 'incomplete' : status
                    };
                }
            },
            {
                id: 'usage_scenario',
                label: '3. ç”¨è½¦åœºæ™¯',
                question: 'å¸‚å†…é€šå‹¤çŸ­é€”è¿˜æ˜¯é•¿é€”è‡ªé©¾ï¼Ÿ',
                keywords: ['é€šå‹¤', 'ä¸Šä¸‹ç­', 'çŸ­é€”', 'é•¿é€”', 'è‡ªé©¾', 'å¸‚å†…', 'éƒŠæ¸¸', 'æ—…æ¸¸'],
                extract: (text) => {
                    let scenarios = [];
                    if (text.includes('é€šå‹¤') || text.includes('ä¸Šä¸‹ç­')) scenarios.push('é€šå‹¤');
                    if (text.includes('çŸ­é€”') || text.includes('å¸‚å†…')) scenarios.push('å¸‚å†…çŸ­é€”');
                    if (text.includes('é•¿é€”') || text.includes('è‡ªé©¾') || text.includes('æ—…æ¸¸')) scenarios.push('é•¿é€”è‡ªé©¾');
                    if (text.includes('éƒŠæ¸¸') || text.includes('å‘¨æœ«')) scenarios.push('å‘¨æœ«å‡ºæ¸¸');
                    if (text.includes('æ¥é€å­©å­') || text.includes('æ¥å¨ƒ')) scenarios.push('æ¥é€å­©å­');
                    if (text.includes('å®¶åº­å‡ºè¡Œ')) scenarios.push('å®¶åº­å‡ºè¡Œ');

                    if (scenarios.length === 0) return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                    return { answer: scenarios.join('ã€'), status: 'complete' };
                }
            },
            {
                id: 'budget',
                label: '4. è´­è½¦é¢„ç®—',
                question: 'é¢„ç®—å¤§è‡´èŒƒå›´ï¼Ÿ',
                keywords: ['é¢„ç®—', 'ä¸‡', 'ä»·æ ¼'],
                extract: (text) => {
                    // å…ˆå°è¯•ç›´æ¥åŒ¹é…é¢„ç®—
                    const budgetMatch = text.match(/(\d+)[-~åˆ°](\d+)ä¸‡/);
                    if (budgetMatch) {
                        return { answer: `${budgetMatch[1]}-${budgetMatch[2]}ä¸‡ï¼ˆæ˜ç¡®ï¼‰`, status: 'complete' };
                    }
                    const singleBudget = text.match(/é¢„ç®—[çº¦å¤§æ¦‚å·¦å³]*(\d+)ä¸‡/);
                    if (singleBudget) {
                        return { answer: `çº¦${singleBudget[1]}ä¸‡ï¼ˆæ˜ç¡®ï¼‰`, status: 'complete' };
                    }

                    // å¦‚æœæ²¡æœ‰ç›´æ¥é¢„ç®—ï¼Œé€šè¿‡è½¦å‹æ¨æ–­
                    const vehicles = extractVehicles(text);
                    const estimatedBudget = estimateBudgetFromVehicles(vehicles);
                    if (estimatedBudget) {
                        return {
                            answer: `${estimatedBudget.min}-${estimatedBudget.max}ä¸‡ï¼ˆæ ¹æ®å¯¹æ¯”è½¦å‹æ¨æ–­ï¼‰`,
                            status: 'partial'
                        };
                    }

                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'family_structure',
                label: '5. å®¶åº­ç»“æ„',
                question: 'æƒ³çœ‹å“ªæ¬¾è½¦/å®¶é‡Œå‡ å£äººï¼Ÿ',
                keywords: ['å£äºº', 'å®¶åº­', 'å­©å­', 'è€äºº', 'å¤«å¦»', 'L6', 'L7', 'L8', 'L9', 'MEGA'],
                extract: (text) => {
                    let answer = [];

                    const familyMatch = text.match(/(\d+)å£äºº/);
                    if (familyMatch) {
                        answer.push(`${familyMatch[1]}å£äºº`);
                    } else {
                        let count = 0;
                        if (text.includes('å¤«å¦»') || text.includes('å¦»å­') || text.includes('è€å©†') || text.includes('è€å…¬')) count += 2;
                        if (text.includes('å­©å­') || text.includes('å°å­©') || text.includes('å„¿å­') || text.includes('å¥³å„¿')) count += 1;
                        if (text.includes('è€äºº') || text.includes('çˆ¶æ¯')) count += 2;
                        if (count > 0) answer.push(`çº¦${count}+å£äºº`);
                    }

                    const models = ['L6', 'L7', 'L8', 'L9', 'MEGA'];
                    const foundModels = models.filter(m => text.includes(m));
                    if (foundModels.length > 0) {
                        answer.push(`æ„å‘ï¼š${foundModels.join('ã€')}`);
                    }

                    if (answer.length === 0) return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                    return { answer: answer.join('ï¼Œ'), status: answer.length >= 2 ? 'complete' : 'partial' };
                }
            },
            {
                id: 'decision_maker',
                label: '6. å†³ç­–äºº',
                question: 'ä¸»è¦æ˜¯è°åœ¨ç”¨è½¦/è°å†³ç­–ï¼Ÿ',
                keywords: ['æœ¬äºº', 'è‡ªå·±', 'å®¶äºº', 'å¦»å­', 'è€å©†', 'è€å…¬', 'çˆ¶æ¯', 'å•†é‡', 'å†³å®š'],
                extract: (text) => {
                    // ä¼˜å…ˆåˆ¤æ–­ï¼šéœ€è¦ä»–äººåŒæ„çš„æƒ…å†µ
                    const needApproval = [
                        'ç­‰è€å…¬å›æ¥', 'ç­‰è€å©†å›æ¥', 'ç­‰çˆ±äººå›æ¥',
                        'åšä¸äº†å†³å®š', 'åšä¸äº†ä¸»', 'ä¸èƒ½è‡ªå·±å†³å®š',
                        'è€å…¬è¯´äº†ç®—', 'è€å©†è¯´äº†ç®—', 'çˆ±äººè¯´äº†ç®—', 'å®¶é‡Œäººè¯´äº†ç®—',
                        'éœ€è¦è¯·ç¤º', 'è¦é—®é—®', 'å¾—å•†é‡', 'å¿…é¡»å•†é‡'
                    ];

                    const hasNeedApproval = needApproval.some(phrase => text.includes(phrase));

                    if (hasNeedApproval) {
                        // åˆ¤æ–­å…·ä½“æ˜¯è°å†³ç­–
                        if (text.includes('è€å…¬') || text.includes('å…ˆç”Ÿ') || text.includes('ä¸ˆå¤«')) {
                            return { answer: 'è€å…¬/ä¸ˆå¤«å†³ç­–ï¼ˆéœ€ç­‰å¾…ï¼‰', status: 'complete' };
                        } else if (text.includes('è€å©†') || text.includes('å¦»å­') || text.includes('å¤ªå¤ª')) {
                            return { answer: 'è€å©†/å¦»å­å†³ç­–ï¼ˆéœ€ç­‰å¾…ï¼‰', status: 'complete' };
                        } else if (text.includes('çˆ¶æ¯') || text.includes('å®¶é•¿')) {
                            return { answer: 'çˆ¶æ¯å†³ç­–ï¼ˆéœ€ç­‰å¾…ï¼‰', status: 'complete' };
                        } else {
                            return { answer: 'å®¶åº­å…±åŒå†³ç­–ï¼ˆè‡ªå·±åšä¸äº†ä¸»ï¼‰', status: 'complete' };
                        }
                    }

                    // æ˜ç¡®å•†é‡çš„æƒ…å†µ
                    if (text.includes('å•†é‡') || text.includes('ä¸€èµ·å†³å®š') || text.includes('å…±åŒå†³å®š')) {
                        let partners = [];
                        if (text.includes('è€å…¬') || text.includes('ä¸ˆå¤«') || text.includes('å…ˆç”Ÿ')) partners.push('è€å…¬');
                        if (text.includes('è€å©†') || text.includes('å¦»å­') || text.includes('å¤ªå¤ª')) partners.push('è€å©†');
                        if (text.includes('çˆ¶æ¯') || text.includes('å®¶é•¿') || text.includes('è€äºº')) partners.push('çˆ¶æ¯');
                        if (text.includes('å­©å­') || text.includes('å­å¥³')) partners.push('å­©å­');

                        if (partners.length > 0) {
                            return { answer: `æœ¬äººä¸${partners.join('ã€')}å…±åŒå†³ç­–`, status: 'complete' };
                        } else {
                            return { answer: 'æœ¬äººä¸å®¶äººå…±åŒå†³ç­–', status: 'complete' };
                        }
                    }

                    // æœ¬äººå†³ç­–
                    if (text.includes('æœ¬äººå†³ç­–') || text.includes('è‡ªå·±å†³å®š') || text.includes('æˆ‘å†³å®š')) {
                        return { answer: 'æœ¬äººå†³ç­–', status: 'complete' };
                    }

                    // ä»…æåˆ°æœ¬äººï¼Œä½†æ²¡è¯´å•†é‡
                    if (text.includes('æœ¬äºº') || text.includes('è‡ªå·±')) {
                        return { answer: 'æœ¬äººå†³ç­–ï¼ˆæœªæ˜ç¡®æ˜¯å¦éœ€å•†é‡ï¼‰', status: 'partial' };
                    }

                    // ä»…æåˆ°å®¶äºº
                    if (text.includes('å®¶äºº') || text.includes('å®¶é‡Œ')) {
                        return { answer: 'å®¶åº­å†³ç­–ï¼ˆå…·ä½“å†³ç­–äººä¸æ˜ï¼‰', status: 'partial' };
                    }

                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'key_features',
                label: '7. å…³æ³¨åŠŸèƒ½',
                question: 'æœ€çœ‹é‡ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ',
                keywords: ['ç»­èˆª', 'æ™ºèƒ½é©¾é©¶', 'ç©ºé—´', 'èˆ’é€‚', 'å®‰å…¨', 'å……ç”µ', 'é…ç½®', 'åŠ¨åŠ›', 'æ“æ§'],
                extract: (text) => {
                    const concerns = ['ç»­èˆª', 'æ™ºèƒ½é©¾é©¶', 'ç©ºé—´', 'èˆ’é€‚', 'å®‰å…¨', 'å……ç”µ', 'ä»·æ ¼', 'ä¿å€¼ç‡', 'å”®å', 'é…ç½®', 'åŠ¨åŠ›', 'æ“æ§', 'å¤–è§‚', 'å†…é¥°'];
                    const found = concerns.filter(c => text.includes(c));
                    if (found.length === 0) return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                    return { answer: found.join('ã€'), status: 'complete' };
                }
            },
            {
                id: 'competitor_comparison',
                label: '8. ç«å“å¯¹æ¯”',
                question: 'æœ€è¿‘åœ¨çœ‹ä»€ä¹ˆå…¶ä»–è½¦ï¼Ÿ',
                keywords: ['è”šæ¥', 'å°é¹', 'é—®ç•Œ', 'ç‰¹æ–¯æ‹‰', 'æ¯”äºšè¿ª', 'å¯¹æ¯”', 'æ¯”è¾ƒ'],
                extract: (text) => {
                    // ä½¿ç”¨å¢å¼ºçš„è½¦å‹è¯†åˆ«
                    const vehicles = extractVehicles(text);
                    const brands = new Set();
                    const models = [];

                    vehicles.forEach(v => {
                        const vehicleInfo = VEHICLE_PRICE_DB[v];
                        if (vehicleInfo) {
                            brands.add(vehicleInfo.brand);
                            // åªè®°å½•éç†æƒ³å“ç‰Œçš„è½¦å‹
                            if (vehicleInfo.brand !== 'ç†æƒ³') {
                                models.push(`${vehicleInfo.brand} ${v}`);
                            }
                        }
                    });

                    // ç§»é™¤ç†æƒ³å“ç‰Œï¼ˆå› ä¸ºæ˜¯æœ¬å“ï¼‰
                    brands.delete('ç†æƒ³');

                    if (models.length > 0) {
                        return { answer: models.join('ã€'), status: 'complete' };
                    }

                    if (brands.size > 0) {
                        return { answer: Array.from(brands).join('ã€'), status: 'partial' };
                    }

                    // å›é€€åˆ°åŸæœ‰çš„å“ç‰Œå…³é”®è¯åŒ¹é…
                    const brandKeywords = ['è”šæ¥', 'å°é¹', 'é—®ç•Œ', 'ç‰¹æ–¯æ‹‰', 'æ¯”äºšè¿ª', 'è…¾åŠ¿', 'ææ°ª', 'å¥”é©°', 'å®é©¬', 'å¥¥è¿ª'];
                    const found = brandKeywords.filter(c => text.includes(c));
                    if (found.length > 0) {
                        return { answer: found.join('ã€'), status: 'partial' };
                    }

                    if (text.includes('å¯¹æ¯”') || text.includes('æ¯”è¾ƒ')) {
                        return { answer: 'æœ‰å¯¹æ¯”ï¼Œä½†å“ç‰Œ/è½¦å‹æœªæ˜ç¡®', status: 'partial' };
                    }

                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'purchase_timing',
                label: '9. è´­ä¹°æ—¶é—´',
                question: 'è®¡åˆ’ä»€ä¹ˆæ—¶å€™ç”¨è½¦ï¼Ÿ',
                keywords: ['ç«‹å³', 'é©¬ä¸Š', 'ä¸€ä¸ªæœˆ', 'ä¸‰ä¸ªæœˆ', 'åŠå¹´', 'ä»Šå¹´', 'æ˜å¹´'],
                extract: (text) => {
                    if (text.match(/ç«‹å³|é©¬ä¸Š|è¿™å‘¨|æœ¬å‘¨|ä»Šå¤©|ç°åœ¨å°±ä¹°/)) return { answer: 'ç«‹å³è´­ä¹°', status: 'complete' };
                    if (text.match(/ä¸€ä¸ªæœˆ|1ä¸ªæœˆ|æœˆå†…|è¿‘æœŸ/)) return { answer: '1ä¸ªæœˆå†…', status: 'complete' };
                    if (text.match(/ä¸‰ä¸ªæœˆ|3ä¸ªæœˆ|å­£åº¦å†…/)) return { answer: '3ä¸ªæœˆå†…', status: 'complete' };
                    if (text.match(/åŠå¹´|6ä¸ªæœˆ/)) return { answer: 'åŠå¹´å†…', status: 'partial' };
                    if (text.match(/è§‚æœ›|å†çœ‹çœ‹|ä¸æ€¥|ç­‰ç­‰/)) return { answer: 'è§‚æœ›ä¸­', status: 'partial' };
                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            }
        ];

        // CELNæ¨¡å‹é…ç½®
        const CELN_CONFIG = {
            C: {
                name: 'è´­è½¦æ„å‘',
                keywords: {
                    high: ['æƒ³ä¹°', 'è¦ä¹°', 'å‡†å¤‡ä¹°', 'è®¡åˆ’è´­ä¹°', 'æ˜ç¡®è´­ä¹°', 'ç¡®å®šè¦ä¹°'],
                    medium: ['è€ƒè™‘', 'æ‰“ç®—', 'æœ‰æ„å‘', 'çœ‹çœ‹'],
                    low: ['äº†è§£', 'éšä¾¿çœ‹çœ‹', 'å…ˆçœ‹çœ‹'],
                },
                labels: {
                    high: 'é«˜æ„å‘',
                    medium: 'ä¸­æ„å‘',
                    low: 'ä½æ„å‘',
                }
            },
            E: {
                name: 'èƒ½æºç±»å‹',
                keywords: {
                    new_energy: ['æ–°èƒ½æº', 'ç”µåŠ¨', 'çº¯ç”µ', 'å¢ç¨‹'],
                    fuel: ['ç‡ƒæ²¹', 'æ±½æ²¹', 'æŸ´æ²¹'],
                    hybrid: ['æ··åŠ¨', 'æ··åˆåŠ¨åŠ›'],
                },
                labels: {
                    new_energy: 'æ–°èƒ½æº',
                    fuel: 'ç‡ƒæ²¹',
                    hybrid: 'æ··åŠ¨',
                }
            },
            L: {
                name: 'å“ç‰Œåå¥½',
                keywords: {
                    ideal: ['ç†æƒ³', 'L6', 'L7', 'L8', 'L9', 'MEGA'],
                    comparing: ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'è¿˜åœ¨çœ‹', 'è”šæ¥', 'å°é¹', 'é—®ç•Œ', 'ç‰¹æ–¯æ‹‰'],
                },
                labels: {
                    ideal: 'ç†æƒ³',
                    comparing: 'å¯¹æ¯”ä¸­',
                }
            },
            N: {
                name: 'è´­ä¹°æ—¶æœº',
                keywords: {
                    immediate: ['ç«‹å³', 'é©¬ä¸Š', 'è¿™å‘¨', 'æœ¬å‘¨', 'ä»Šå¤©', 'ç°åœ¨å°±ä¹°'],
                    within_month: ['ä¸€ä¸ªæœˆ', '1ä¸ªæœˆ', 'æœˆå†…', 'è¿‘æœŸ'],
                    within_3months: ['ä¸‰ä¸ªæœˆ', '3ä¸ªæœˆ', 'å­£åº¦å†…'],
                    wait_and_see: ['è§‚æœ›', 'å†çœ‹çœ‹', 'ä¸æ€¥', 'ç­‰ç­‰'],
                },
                labels: {
                    immediate: 'ç«‹å³',
                    within_month: '1æœˆå†…',
                    within_3months: '3æœˆå†…',
                    wait_and_see: 'è§‚æœ›',
                }
            }
        };

        // ========== æ•°æ®æŒä¹…åŒ–åŠŸèƒ½ ==========

        // ä¿å­˜åˆ†æå†å²
        function saveAnalysisHistory(input, result) {
            try {
                let history = JSON.parse(localStorage.getItem('analysisHistory') || '[]');

                const item = {
                    id: Date.now(),
                    timestamp: new Date().toISOString(),
                    input: input.substring(0, 200), // åªä¿å­˜å‰200å­—ç¬¦ä½œä¸ºæ‘˜è¦
                    customerName: extractCustomerName(input),
                    result: result
                };

                history.unshift(item); // æ·»åŠ åˆ°å¼€å¤´

                // åªä¿ç•™æœ€è¿‘10æ¡
                if (history.length > MAX_HISTORY_ITEMS) {
                    history = history.slice(0, MAX_HISTORY_ITEMS);
                }

                localStorage.setItem('analysisHistory', JSON.stringify(history));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // æå–å®¢æˆ·å§“åï¼ˆç®€å•æå–ï¼‰
        function extractCustomerName(text) {
            // å°è¯•åŒ¹é… "å®¢æˆ·æ˜¯XXX" "å®¢æˆ·ï¼šXXX" ç­‰æ¨¡å¼
            const patterns = [
                /å®¢æˆ·[æ˜¯ï¼š]\s*([^\sï¼Œã€‚,]+)/,
                /å®¢æˆ·å§“å[æ˜¯ï¼š]\s*([^\sï¼Œã€‚,]+)/,
                /å§“å[æ˜¯ï¼š]\s*([^\sï¼Œã€‚,]+)/
            ];

            for (const pattern of patterns) {
                const match = text.match(pattern);
                if (match) return match[1];
            }

            return 'æœªå‘½åå®¢æˆ·';
        }

        // åŠ è½½åˆ†æå†å²
        function loadAnalysisHistory() {
            try {
                return JSON.parse(localStorage.getItem('analysisHistory') || '[]');
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                return [];
            }
        }

        // æ˜¾ç¤ºå†å²è®°å½•åˆ—è¡¨
        function showHistoryList() {
            const history = loadAnalysisHistory();

            if (history.length === 0) {
                alert('æš‚æ— å†å²è®°å½•');
                return;
            }

            let html = '<div style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 9999; display: flex; align-items: center; justify-content: center; padding: 20px;" onclick="this.remove()">';
            html += '<div style="background: white; border-radius: 16px; max-width: 800px; width: 100%; max-height: 80vh; overflow: auto; padding: 24px;" onclick="event.stopPropagation()">';
            html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #f0f0f0; padding-bottom: 15px;">';
            html += '<h2 style="font-size: 20px; color: #333; margin: 0;">ğŸ“‹ åˆ†æå†å²è®°å½•</h2>';
            html += '<div>';
            html += '<button onclick="clearHistory()" style="padding: 8px 16px; background: #ff6b6b; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">æ¸…ç©ºå†å²</button>';
            html += '<button onclick="this.closest(\'div[style*=fixed]\').remove()" style="padding: 8px 16px; background: #f0f0f0; color: #666; border: none; border-radius: 8px; cursor: pointer;">å…³é—­</button>';
            html += '</div>';
            html += '</div>';

            history.forEach((item, index) => {
                const date = new Date(item.timestamp);
                const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥ ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;

                html += '<div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 12px; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background=\'#e8e9ea\'" onmouseout="this.style.background=\'#f8f9fa\'" onclick="loadHistoryItem(' + item.id + ')">';
                html += '<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">';
                html += `<div style="font-size: 15px; font-weight: 600; color: #333;">ğŸ‘¤ ${item.customerName}</div>`;
                html += `<div style="font-size: 12px; color: #999;">${dateStr}</div>`;
                html += '</div>';
                html += `<div style="font-size: 13px; color: #666; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${item.input}</div>`;
                html += '</div>';
            });

            html += '</div></div>';

            document.body.insertAdjacentHTML('beforeend', html);
        }

        // åŠ è½½å†å²è®°å½•é¡¹
        function loadHistoryItem(id) {
            const history = loadAnalysisHistory();
            const item = history.find(h => h.id === id);

            if (!item) {
                alert('å†å²è®°å½•ä¸å­˜åœ¨');
                return;
            }

            // å…³é—­å¼¹çª—
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) modal.remove();

            // æ¢å¤è¾“å…¥å†…å®¹
            document.getElementById('customerInput').value = item.input;

            // æ˜¾ç¤ºåˆ†æç»“æœ
            currentAnalysisResult = item.result;
            displayResult(item.result.celn, item.result.nineQuestions, item.result.keywords, item.result.scripts);

            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸…ç©ºå†å²è®°å½•
        function clearHistory() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                localStorage.removeItem('analysisHistory');
                alert('å†å²è®°å½•å·²æ¸…ç©º');
                const modal = document.querySelector('div[style*="position: fixed"]');
                if (modal) modal.remove();
            }
        }

        // ä¿å­˜åº—é•¿æ•°æ®
        function saveManagerData(data) {
            try {
                localStorage.setItem('managerData', JSON.stringify({
                    timestamp: new Date().toISOString(),
                    data: data
                }));
            } catch (e) {
                console.error('ä¿å­˜åº—é•¿æ•°æ®å¤±è´¥:', e);
            }
        }

        // åŠ è½½åº—é•¿æ•°æ®
        function loadManagerData() {
            try {
                const saved = localStorage.getItem('managerData');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return parsed.data;
                }
            } catch (e) {
                console.error('åŠ è½½åº—é•¿æ•°æ®å¤±è´¥:', e);
            }
            return null;
        }

        // é¡µé¢åŠ è½½æ—¶æ¢å¤åº—é•¿æ•°æ®
        window.addEventListener('DOMContentLoaded', function() {
            const savedData = loadManagerData();
            if (savedData) {
                managerData = savedData;
                filteredData = savedData; // åˆå§‹åŒ–ç­›é€‰æ•°æ®
                displayManagerAnalysis(managerData);
            }
        });

        // ========== ä¸€é”®å¤åˆ¶åŠŸèƒ½ ==========

        // å¤åˆ¶è¯æœ¯åˆ°å‰ªè´´æ¿
        function copyScript(text, btnId) {
            const btn = document.getElementById(btnId);

            // ä½¿ç”¨ç°ä»£ Clipboard API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => {
                    showCopySuccess(btn);
                }).catch(() => {
                    fallbackCopy(text, btn);
                });
            } else {
                fallbackCopy(text, btn);
            }
        }

        // å¤‡ç”¨å¤åˆ¶æ–¹æ³•ï¼ˆå…¼å®¹æ—§æµè§ˆå™¨ï¼‰
        function fallbackCopy(text, btn) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();

            try {
                document.execCommand('copy');
                showCopySuccess(btn);
            } catch (err) {
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            }

            document.body.removeChild(textarea);
        }

        // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
        function showCopySuccess(btn) {
            const originalText = btn.textContent;
            btn.textContent = 'âœ“ å·²å¤åˆ¶';
            btn.classList.add('copied');

            setTimeout(() => {
                btn.textContent = originalText;
                btn.classList.remove('copied');
            }, 2000);
        }

        // ========== å¿«é€Ÿæœç´¢å’Œç­›é€‰åŠŸèƒ½ ==========

        // åº”ç”¨ç­›é€‰æ¡ä»¶
        function applyFilters() {
            if (!managerData) return;

            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const levelFilter = document.getElementById('levelFilter').value;
            const completionFilter = document.getElementById('completionFilter').value;

            // ç­›é€‰ä¸“å®¶æ•°æ®
            const filteredExpertGroups = {};

            Object.entries(managerData.expertGroups).forEach(([expertName, customers]) => {
                // å…ˆç­›é€‰ä¸“å®¶åç§°
                if (searchTerm && !expertName.toLowerCase().includes(searchTerm)) {
                    // å¦‚æœä¸“å®¶åç§°ä¸åŒ¹é…ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å®¢æˆ·åŒ¹é…
                    const matchingCustomers = customers.filter(c =>
                        c.customer.toLowerCase().includes(searchTerm)
                    );

                    if (matchingCustomers.length === 0) {
                        return; // è·³è¿‡è¿™ä¸ªä¸“å®¶
                    }
                }

                // ç­›é€‰è¯¥ä¸“å®¶çš„å®¢æˆ·
                const filteredCustomers = customers.filter(customer => {
                    // æœç´¢è¯ç­›é€‰
                    if (searchTerm) {
                        const matchCustomerName = customer.customer.toLowerCase().includes(searchTerm);
                        const matchExpertName = expertName.toLowerCase().includes(searchTerm);
                        if (!matchCustomerName && !matchExpertName) {
                            return false;
                        }
                    }

                    // å•†æœºç­‰çº§ç­›é€‰
                    if (levelFilter && customer.level !== levelFilter) {
                        return false;
                    }

                    // æ¢éœ€å®Œæˆåº¦ç­›é€‰
                    if (completionFilter) {
                        const rate = customer.completionRate;
                        if (completionFilter === 'high' && rate < 70) return false;
                        if (completionFilter === 'medium' && (rate < 40 || rate >= 70)) return false;
                        if (completionFilter === 'low' && rate >= 40) return false;
                    }

                    return true;
                });

                if (filteredCustomers.length > 0) {
                    filteredExpertGroups[expertName] = filteredCustomers;
                }
            });

            // æ›´æ–°ç­›é€‰åçš„æ•°æ®
            filteredData = {
                customers: Object.values(filteredExpertGroups).flat(),
                expertGroups: filteredExpertGroups
            };

            // é‡æ–°æ˜¾ç¤º
            displayManagerAnalysis(filteredData, true);
        }

        // é‡ç½®ç­›é€‰æ¡ä»¶
        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('levelFilter').value = '';
            document.getElementById('completionFilter').value = '';

            if (managerData) {
                filteredData = managerData;
                displayManagerAnalysis(managerData);
            }
        }

        // ========== ä¸“å®¶è§†å›¾åŠŸèƒ½ ==========

        // å¡«å……ç¤ºä¾‹æ•°æ®
        function fillExample() {
            document.getElementById('customerInput').value =
`å®¢æˆ·æ˜¯ä¸€ä½30å²çš„ç”·æ€§ï¼Œç›®å‰åœ¨ä¸€å®¶äº’è”ç½‘å…¬å¸æ‹…ä»»äº§å“ç»ç†ã€‚ä»–æƒ³ä¹°ä¸€è¾†æ–°èƒ½æºSUVï¼Œé¢„ç®—åœ¨30-35ä¸‡ä¹‹é—´ï¼Œä¸»è¦ç”¨äºå®¶åº­å‡ºè¡Œå’Œå‘¨æœ«å¸¦å­©å­å»éƒŠæ¸¸ã€‚

å†³ç­–äººæ˜¯ä»–æœ¬äººï¼Œä½†éœ€è¦å’Œå¦»å­å•†é‡ã€‚ä»–ç›®å‰åœ¨å¯¹æ¯”ç†æƒ³L7å’Œè”šæ¥ES6è¿™ä¸¤æ¬¾è½¦å‹ï¼Œè®¡åˆ’åœ¨3ä¸ªæœˆå†…å®Œæˆè´­ä¹°ã€‚

ä»–æ¯”è¾ƒå…³æ³¨çš„æ˜¯ç»­èˆªé‡Œç¨‹å’Œæ™ºèƒ½é©¾é©¶åŠŸèƒ½ï¼Œæ‹…å¿ƒæ–°èƒ½æºè½¦åœ¨å†¬å¤©ç»­èˆªä¼šå¤§å¹…ç¼©æ°´ï¼ŒåŒæ—¶ä¹Ÿå…³å¿ƒå……ç”µä¾¿åˆ©æ€§ã€‚

ä»–ä½åœ¨æœé˜³åŒºï¼Œä¹‹å‰åœ¨ä¸‰é‡Œå±¯å’Œæœ›äº¬çš„ç†æƒ³é—¨åº—éƒ½çœ‹è¿‡è½¦ã€‚æ²Ÿé€šè®°å½•ï¼š1.24ç”µè¯æ²Ÿé€šã€1.17åˆ°åº—è¯•é©¾ã€1.10é¦–æ¬¡æ¥è§¦ã€‚ä»–ä¸»è¦é¡¾è™‘è¿˜æ˜¯åœ¨ç«å“å¯¹æ¯”ä¸Šï¼Œå¯¹é‡‘èæ”¿ç­–æ¯”è¾ƒæ•æ„Ÿï¼Œæƒ³äº†è§£ä½æ¯è´·æ¬¾æ–¹æ¡ˆï¼Œæ‰‹ä¸Šæœ‰ä¸€è¾†å®é©¬3ç³»æƒ³ç½®æ¢ã€‚`;
        }

        // åˆ†æCELN
        function analyzeCELN(text) {
            return {
                C: analyzeIntention(text),
                E: analyzeEnergyType(text),
                L: analyzeBrandPreference(text),
                N: analyzeTiming(text)
            };
        }

        function analyzeIntention(text) {
            const config = CELN_CONFIG.C.keywords;
            for (const keyword of config.high) {
                if (text.includes(keyword)) return 'high';
            }
            for (const keyword of config.medium) {
                if (text.includes(keyword)) return 'medium';
            }
            for (const keyword of config.low) {
                if (text.includes(keyword)) return 'low';
            }
            return 'medium';
        }

        function analyzeEnergyType(text) {
            const config = CELN_CONFIG.E.keywords;
            for (const keyword of config.new_energy) {
                if (text.includes(keyword)) return 'new_energy';
            }
            for (const keyword of config.fuel) {
                if (text.includes(keyword)) return 'fuel';
            }
            for (const keyword of config.hybrid) {
                if (text.includes(keyword)) return 'hybrid';
            }
            return 'new_energy';
        }

        function analyzeBrandPreference(text) {
            const config = CELN_CONFIG.L.keywords;
            let hasIdeal = false;
            let hasComparing = false;

            for (const keyword of config.ideal) {
                if (text.includes(keyword)) hasIdeal = true;
            }
            for (const keyword of config.comparing) {
                if (text.includes(keyword)) hasComparing = true;
            }

            if (hasIdeal && hasComparing) return 'comparing';
            if (hasIdeal) return 'ideal';
            return 'comparing';
        }

        function analyzeTiming(text) {
            const config = CELN_CONFIG.N.keywords;
            for (const keyword of config.immediate) {
                if (text.includes(keyword)) return 'immediate';
            }
            for (const keyword of config.within_month) {
                if (text.includes(keyword)) return 'within_month';
            }
            for (const keyword of config.within_3months) {
                if (text.includes(keyword)) return 'within_3months';
            }
            for (const keyword of config.wait_and_see) {
                if (text.includes(keyword)) return 'wait_and_see';
            }
            return 'within_3months';
        }

        // åˆ†ææ¢éœ€ä¹é—®
        function analyzeNineQuestions(text) {
            return NINE_QUESTIONS.map(q => {
                const result = q.extract(text);
                return {
                    ...q,
                    ...result
                };
            });
        }

        // æå–å…³é”®è¯ï¼ˆæ¢éœ€ä¹é—®æœªä½“ç°çš„ä¿¡æ¯ï¼‰
        function extractKeywords(text) {
            const keywords = {};

            // ç”¨è½¦ç”¨é€”
            const purposes = ['å®¶åº­', 'å•†åŠ¡', 'é€šå‹¤', 'ä¸Šä¸‹ç­', 'æ—…æ¸¸', 'éƒŠæ¸¸', 'æ¥é€å­©å­', 'ä»£æ­¥'];
            keywords.purpose = purposes.filter(p => text.includes(p));

            // ä½¿ç”¨æ–°çš„æ™ºèƒ½è½¦å‹è¯†åˆ«ï¼ˆåŒºåˆ†æ„å‘/ç«å“/ç½®æ¢ï¼‰
            const vehiclesContext = extractVehiclesWithContext(text);

            // æ„å‘è½¦å‹ï¼ˆä»…ç†æƒ³å“ç‰Œï¼‰
            keywords.models = vehiclesContext.ideal;

            // ç«å“è½¦å‹ï¼ˆå¸¦å“ç‰Œï¼‰
            keywords.competitors = vehiclesContext.competitors;

            // ç½®æ¢è½¦å‹ä¿¡æ¯
            if (vehiclesContext.tradeIn) {
                keywords.hasTradeIn = true;
                keywords.tradeInInfo = vehiclesContext.tradeIn;
            } else {
                // å¦‚æœæ²¡æœ‰é€šè¿‡è½¦å‹è¯†åˆ«åˆ°ç½®æ¢ï¼Œç»§ç»­ç”¨å…³é”®è¯åˆ¤æ–­
                if (text.includes('ç½®æ¢') || text.includes('æ—§è½¦') || text.includes('å–è½¦') || text.includes('ä»¥æ—§æ¢æ–°') ||
                    text.includes('ç°åœ¨æœ‰') || text.includes('ç›®å‰å¼€') || text.includes('æ‰‹ä¸Šæœ‰')) {
                    keywords.hasTradeIn = true;
                    // å°è¯•æå–æ—§è½¦å“ç‰Œ
                    const carBrands = ['å¥”é©°', 'å®é©¬', 'BMW', 'å¥¥è¿ª', 'ç‰¹æ–¯æ‹‰', 'è”šæ¥', 'å°é¹', 'ç†æƒ³', 'æ¯”äºšè¿ª', 'è…¾åŠ¿', 'ææ°ª', 'é—®ç•Œ', 'ä¸°ç”°', 'æœ¬ç”°', 'å¤§ä¼—', 'åˆ«å…‹'];
                    const foundBrand = carBrands.find(brand => text.includes(brand));
                    keywords.tradeInInfo = foundBrand || 'æœªçŸ¥';
                } else {
                    keywords.hasTradeIn = false;
                }
            }

            // è·Ÿè¿›æ¬¡æ•°ï¼ˆä½¿ç”¨æ—¥æœŸæå–ï¼‰
            const dates = extractDates(text);
            keywords.followUpCount = dates.length;

            // é¡¾è™‘ç±»åˆ«
            const concernCategories = {
                'ç«å“': 'competitor',
                'å¯¹æ¯”': 'competitor',
                'äº¤ä»˜': 'delivery',
                'å‘¨æœŸ': 'delivery',
                'èˆ†è®º': 'public_opinion',
                'å£ç¢‘': 'public_opinion',
                'å“ç‰Œ': 'brand',
                'ä»·æ ¼': 'price',
                'å“è´¨': 'quality',
                'è´¨é‡': 'quality'
            };

            for (const [key, value] of Object.entries(concernCategories)) {
                if (text.includes(key)) {
                    keywords.concernCategory = value;
                    break;
                }
            }

            return keywords;
        }

        // ç”Ÿæˆæ™ºèƒ½è¯æœ¯ï¼ˆ1-2ä¸ªï¼šç¬¬ä¸€ä¸ªæ ¹æ®è·Ÿè¿›æ¬¡æ•°ï¼Œç¬¬äºŒä¸ªæ™ºèƒ½åˆ¤æ–­ï¼‰
        function generateImprovedScripts(celn, nineQuestions, keywords) {
            const scripts = [];
            const followUpCount = keywords.followUpCount || 0;

            // ====== ç¬¬ä¸€ä¸ªè¯æœ¯ï¼šæ ¹æ®è·Ÿè¿›æ¬¡æ•°ï¼ˆå›ºå®šé€»è¾‘ï¼‰======

            if (followUpCount === 0) {
                // é¦–æ¬¡æ¥è§¦ï¼šå»ºç«‹ä¿¡ä»» + äº†è§£éœ€æ±‚
                scripts.push({
                    type: 'greeting',
                    title: 'ğŸ‘‹ é¦–æ¬¡æ¥è§¦è¯æœ¯',
                    content: `æ‚¨å¥½å‘€ï¼æˆ‘æ˜¯ç†æƒ³æ±½è½¦çš„ä¸“å±é¡¾é—®ã€‚${keywords.models && keywords.models.length > 0 ? 'çœ‹æ‚¨å¯¹' + keywords.models.join('ã€') + 'æŒºæ„Ÿå…´è¶£çš„' : 'çœ‹åˆ°æ‚¨å…³æ³¨å’±ä»¬ç†æƒ³'}ï¼Œ${keywords.purpose && keywords.purpose.length > 0 ? 'å¹³æ—¶ä¸»è¦' + keywords.purpose.join('ã€') + 'ç”¨è½¦å¯¹å§' : 'æƒ³äº†è§£ä¸€ä¸‹æ‚¨å¹³æ—¶ä¸»è¦ä»€ä¹ˆåœºæ™¯ç”¨è½¦å‘¢'}ï¼Ÿå’±ä»¬å…ˆèŠèŠæ‚¨çš„ç”¨è½¦éœ€æ±‚ï¼Œæˆ‘å¥½ç»™æ‚¨æ¨èæœ€åˆé€‚çš„è½¦å‹é…ç½®ã€‚`,
                    stage: 'é¦–æ¬¡æ¥è§¦'
                });
            } else if (followUpCount >= 1 && followUpCount <= 2) {
                // è·Ÿè¿›1-2æ¬¡ï¼šåˆ¤æ–­æ˜¯å¦å·²è¯•é©¾
                const hasTestDrive = nineQuestions.some(q =>
                    q.id === 'current_car' && q.answer && q.answer.includes('è¯•é©¾')
                ) || (keywords.visitedStores && keywords.visitedStores.length > 0);

                if (hasTestDrive) {
                    // å·²è¯•é©¾è¿‡ â†’ è°ˆå•
                    scripts.push({
                        type: 'closing',
                        title: 'ğŸ¯ è¯•é©¾åè·Ÿè¿›',
                        content: `æ‚¨å¥½ï¼${keywords.visitedStores && keywords.visitedStores.length > 0 ? keywords.visitedStores[0] + 'é—¨åº—' : 'ä¸Šæ¬¡'}è¯•é©¾çš„æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿæœ‰ä»€ä¹ˆç–‘é—®å’±ä»¬å¯ä»¥ç»†èŠã€‚\n\nè·Ÿæ‚¨è¯´ä¸ªå¥½æ¶ˆæ¯ï¼Œå’±ä»¬è¿™è¾¹æœ€è¿‘æœ‰äº›ä¸é”™çš„è´­è½¦æƒç›Šï¼š\n${keywords.financeSensitivity === 'æ•æ„Ÿ' ? 'â€¢ é‡‘èæ–¹æ¡ˆç‰¹åˆ«ç»™åŠ›ï¼Œä½æ¯ç”šè‡³0æ¯éƒ½æœ‰ï¼Œèƒ½çœä¸å°‘åˆ©æ¯é’±\n' : ''}${keywords.hasTradeIn ? 'â€¢ æ‚¨é‚£è¾†' + keywords.tradeInInfo + 'å¯ä»¥ç½®æ¢ï¼Œè¿˜æœ‰é¢å¤–è¡¥è´´ï¼Œèƒ½æŠµä¸å°‘è½¦æ¬¾\n' : ''}â€¢ ç°åœ¨ä¸‹å•è¿˜æœ‰ç§¯åˆ†ç¤¼åŒ…ã€å……ç”µæ¡©å®‰è£…è¡¥è´´è¿™äº›\n\nè¿™äº›æƒç›Šéƒ½æ˜¯é™æ—¶çš„å“ˆï¼Œæ‚¨è¦æ˜¯è¿‘æœŸèƒ½å®šä¸‹æ¥ï¼Œæ­£å¥½éƒ½èƒ½äº«å—åˆ°ã€‚æ‚¨ç°åœ¨ä¸»è¦è¿˜æœ‰ä»€ä¹ˆé¡¾è™‘å—ï¼Ÿå’±ä»¬ä¸€èµ·çœ‹çœ‹èƒ½ä¸èƒ½è§£å†³~`,
                        stage: 'è¯•é©¾åè°ˆå•'
                    });
                } else {
                    // æœªè¯•é©¾ â†’ é‚€çº¦è¯•é©¾
                    scripts.push({
                        type: 'test_drive',
                        title: 'ğŸš— è¯•é©¾é‚€çº¦',
                        content: `${keywords.visitedStores && keywords.visitedStores.length > 0 ? keywords.visitedStores.join('ã€') + 'é‚£è¾¹æ‚¨ä¹‹å‰å»çœ‹è¿‡äº†å¯¹å§ï¼Ÿ' : ''}å’±ä»¬ä¹‹å‰èŠè¿‡æ‚¨${keywords.purpose && keywords.purpose.length > 0 ? 'ä¸»è¦' + keywords.purpose.join('ã€') + 'ç”¨è½¦' : 'çš„åŸºæœ¬éœ€æ±‚'}ï¼Œé…ç½®å‚æ•°ç½‘ä¸Šéƒ½èƒ½æŸ¥åˆ°ï¼Œä½†${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬è¿™è½¦'}çœŸæ­£çš„é©¾é©¶æ„Ÿå—ã€ä¹˜åèˆ’é€‚åº¦ï¼Œè¿˜å¾—æ‚¨äº²è‡ªä¸Šè½¦ä½“éªŒä¸€ä¸‹æ‰çŸ¥é“ã€‚\n\nç‰¹åˆ«æ˜¯æ™ºèƒ½é©¾é©¶ã€é™è°§æ€§ã€åŠ é€Ÿè¿™äº›ï¼Œåœ¨è·¯ä¸Šè·‘ä¸€åœˆæ‚¨å°±èƒ½æ˜æ˜¾æ„Ÿå—åˆ°å’Œä¼ ç»Ÿè½¦çš„å·®åˆ«ã€‚æˆ‘å¸®æ‚¨çº¦ä¸ªè¯•é©¾å§ï¼Œå¤§æ¦‚ä¸€å°æ—¶å·¦å³ï¼Œå¸‚åŒºé“è·¯å’Œé«˜é€Ÿéƒ½èƒ½ä½“éªŒåˆ°ã€‚æ‚¨çœ‹è¿™å‘¨æœ«å“ªå¤©æœ‰ç©ºï¼Ÿ`,
                        stage: 'è¯•é©¾é‚€çº¦'
                    });
                }
            } else if (followUpCount >= 3) {
                // è·Ÿè¿›3æ¬¡ä»¥ä¸Šï¼šè°ˆå•é˜¶æ®µ
                scripts.push({
                    type: 'closing',
                    title: 'ğŸ¯ è°ˆå•ä¿ƒæˆ',
                    content: `å“¥/å§ï¼Œå’±ä»¬èŠäº†å‡ æ¬¡äº†ï¼Œæ„Ÿè§‰æ‚¨å¯¹${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬çš„è½¦'}è¿˜æ˜¯æŒºè®¤å¯çš„ã€‚è·Ÿæ‚¨è¯´ä¸ªå¥½æ¶ˆæ¯ï¼Œè¿™è¾¹æœ€è¿‘æœ‰äº›æŒºä¸é”™çš„è´­è½¦æƒç›Šæ”¿ç­–ï¼š\n\nã€ä»¥ä¸‹éœ€æ ¹æ®æœ€æ–°å®˜æ–¹æ”¿ç­–å¡«å†™ã€‘\nâ€¢ é™æ—¶è´­è½¦ç¤¼åŒ…ï¼šç§¯åˆ†ã€å……ç”µæ¡©å®‰è£…è¡¥è´´ã€ä¿é™©ä¼˜æƒ ç­‰\n${keywords.financeSensitivity === 'æ•æ„Ÿ' ? 'â€¢ é‡‘èæ–¹æ¡ˆï¼šä½æ¯/0æ¯æ–¹æ¡ˆå¯é€‰ï¼Œèƒ½å¸®æ‚¨çœä¸å°‘åˆ©æ¯\n' : ''}${keywords.hasTradeIn ? 'â€¢ ç½®æ¢è¡¥è´´ï¼šæ‚¨é‚£è¾†' + keywords.tradeInInfo + 'ç½®æ¢çš„è¯ï¼Œæœ‰é¢å¤–è¡¥è´´ï¼Œèƒ½æŠµä¸€éƒ¨åˆ†è½¦æ¬¾\n' : ''}\nè¿™äº›æƒç›Šéƒ½æ˜¯æœ‰æ—¶æ•ˆçš„å“ˆï¼Œæ‚¨è¦æ˜¯è¿‘æœŸèƒ½å®šä¸‹æ¥ï¼Œæ­£å¥½éƒ½èƒ½é”å®šã€‚æ‚¨ç°åœ¨ä¸»è¦è¿˜æœ‰ä»€ä¹ˆé¡¾è™‘å—ï¼Ÿå’±ä»¬ä¸€èµ·çœ‹çœ‹~`,
                    stage: 'è°ˆå•ä¿ƒæˆ'
                });
            }

            // ====== ç¬¬äºŒä¸ªè¯æœ¯ï¼šæ™ºèƒ½åˆ¤æ–­ï¼ˆç§è‰/æ¢éœ€/è§£ç­”é¡¾è™‘ï¼‰======

            // è®¡ç®—å®¢æˆ·ä¿¡æ¯ä¸°å¯Œåº¦
            const completeCount = nineQuestions.filter(q => q.status === 'complete').length;
            const incompleteCount = nineQuestions.filter(q => q.status === 'incomplete').length;
            const infoRichness = completeCount / 9; // 0-1ä¹‹é—´ï¼Œä¿¡æ¯ä¸°å¯Œåº¦

            // åˆ¤æ–­æ˜¯å¦ä¿¡æ¯è¾ƒå°‘ï¼ˆä¸°å¯Œåº¦<40%ï¼‰
            if (infoRichness < 0.4) {
                // ä¿¡æ¯å°‘ â†’ æœ¬å“ç§è‰ + æ¢éœ€å¼•å¯¼
                generateSeedingAndProbing(scripts, nineQuestions, keywords);
                return scripts;
            }

            // ä¿¡æ¯è¶³å¤Ÿï¼Œåˆ¤æ–­æ˜¯å¦æœ‰æ˜ç¡®é¡¾è™‘
            // ä¼˜å…ˆçº§1ï¼šå®¶åº­å†³ç­–é¡¾è™‘
            const decisionProbe = nineQuestions.find(q => q.id === 'decision_maker');
            if (decisionProbe && decisionProbe.answer && (decisionProbe.answer.includes('å•†é‡') || decisionProbe.answer.includes('å®¶åº­'))) {
                scripts.push({
                    type: 'family_decision',
                    title: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­å†³ç­–å»ºè®®',
                    content: `æ„Ÿè§‰æ‚¨æŒºé‡è§†å®¶äººçš„æƒ³æ³•å“ˆï¼Œè¿™ä¸ªæŒºå¥½çš„ï¼Œæ¯•ç«Ÿä¹°è½¦æ˜¯å®¶é‡Œçš„å¤§äº‹å„¿ã€‚æˆ‘å»ºè®®æ‚¨è¯•é©¾çš„æ—¶å€™æŠŠçˆ±äºº${decisionProbe.answer.includes('çˆ¶æ¯') || decisionProbe.answer.includes('è€äºº') ? 'è¿˜æœ‰çˆ¶æ¯' : ''}ä¹Ÿä¸€èµ·å¸¦è¿‡æ¥ä½“éªŒä¸€ä¸‹ã€‚\n\n${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬è¿™è½¦'}${keywords.purpose && keywords.purpose.includes('å®¶åº­') ? 'çš„ç¬¬äºŒæ’ã€ç¬¬ä¸‰æ’ç©ºé—´å’Œèˆ’é€‚åº¦' : 'çš„æ•´ä½“ä¹˜åèˆ’é€‚æ€§'}ï¼Œå®¶äººå®é™…åè¿›å»æ„Ÿå—ä¸€ä¸‹ï¼Œæ¯”æ‚¨ä¸€ä¸ªäººçœ‹å¼ºå¤ªå¤šäº†ã€‚è€Œä¸”é—¨åº—æœ‰ä¸“é—¨çš„å®¶åº­ä½“éªŒåŒºï¼Œå°æœ‹å‹ä¹Ÿæœ‰åœ°æ–¹ç©ï¼Œä¸ä¼šè§‰å¾—æ— èŠã€‚è®©å®¶äººäº²è‡ªä½“éªŒä¸€ä¸‹ï¼Œä»–ä»¬è‚¯å®šä¹Ÿä¼šå–œæ¬¢çš„~`,
                    stage: 'å®¶åº­å†³ç­–å»ºè®®'
                });
                return scripts;
            }

            // ä¼˜å…ˆçº§2ï¼šç«å“å¯¹æ¯”é¡¾è™‘
            const competitorProbe = nineQuestions.find(q => q.id === 'competitor_comparison');
            if (competitorProbe && competitorProbe.status !== 'incomplete' && competitorProbe.answer && competitorProbe.answer !== 'æ¢éœ€ä¸åˆ°ä½') {
                const competitorAnswer = competitorProbe.answer;
                generateCompetitorScript(scripts, competitorAnswer, keywords);
                return scripts;
            }

            // ä¼˜å…ˆçº§3ï¼šå…·ä½“æ€§èƒ½é¡¾è™‘
            if (keywords.concerns && keywords.concerns.length > 0) {
                generateConcernScript(scripts, keywords);
                return scripts;
            }

            // ä¼˜å…ˆçº§4ï¼šé‡‘èæ•æ„Ÿåº¦
            if (keywords.financeSensitivity === 'æ•æ„Ÿ') {
                scripts.push({
                    type: 'finance',
                    title: 'ğŸ’³ é‡‘èæ–¹æ¡ˆæ¨è',
                    content: `çœ‹æ‚¨å¯¹é‡‘èæ–¹æ¡ˆæ¯”è¾ƒå…³æ³¨å“ˆï¼Œå’±ä»¬è¿™è¾¹æœ‰å¥½å‡ ç§æ–¹æ¡ˆå¯ä»¥é€‰ï¼š\n\nã€ä»¥ä¸‹éœ€æ ¹æ®æœ€æ–°å®˜æ–¹é‡‘èæ”¿ç­–å¡«å†™ã€‘\nâ€¢ ä½é¦–ä»˜æ–¹æ¡ˆï¼ˆ15%èµ·ï¼‰ï¼šæ‰‹å¤´èµ„é‡‘å¯ä»¥çµæ´»è°ƒé…\nâ€¢ 0æ¯/ä½æ¯æ–¹æ¡ˆï¼šèƒ½çœä¸‹æ¥ä¸å°‘åˆ©æ¯é’±\nâ€¢ å¼¹æ€§å°¾æ¬¾æ–¹æ¡ˆï¼šæœˆä¾›å‹åŠ›å°ï¼Œåˆ°æœŸå¯ä»¥é€‰æ‹©ç»­è´·æˆ–è€…ä»˜æ¸…\n\n${nineQuestions.find(q => q.id === 'budget')?.answer ? 'æŒ‰æ‚¨' + nineQuestions.find(q => q.id === 'budget').answer.replace('ï¼ˆæ˜ç¡®ï¼‰', '').replace('ï¼ˆæ ¹æ®å¯¹æ¯”è½¦å‹æ¨æ–­ï¼‰', '') + 'çš„é¢„ç®—' : 'æ ¹æ®æ‚¨çš„æƒ…å†µ'}ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨è¯¦ç»†ç®—ä¸€ä¸‹æ¯ä¸ªæ–¹æ¡ˆçš„æœˆä¾›å’Œæ€»æˆæœ¬ï¼Œæ‚¨çœ‹å“ªç§æ›´åˆé€‚ï¼Ÿ`,
                    stage: 'é‡‘èæ–¹æ¡ˆæ¨è'
                });
                return scripts;
            }

            // ä¼˜å…ˆçº§5ï¼šç½®æ¢éœ€æ±‚
            if (keywords.hasTradeIn) {
                scripts.push({
                    type: 'trade_in',
                    title: 'ğŸ”„ ç½®æ¢æ–¹æ¡ˆæ¨è',
                    content: `æ‚¨é‚£è¾†${keywords.tradeInInfo}æ­£å¥½å¯ä»¥ç½®æ¢å‘€ï¼Œè¿™æ ·èƒ½æŠµä¸€éƒ¨åˆ†è½¦æ¬¾ï¼Œè¿˜èƒ½äº«å—é¢å¤–çš„ç½®æ¢è¡¥è´´ã€‚\n\nå’±ä»¬ç½®æ¢æµç¨‹ç‰¹åˆ«ç®€å•ï¼š\n1. è¯„ä¼°å¸ˆå…è´¹ä¸Šé—¨ç»™æ‚¨çš„è½¦ä¼°ä»·\n2. ä»·æ ¼é€æ˜ï¼Œæ‚¨å¯ä»¥æ‹¿å»è·Ÿå¸‚åœºä»·å¯¹æ¯”\n3. ä»·æ ¼æ»¡æ„çš„è¯ï¼Œç›´æ¥æŠµæ‰£æ–°è½¦è½¦æ¬¾\n4. è¿˜æœ‰é¢å¤–çš„ç½®æ¢è¡¥è´´ã€å…·ä½“é‡‘é¢éœ€å’¨è¯¢é—¨åº—ã€‘\n\nè€Œä¸”æ—§è½¦å¯ä»¥ä¸€ç›´å¼€åˆ°æ–°è½¦äº¤ä»˜ï¼Œä¸è€½è¯¯æ‚¨ç”¨è½¦ã€‚è¦ä¸æˆ‘å…ˆå®‰æ’è¯„ä¼°å¸ˆç»™æ‚¨çš„è½¦ä¼°ä¸ªä»·ï¼Ÿ`,
                    stage: 'ç½®æ¢æ–¹æ¡ˆæ¨è'
                });
                return scripts;
            }

            // å¦‚æœæ²¡æœ‰æ˜ç¡®é¡¾è™‘ï¼Œè¿›è¡Œæœ¬å“ç§è‰
            generateSeedingAndProbing(scripts, nineQuestions, keywords);
            return scripts;
        }

        // ç”Ÿæˆæœ¬å“ç§è‰ + æ¢éœ€å¼•å¯¼è¯æœ¯ï¼ˆæ ¹æ®æ„å‘è½¦å‹åŠ¨æ€è°ƒæ•´ï¼‰
        function generateSeedingAndProbing(scripts, nineQuestions, keywords) {
            let seedingContent = '';
            let probingQuestions = [];

            // è·å–å®¢æˆ·æ„å‘è½¦å‹
            const intentionModel = keywords.models && keywords.models.length > 0 ? keywords.models[0] : null;

            // æ ¹æ®æ„å‘è½¦å‹ç”Ÿæˆé’ˆå¯¹æ€§ç§è‰è¯æœ¯
            if (intentionModel) {
                if (intentionModel === 'MEGA') {
                    // MEGAï¼šçº¯ç”µMPVã€èˆ’é€‚ä½“éªŒã€åª²ç¾ç™¾ä¸‡çº§å•†åŠ¡è½¦
                    seedingContent = 'çœ‹æ‚¨å¯¹MEGAæ„Ÿå…´è¶£å“ˆï¼Œè¿™ä¸ªé€‰æ‹©çœŸçš„æŒºæœ‰çœ¼å…‰çš„ã€‚MEGAæ˜¯å’±ä»¬ç†æƒ³é¦–æ¬¾çº¯ç”µMPVï¼Œå®šä½å°±æ˜¯å¯¹æ ‡ç™¾ä¸‡çº§å•†åŠ¡è½¦çš„èˆ’é€‚ä½“éªŒã€‚\n\n800Vé«˜å‹å¿«å……ï¼Œå……ç”µ15åˆ†é’Ÿèƒ½è·‘500å…¬é‡Œï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒç»­èˆªç„¦è™‘ã€‚è€Œä¸”ç©ºé—´è®¾è®¡çœŸçš„æ˜¯ä¸ºå•†åŠ¡å’Œå®¶åº­åœºæ™¯æ·±åº¦ä¼˜åŒ–çš„ï¼Œç¬¬äºŒæ’ã€ç¬¬ä¸‰æ’çš„ä¹˜åèˆ’é€‚åº¦éƒ½ç‰¹åˆ«é«˜ï¼Œé™è°§æ€§æ›´æ˜¯è±ªåè½¦æ°´å‡†ã€‚å¾ˆå¤šè½¦ä¸»éƒ½è¯´ï¼Œå¼€è¿‡MEGAå°±çŸ¥é“ä»€ä¹ˆå«çœŸæ­£çš„ç§»åŠ¨ä¼šå®¢å…ã€‚';
                } else if (intentionModel === 'i6' || intentionModel === 'i8') {
                    // i6/i8ï¼šçº¯ç”µè½¦å‹ã€æ™ºèƒ½é©¾é©¶ã€ç»­èˆªæ€§èƒ½
                    seedingContent = `çœ‹æ‚¨å¯¹${intentionModel}æ„Ÿå…´è¶£å“ˆï¼Œè¿™ä¸ªé€‰æ‹©æŒºæ˜æ™ºçš„ã€‚${intentionModel}æ˜¯å’±ä»¬ç†æƒ³çš„çº¯ç”µSUVï¼Œç»­èˆªè¡¨ç°ç‰¹åˆ«å‡ºè‰²ï¼Œ${intentionModel === 'i8' ? 'é•¿ç»­èˆªç‰ˆèƒ½è·‘600å¤šå…¬é‡Œ' : 'ç»­èˆªè¶…è¿‡500å…¬é‡Œ'}ï¼Œæ—¥å¸¸ç”¨è½¦å®Œå…¨å¤Ÿç”¨ã€‚\n\nè€Œä¸”æ™ºèƒ½é©¾é©¶ä½“éªŒç‰¹åˆ«å¥½ï¼ŒAD Maxç³»ç»Ÿæ˜¯ç›®å‰é‡äº§è½¦é‡Œåšå¾—æœ€å¥½çš„ä¹‹ä¸€ï¼Œé«˜é€ŸNOAå’ŒåŸå¸‚NOAéƒ½å¾ˆæˆç†Ÿã€‚åŠ ä¸Šç©ºé—´èˆ’é€‚åº¦ã€é™è°§æ€§è¿™äº›ï¼Œ${intentionModel}åœ¨çº¯ç”µSUVé‡ŒçœŸçš„æ˜¯ç»¼åˆå®åŠ›å¾ˆå¼ºçš„é€‰æ‹©ã€‚`;
                } else if (['L6', 'L7', 'L8', 'L9'].includes(intentionModel)) {
                    // Lç³»åˆ—ï¼šå¢ç¨‹æŠ€æœ¯ã€6åº§å¸ƒå±€ã€å®¶åº­åœºæ™¯
                    seedingContent = `çœ‹æ‚¨å¯¹${intentionModel}æ„Ÿå…´è¶£å“ˆï¼Œè¿™ä¸ªé€‰æ‹©çœŸçš„æŒºæ˜æ™ºçš„ã€‚${intentionModel}çš„å¢ç¨‹æŠ€æœ¯æ˜¯ä¸šå†…åšå¾—æœ€æˆç†Ÿçš„ï¼Œæ—¥å¸¸é€šå‹¤ç”¨ç”µï¼Œä¸€å…¬é‡Œæ‰å‡ åˆ†é’±ï¼Œé•¿é€”æˆ–è€…æ¥ä¸åŠå……ç”µå°±åŠ æ²¹ï¼Œå®Œå…¨ä¸ç”¨ç„¦è™‘ç»­èˆªã€‚\n\nè€Œä¸”6åº§å¸ƒå±€ç¬¬äºŒæ’æ˜¯ç‹¬ç«‹åº§æ¤…ï¼Œå¸¦è…¿æ‰˜ï¼Œåèµ·æ¥æ¯”å¾ˆå¤šDçº§è½¦éƒ½èˆ’æœã€‚åŠ ä¸Šå†°ç®±ã€å½©ç”µã€å¤§æ²™å‘è¿™äº›é…ç½®ï¼Œé•¿é€”è‡ªé©¾çš„æ—¶å€™å®¶äººèˆ’é€‚åº¦ç‰¹åˆ«é«˜ã€‚å¾ˆå¤šè½¦ä¸»éƒ½è¯´ï¼Œå¼€äº†${intentionModel}å°±å†ä¹Ÿå›ä¸å»çº¯æ²¹è½¦äº†ã€‚`;
                } else {
                    // å…¶ä»–ç†æƒ³è½¦å‹ï¼Œé€šç”¨è¯æœ¯
                    seedingContent = `çœ‹æ‚¨å¯¹${intentionModel}æ„Ÿå…´è¶£å“ˆï¼Œè¿™ä¸ªé€‰æ‹©æŒºä¸é”™çš„ã€‚å’±ä»¬ç†æƒ³è¿™å‡ å¹´åœ¨å®¶åº­ç”¨è½¦åœºæ™¯çœŸçš„æ˜¯åšåˆ°æè‡´äº†ï¼Œç‰¹åˆ«æ˜¯æ™ºèƒ½é©¾é©¶ã€ç©ºé—´èˆ’é€‚åº¦ã€é™è°§æ€§è¿™äº›æ–¹é¢ï¼Œéƒ½æ˜¯ä¸ºç”¨æˆ·æ·±åº¦ä¼˜åŒ–çš„ã€‚`;
                }
            } else {
                // æ²¡æœ‰æ˜ç¡®æ„å‘è½¦å‹ï¼Œæ³›åŒ–ç§è‰ç†æƒ³å“ç‰Œ
                seedingContent = 'çœ‹å¾—å‡ºæ¥æ‚¨å¯¹å’±ä»¬ç†æƒ³è¿˜æ˜¯æŒºæ„Ÿå…´è¶£çš„å“ˆã€‚å’±ä»¬ç†æƒ³è¿™å‡ å¹´åœ¨å®¶åº­ç”¨è½¦åœºæ™¯çœŸçš„æ˜¯åšåˆ°æè‡´äº†ï¼Œä¸ç®¡æ˜¯å¢ç¨‹çš„Lç³»åˆ—ï¼Œè¿˜æ˜¯çº¯ç”µçš„iç³»åˆ—å’ŒMEGAï¼Œéƒ½æ˜¯é’ˆå¯¹ä¸åŒç”¨æˆ·éœ€æ±‚æ·±åº¦ä¼˜åŒ–çš„ã€‚\n\nç‰¹åˆ«æ˜¯æ™ºèƒ½é©¾é©¶ã€ç©ºé—´èˆ’é€‚åº¦ã€é™è°§æ€§è¿™äº›ï¼Œç”¨æˆ·å£ç¢‘ä¸€ç›´ç‰¹åˆ«å¥½ã€‚';
            }

            // æ ¹æ®å·²æ¢éœ€çš„å†…å®¹è¡¥å……ç§è‰
            const usageProbe = nineQuestions.find(q => q.id === 'usage_scenario');
            if (usageProbe && usageProbe.status === 'complete' && usageProbe.answer !== 'æ¢éœ€ä¸åˆ°ä½') {
                if (usageProbe.answer.includes('å®¶åº­') && intentionModel && ['L6', 'L7', 'L8', 'L9'].includes(intentionModel)) {
                    seedingContent += '\n\næ‚¨ä¸»è¦æ˜¯å®¶åº­ç”¨è½¦å¯¹å§ï¼Ÿé‚£${intentionModel}çœŸçš„ç‰¹åˆ«é€‚åˆï¼Œ6åº§å¸ƒå±€ç¬¬äºŒæ’ç©ºé—´å’Œèˆ’é€‚åº¦éƒ½ç‰¹åˆ«å¥½ï¼Œå®¶äººé•¿é€”å‡ºè¡Œä½“éªŒä¼šå¾ˆæ£’ã€‚';
                } else if (usageProbe.answer.includes('é€šå‹¤') && intentionModel && (intentionModel === 'i6' || intentionModel === 'i8')) {
                    seedingContent += `\n\næ‚¨ä¸»è¦æ˜¯é€šå‹¤ç”¨è½¦å“ˆï¼Ÿé‚£${intentionModel}ç‰¹åˆ«é€‚åˆæ‚¨ï¼Œçº¯ç”µç”¨è½¦æˆæœ¬ä½ï¼Œæ™ºèƒ½é©¾é©¶åœ¨åŸå¸‚é“è·¯è¡¨ç°ç‰¹åˆ«å¥½ï¼Œèƒ½å¸®æ‚¨å‡è½»ä¸å°‘é©¾é©¶ç–²åŠ³ã€‚`;
                } else if (usageProbe.answer.includes('å•†åŠ¡') && intentionModel === 'MEGA') {
                    seedingContent += '\n\næ‚¨ä¸»è¦æ˜¯å•†åŠ¡ç”¨è½¦å“ˆï¼Ÿé‚£MEGAçœŸçš„æ˜¯æœ€ä½³é€‰æ‹©ï¼Œè±ªåèˆ’é€‚çš„ä¹˜åä½“éªŒï¼Œå•†åŠ¡æ¥å¾…ç‰¹åˆ«æœ‰é¢å­ï¼Œè€Œä¸”è¶…é•¿ç»­èˆªå®Œå…¨ä¸ç”¨æ‹…å¿ƒã€‚';
                }
            }

            // æ‰¾å‡ºæœªæ¢éœ€çš„é‡ç‚¹é¡¹ç›®è¿›è¡Œæ¢éœ€
            const keyProbes = [
                { id: 'family_structure', question: 'å¯¹äº†ï¼Œæ‚¨å®¶é‡Œä¸€èˆ¬å‡ å£äººç”¨è½¦å‘€ï¼Ÿ' },
                { id: 'budget', question: 'æ‚¨è¿™è¾¹è´­è½¦é¢„ç®—å¤§æ¦‚åœ¨ä»€ä¹ˆèŒƒå›´å‘¢ï¼Ÿè¿™æ ·æˆ‘èƒ½ç»™æ‚¨æ¨èæœ€åˆé€‚çš„é…ç½®~' },
                { id: 'usage_scenario', question: 'æ‚¨å¹³æ—¶ç”¨è½¦ä¸»è¦æ˜¯ä¸Šä¸‹ç­é€šå‹¤ï¼Œè¿˜æ˜¯å‘¨æœ«å¸¦å®¶äººå‡ºå»ç©æ¯”è¾ƒå¤šï¼Ÿ' },
                { id: 'decision_maker', question: 'è¿™æ¬¡ä¹°è½¦ä¸»è¦æ˜¯æ‚¨è‡ªå·±å†³å®šï¼Œè¿˜æ˜¯éœ€è¦å’Œå®¶äººå•†é‡ä¸€ä¸‹å‘€ï¼Ÿ' },
                { id: 'key_features', question: 'ä¹°è½¦æ‚¨æœ€çœ‹é‡å“ªäº›æ–¹é¢å‘¢ï¼Ÿæ¯”å¦‚ç»­èˆªã€æ™ºèƒ½é©¾é©¶ã€ç©ºé—´èˆ’é€‚åº¦ã€å®‰å…¨é…ç½®è¿™äº›ï¼Ÿ' }
            ];

            keyProbes.forEach(probe => {
                const result = nineQuestions.find(q => q.id === probe.id);
                if (result && result.status === 'incomplete') {
                    probingQuestions.push(probe.question);
                }
            });

            // ç»„åˆç§è‰å’Œæ¢éœ€
            let finalContent = seedingContent;

            if (probingQuestions.length > 0) {
                finalContent += '\n\nå¯¹äº†ï¼Œæˆ‘æƒ³æ›´äº†è§£ä¸€ä¸‹æ‚¨çš„éœ€æ±‚ï¼š\n';
                probingQuestions.slice(0, 2).forEach(q => {
                    finalContent += 'â€¢ ' + q + '\n';
                });
                finalContent += '\nè¿™æ ·æˆ‘èƒ½ç»™æ‚¨æ›´ç²¾å‡†çš„æ¨èå’Œå»ºè®®~';
            }

            scripts.push({
                type: 'seeding',
                title: 'ğŸŒ± æœ¬å“ç§è‰ + æ¢éœ€å¼•å¯¼',
                content: finalContent,
                stage: 'ç§è‰ä¸æ¢éœ€'
            });
        }

        // ç”Ÿæˆç«å“å¯¹æ¯”è¯æœ¯ï¼ˆä¿å®ˆç­–ç•¥ï¼šåªåœ¨æ˜ç¡®è¯†åˆ«åˆ°ç«å“æ—¶ç”Ÿæˆï¼‰
        function generateCompetitorScript(scripts, competitorAnswer, keywords) {
            let competitorScript = '';

            // ä¿å®ˆç­–ç•¥ï¼šåªæœ‰æ˜ç¡®åœ¨ keywords.competitors ä¸­çš„ç«å“æ‰ç”Ÿæˆè¯æœ¯
            const hasSpecificCompetitor = keywords.competitors && keywords.competitors.length > 0;

            if (competitorAnswer.includes('ç‰¹æ–¯æ‹‰')) {
                competitorScript = `çœ‹æ‚¨åœ¨å¯¹æ¯”ç‰¹æ–¯æ‹‰å“ˆï¼Ÿç‰¹æ–¯æ‹‰çš„ç§‘æŠ€æ„Ÿç¡®å®ä¸é”™ã€‚ä¸è¿‡${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬çš„è½¦'}å’Œç‰¹æ–¯æ‹‰ç›¸æ¯”ï¼Œç©ºé—´å’Œèˆ’é€‚åº¦çœŸçš„è¦å¥½ä¸å°‘ï¼Œç‰¹åˆ«æ˜¯é™è°§æ€§ï¼Œå’±ä»¬æ˜¯åŒä»·ä½å…¨è¡Œä¸šç¬¬ä¸€ã€‚\n\nä¹°è½¦è¯´åˆ°åº•å°±æ˜¯ä¹°ä¸ªèˆ’å¿ƒï¼Œç‰¹æ–¯æ‹‰åè¿åŠ¨ï¼Œå’±ä»¬ç†æƒ³æ›´åå®¶åº­èˆ’é€‚ã€‚æ‚¨è¯•é©¾ä¸€ä¸‹å°±èƒ½æ„Ÿå—åˆ°ï¼Œååœ¨è½¦é‡Œé‚£ç§å®‰é™èˆ’é€‚çš„æ„Ÿè§‰ï¼ŒçœŸçš„å·®åˆ«æŒºå¤§çš„ã€‚`;
            } else if (competitorAnswer.includes('è”šæ¥')) {
                competitorScript = `è”šæ¥ç¡®å®æ˜¯ä¸ªå¥½å“ç‰Œå“ˆï¼ŒæœåŠ¡åšå¾—ç‰¹åˆ«åˆ°ä½ã€‚ä¸è¿‡å’±ä»¬ä¸¤å®¶çš„ä¾§é‡ç‚¹ä¸å¤ªä¸€æ ·ï¼Œè”šæ¥æ›´åç§‘æŠ€è±ªåï¼Œå’±ä»¬ç†æƒ³æ›´æ³¨é‡å®¶åº­åœºæ™¯çš„å®ç”¨æ€§ã€‚\n\n${keywords.models && keywords.models.length > 0 && keywords.models[0] !== 'MEGA' ? 'åƒ6åº§å¸ƒå±€ã€å†°ç®±å½©ç”µå¤§æ²™å‘è¿™äº›ï¼Œéƒ½æ˜¯ä¸“é—¨ä¸ºå®¶åº­é•¿é€”å‡ºè¡Œè®¾è®¡çš„ã€‚' : ''}è€Œä¸”å¢ç¨‹æŠ€æœ¯è®©æ‚¨å®Œå…¨ä¸ç”¨æ‹…å¿ƒç»­èˆªï¼Œè”šæ¥è™½ç„¶æœ‰æ¢ç”µï¼Œä½†å¾—ä¿è¯é™„è¿‘æ¢ç”µç«™å¤Ÿå¤šï¼Œè€Œä¸”æ¢ç”µä¹Ÿæ˜¯è¦é¢å¤–èŠ±é’±çš„ã€‚æ‚¨å¯ä»¥ä¸¤è¾¹éƒ½è¯•é©¾ä½“éªŒä¸€ä¸‹ï¼Œçœ‹å“ªä¸ªæ›´ç¬¦åˆæ‚¨çš„ç”¨è½¦ä¹ æƒ¯~`;
            } else if (competitorAnswer.includes('é—®ç•Œ')) {
                competitorScript = `é—®ç•Œè¿™ä¸¤å¹´ç¡®å®æŒºç«çš„å“ˆã€‚ä¸è¿‡å’±ä»¬ç†æƒ³åœ¨å“ç‰Œå£ç¢‘ã€ç”¨æˆ·ç¤¾åŒºæ´»è·ƒåº¦ä¸Šæ›´æœ‰ä¼˜åŠ¿ï¼Œè€Œä¸”å¢ç¨‹æŠ€æœ¯å’±ä»¬æ˜¯åšå¾—æœ€æ—©ä¹Ÿæœ€ç¨³å®šçš„ã€‚\n\n${keywords.models && keywords.models.length > 0 && keywords.models[0] !== 'MEGA' ? keywords.models[0] + 'çš„NVHé™è°§æ€§ã€ç©ºé—´åˆ©ç”¨ç‡éƒ½æ˜¯è¡Œä¸šé¢†å…ˆçš„ã€‚æ‚¨è¦æ˜¯å®¶åº­ç”¨è½¦çš„è¯ï¼Œç†æƒ³çš„6åº§å¸ƒå±€ç¬¬äºŒæ’æ˜¯ç‹¬ç«‹åº§æ¤…ï¼Œåèµ·æ¥æ¯”7åº§èˆ’æœå¤ªå¤šäº†~' : 'å’±ä»¬çš„NVHé™è°§æ€§ã€ç©ºé—´åˆ©ç”¨ç‡éƒ½æ˜¯è¡Œä¸šé¢†å…ˆçš„~'}`;
            } else if (competitorAnswer.includes('å°é¹')) {
                competitorScript = `å°é¹çš„æ™ºèƒ½åŒ–ç¡®å®åšå¾—ä¸é”™å“ˆã€‚ä¸è¿‡å’±ä»¬ç†æƒ³åœ¨ç©ºé—´ã€èˆ’é€‚æ€§ä¸Šçš„è¡¨ç°æ›´çªå‡ºï¼Œç‰¹åˆ«é€‚åˆå®¶åº­ç”¨æˆ·ã€‚\n\n${keywords.models && keywords.models.length > 0 && keywords.models[0] !== 'MEGA' ? 'è€Œä¸”å¢ç¨‹æŠ€æœ¯è®©æ‚¨å®Œå…¨æ²¡æœ‰ç»­èˆªç„¦è™‘ï¼Œæƒ³å»å“ªå„¿å°±å»å“ªå„¿ã€‚' : ''}å°é¹çš„çº¯ç”µè½¦å¸‚åŒºé€šå‹¤æ²¡é—®é¢˜ï¼Œä½†è¦æ˜¯ç»å¸¸é•¿é€”è‡ªé©¾ï¼Œ${keywords.models && keywords.models.length > 0 && keywords.models[0] === 'MEGA' ? 'å’±ä»¬çº¯ç”µçš„ç»­èˆªè¡¨ç°ä¹Ÿæ›´å‡ºè‰²' : 'å¢ç¨‹çš„ä¾¿åˆ©æ€§å°±ä½“ç°å‡ºæ¥äº†'}~`;
            } else {
                competitorScript = `çœ‹å¾—å‡ºæ¥æ‚¨æŒºç†æ€§çš„å“ˆï¼Œå¤šå¯¹æ¯”å‡ å®¶è‚¯å®šæ˜¯å¯¹çš„ã€‚ä¸åŒå“ç‰Œç¡®å®å„æœ‰ç‰¹ç‚¹ã€‚\n\n${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬ç†æƒ³'}çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼š${keywords.models && keywords.models.length > 0 && keywords.models[0] === 'MEGA' ? 'çº¯ç”µMPVå®šä½ï¼Œè¶…é•¿ç»­èˆª' : 'å¢ç¨‹æŠ€æœ¯å®Œå…¨æ²¡æœ‰é‡Œç¨‹ç„¦è™‘ï¼Œ6åº§å¸ƒå±€ä¸ºå®¶åº­å‡ºè¡Œæ·±åº¦ä¼˜åŒ–'}ï¼ŒAD Maxæ™ºèƒ½é©¾é©¶ä½“éªŒå¾ˆæ£’ï¼Œè€Œä¸”æ–°åŠ¿åŠ›é‡Œä¿å€¼ç‡æœ€é«˜ã€‚æ‚¨æœ€çœ‹é‡å“ªæ–¹é¢å‘€ï¼Ÿæˆ‘å¯ä»¥é’ˆå¯¹æ€§åœ°è·Ÿæ‚¨èŠèŠå’±ä»¬åœ¨è¿™äº›æ–¹é¢çš„è¡¨ç°~`;
            }

            scripts.push({
                type: 'competitor',
                title: 'âš–ï¸ ç«å“å¯¹æ¯”',
                content: competitorScript,
                stage: 'ç«å“å¯¹æ¯”'
            });
        }

        // ç”Ÿæˆæ€§èƒ½é¡¾è™‘è¯æœ¯
        function generateConcernScript(scripts, keywords) {
            const concernsStr = keywords.concerns.join('ã€');
            let concernContent = `çœ‹æ‚¨æ¯”è¾ƒå…³æ³¨${concernsStr}ï¼Œè¿™äº›ç¡®å®æ˜¯ä¹°è½¦çš„é‡è¦è€ƒé‡ã€‚å’±ä»¬åœ¨è¿™äº›æ–¹é¢è¡¨ç°éƒ½æŒºä¸é”™çš„ï¼š\n\n`;

            if (keywords.concerns.includes('ç»­èˆª')) {
                concernContent += 'â€¢ ç»­èˆªï¼šå¢ç¨‹è½¦å‹çº¯ç”µèƒ½è·‘200å¤šå…¬é‡Œï¼Œæ—¥å¸¸é€šå‹¤å®Œå…¨å¤Ÿç”¨ã€‚é•¿é€”åŠ æ²¹å°±è¡Œï¼Œç»¼åˆç»­èˆª1000å…¬é‡Œä»¥ä¸Šï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒè¶´çª\n';
            }
            if (keywords.concerns.includes('æ™ºèƒ½é©¾é©¶')) {
                concernContent += 'â€¢ æ™ºèƒ½é©¾é©¶ï¼šå’±ä»¬çš„AD Maxç³»ç»ŸçœŸçš„æŒºå‰å®³ï¼Œé«˜é€ŸNOAå’ŒåŸå¸‚NOAä½“éªŒéƒ½ç‰¹åˆ«å¥½ï¼Œæ˜¯ç›®å‰é‡äº§è½¦é‡Œåšå¾—æœ€å¥½çš„ä¹‹ä¸€ã€‚æ‚¨è¯•é©¾çš„æ—¶å€™å¯ä»¥é‡ç‚¹ä½“éªŒä¸€ä¸‹\n';
            }
            if (keywords.concerns.includes('å……ç”µ')) {
                concernContent += 'â€¢ å……ç”µï¼šå¢ç¨‹è½¦å‹æœ€å¤§çš„å¥½å¤„å°±æ˜¯ä¸ç”¨ç„¦è™‘å……ç”µã€‚æ—¥å¸¸æœ‰æ¡ä»¶å°±å……ç”µï¼Œç”¨ç”µæˆæœ¬ä½ï¼›é•¿é€”æˆ–è€…æ¥ä¸åŠå……å°±åŠ æ²¹ï¼Œç‰¹åˆ«çµæ´»\n';
            }
            if (keywords.concerns.includes('ä¿å€¼ç‡')) {
                concernContent += 'â€¢ ä¿å€¼ç‡ï¼šç†æƒ³åœ¨æ–°åŠ¿åŠ›é‡Œä¿å€¼ç‡æœ€é«˜ï¼Œä¸‰å¹´èƒ½åˆ°70%ä»¥ä¸Šã€‚æ‚¨å¯ä»¥å»äºŒæ‰‹è½¦å¸‚åœºçœ‹çœ‹ï¼Œç†æƒ³çš„ä¿å€¼ç¡®å®å¥½\n';
            }
            if (keywords.concerns.includes('ç©ºé—´')) {
                concernContent += `â€¢ ç©ºé—´ï¼š${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬è¿™è½¦'}ç©ºé—´ç»å¯¹å¤Ÿç”¨ï¼Œç‰¹åˆ«æ˜¯ç¬¬äºŒæ’ï¼Œåèµ·æ¥æ¯”å¾ˆå¤šDçº§è½¦éƒ½èˆ’æœ\n`;
            }
            if (keywords.concerns.includes('å®‰å…¨')) {
                concernContent += 'â€¢ å®‰å…¨ï¼šå’±ä»¬åœ¨ä¸­ä¿ç ”çš„æµ‹è¯•æˆç»©éƒ½æ˜¯ä¼˜ç§€ï¼Œå®‰å…¨é…ç½®ä¹Ÿæ˜¯æ‹‰æ»¡çš„ï¼Œè¿™æ–¹é¢æ‚¨å®Œå…¨å¯ä»¥æ”¾å¿ƒ\n';
            }
            if (keywords.concerns.includes('ä»·æ ¼')) {
                concernContent += `â€¢ ä»·æ ¼ï¼š${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬çš„è½¦å‹'}é…ç½®åœ¨åŒä»·ä½é‡Œå¾ˆåšé“äº†ï¼Œè€Œä¸”ä¿å€¼ç‡é«˜ï¼Œç»¼åˆç®—ä¸‹æ¥æ€§ä»·æ¯”æŒºçªå‡ºçš„\n`;
            }

            concernContent += '\næ‚¨å¯¹è¿™äº›æ–¹é¢è¿˜æœ‰ä»€ä¹ˆæƒ³è¯¦ç»†äº†è§£çš„å—ï¼Ÿå’±ä»¬å¯ä»¥ç»†èŠ~';

            scripts.push({
                type: 'concern',
                title: 'ğŸ’¡ æ ¸å¿ƒé¡¾è™‘è§£ç­”',
                content: concernContent,
                stage: 'é¡¾è™‘è§£ç­”'
            });
        }

        // æ™ºèƒ½åˆ†æå®¢æˆ·
        function analyzeCustomer() {
            const input = document.getElementById('customerInput').value.trim();

            if (!input) {
                alert('è¯·è¾“å…¥å®¢æˆ·æè¿°ä¿¡æ¯');
                return;
            }

            const celnResult = analyzeCELN(input);
            const nineQuestionsResult = analyzeNineQuestions(input);
            const keywords = extractKeywords(input);
            const scripts = generateImprovedScripts(celnResult, nineQuestionsResult, keywords);

            // ä¿å­˜å½“å‰ç»“æœ
            currentAnalysisResult = {
                celn: celnResult,
                nineQuestions: nineQuestionsResult,
                keywords: keywords,
                scripts: scripts
            };

            // ä¿å­˜åˆ°å†å²è®°å½•
            saveAnalysisHistory(input, currentAnalysisResult);

            displayResult(celnResult, nineQuestionsResult, keywords, scripts);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(celn, nineQuestions, keywords, scripts) {
            let html = '';

            // CELNæ ‡ç­¾
            html += '<div class="result-section">';
            html += '<h3>ğŸ“Š CELNæ¨¡å‹åˆ†æ</h3>';
            html += '<div class="celn-tags">';

            html += `<div class="celn-tag ${celn.C}">`;
            html += '<div class="dimension">C</div>';
            html += '<div class="name">è´­è½¦æ„å‘</div>';
            html += `<div class="value">${CELN_CONFIG.C.labels[celn.C]}</div>`;
            html += '</div>';

            html += `<div class="celn-tag ${celn.E === 'new_energy' ? 'high' : 'medium'}">`;
            html += '<div class="dimension">E</div>';
            html += '<div class="name">èƒ½æºç±»å‹</div>';
            html += `<div class="value">${CELN_CONFIG.E.labels[celn.E]}</div>`;
            html += '</div>';

            html += `<div class="celn-tag ${celn.L === 'ideal' ? 'high' : 'medium'}">`;
            html += '<div class="dimension">L</div>';
            html += '<div class="name">å“ç‰Œåå¥½</div>';
            html += `<div class="value">${CELN_CONFIG.L.labels[celn.L]}</div>`;
            html += '</div>';

            html += `<div class="celn-tag ${celn.N === 'immediate' ? 'high' : 'medium'}">`;
            html += '<div class="dimension">N</div>';
            html += '<div class="name">è´­ä¹°æ—¶æœº</div>';
            html += `<div class="value">${CELN_CONFIG.N.labels[celn.N]}</div>`;
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // æ²Ÿé€šè®°å½•ç»Ÿè®¡ï¼ˆæ–°å¢ï¼‰
            const input = document.getElementById('customerInput').value.trim();
            const dates = extractDates(input);
            if (dates.length > 0) {
                html += '<div class="result-section">';
                html += '<h3>ğŸ“ æ²Ÿé€šè®°å½•</h3>';
                html += '<div style="background: #f0f7ff; padding: 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += `<div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px;">`;
                html += `å·²è·Ÿè¿› <span style="color: #667eea; font-size: 20px;">${dates.length}</span> æ¬¡`;
                html += '</div>';
                html += `<div style="font-size: 13px; color: #666; line-height: 1.6;">`;
                html += `æ²Ÿé€šæ—¥æœŸï¼š${dates.join(' â†’ ')}`;
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            // æ¢éœ€ä¹é—®
            html += '<div class="result-section">';
            html += '<h3>ğŸ¯ æ¢éœ€ä¹é—®åˆ†æ</h3>';
            html += '<div class="probe-grid">';

            nineQuestions.forEach(q => {
                html += `<div class="probe-item ${q.status}">`;
                html += '<div style="flex: 1;">';
                html += `<div class="question-label">${q.label}</div>`;
                html += `<div class="answer">${q.answer}</div>`;
                html += '</div>';
                html += `<div class="status-badge ${q.status}">`;
                if (q.status === 'complete') html += 'âœ“ å·²æ¢éœ€';
                else if (q.status === 'partial') html += 'âš  éƒ¨åˆ†æ¢éœ€';
                else html += 'âœ— å¾…æ¢éœ€';
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            // è¡¥å……å…³é”®è¯ä¿¡æ¯ï¼ˆæ¢éœ€ä¹é—®æœªä½“ç°çš„ï¼‰
            html += '<div class="result-section">';
            html += '<h3>ğŸ·ï¸ è¡¥å……ä¿¡æ¯</h3>';
            html += '<div class="keyword-grid" style="display: grid; gap: 10px;">';

            let hasKeywords = false;

            if (keywords.models && keywords.models.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">æ„å‘è½¦å‹</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.models.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.competitors && keywords.competitors.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">ç«å“è½¦å‹</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.competitors.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.purpose && keywords.purpose.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">ç”¨è½¦åœºæ™¯</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.purpose.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.concerns && keywords.concerns.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">å…³æ³¨ç‚¹</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.concerns.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.visitedStores && keywords.visitedStores.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">çœ‹è½¦é—¨åº—</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.visitedStores.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.residenceLocation) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">å±…ä½åœ°å€</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.residenceLocation}</div>`;
                html += '</div>';
            }

            if (keywords.financeSensitivity && keywords.financeSensitivity !== 'æœªçŸ¥') {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">é‡‘èæ•æ„Ÿåº¦</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.financeSensitivity}</div>`;
                html += '</div>';
            }

            if (keywords.hasTradeIn) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">äºŒæ‰‹è½¦ç½®æ¢</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">æœ‰ç½®æ¢éœ€æ±‚ï¼ˆ${keywords.tradeInInfo}ï¼‰</div>`;
                html += '</div>';
            }

            if (!hasKeywords) {
                html += '<div style="text-align: center; padding: 20px; color: #999; font-size: 13px;">æš‚æ— è¡¥å……ä¿¡æ¯</div>';
            }

            html += '</div>';
            html += '</div>';

            // è¯æœ¯æ¨è
            html += '<div class="result-section">';
            html += '<h3>ğŸ’¬ æ™ºèƒ½è¯æœ¯æ¨è</h3>';

            if (scripts.length === 0) {
                html += '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">æš‚æ— è¯æœ¯æ¨è</div>';
            } else {
                scripts.forEach((script, index) => {
                    const btnId = `copyBtn${index}`;
                    html += `<div class="script-box ${script.type}">`;
                    html += `<button class="copy-btn" id="${btnId}" onclick="copyScript(\`${script.content.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`, '${btnId}')">ğŸ“‹ å¤åˆ¶</button>`;
                    html += `<h4>${script.title}</h4>`;
                    if (script.stage) {
                        html += `<div style="font-size: 12px; color: #666; margin-bottom: 8px;">ğŸ“ ${script.stage}</div>`;
                    }
                    html += `<p style="white-space: pre-line;">${script.content}</p>`;
                    html += '</div>';
                });
            }

            // æ¢éœ€å®Œæˆåº¦ç»Ÿè®¡
            const completeCount = nineQuestions.filter(q => q.status === 'complete').length;
            const partialCount = nineQuestions.filter(q => q.status === 'partial').length;
            const incompleteCount = nineQuestions.filter(q => q.status === 'incomplete').length;

            html += '<div class="key-points" style="background: #fff3e6; margin-top: 16px;">';
            html += '<h4>ğŸ“ˆ æ¢éœ€å®Œæˆåº¦</h4>';
            html += '<ul>';
            html += `<li>å®Œå…¨æ¢éœ€ï¼š${completeCount}/9 é¡¹</li>`;
            html += `<li>éƒ¨åˆ†æ¢éœ€ï¼š${partialCount}/9 é¡¹</li>`;
            html += `<li>å¾…æ¢éœ€ï¼š${incompleteCount}/9 é¡¹</li>`;
            if (incompleteCount > 0) {
                html += `<li><strong>å»ºè®®ï¼š</strong>é‡ç‚¹è¡¥å…… ${nineQuestions.filter(q => q.status === 'incomplete').map(q => q.label.split('.')[1].trim()).slice(0, 3).join('ã€')} ç­‰ä¿¡æ¯</li>`;
            }
            html += '</ul>';
            html += '</div>';

            html += '</div>';

            document.getElementById('resultArea').innerHTML = html;
        }

        // ========== åº—é•¿è§†å›¾åŠŸèƒ½ ==========

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–ç¬¬ä¸€ä¸ªsheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // è§£æå¹¶åˆ†ææ•°æ®
                    analyzeManagerData(jsonData);
                } catch (error) {
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚\n\néœ€è¦åŒ…å«å­—æ®µï¼šä¸“å®¶å§“åã€å®¢æˆ·å§“åã€å•†æœºç­‰çº§ã€å®¢æˆ·æè¿°');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('excelFile').files = e.dataTransfer.files;
                handleFileUpload({ target: { files: [file] } });
            }
        });

        // æ™ºèƒ½è¯†åˆ«å•†æœºç­‰çº§å­—æ®µ
        function findOpportunityLevelField(row) {
            // å¯èƒ½çš„å­—æ®µåï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
            const possibleFields = [
                'å•†æœºç­‰çº§', 'å•†æœºç±»å‹', 'å•†æœº', 'ç­‰çº§', 'ç±»å‹',
                'å•†æœºçŠ¶æ€', 'çŠ¶æ€', 'çº§åˆ«', 'åˆ†ç±»'
            ];

            for (const field of possibleFields) {
                if (row.hasOwnProperty(field) && row[field]) {
                    return row[field];
                }
            }

            return null;
        }

        // æ™ºèƒ½è¯†åˆ«å•†æœºç­‰çº§
        function parseOpportunityLevel(levelStr) {
            if (!levelStr) return 'å…¶ä»–';

            // è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å»é™¤ç©ºæ ¼
            const str = String(levelStr).trim();
            const upperStr = str.toUpperCase();

            // ç²¾ç¡®åŒ¹é… - A/B/C/FC
            if (upperStr === 'A' || upperStr === 'Aç±»' || upperStr === 'Aç±»å•†æœº' || str === 'Aç±»') return 'A';
            if (upperStr === 'B' || upperStr === 'Bç±»' || upperStr === 'Bç±»å•†æœº' || str === 'Bç±»') return 'B';
            if (upperStr === 'C' || upperStr === 'Cç±»' || upperStr === 'Cç±»å•†æœº' || str === 'Cç±»') return 'C';
            if (upperStr === 'FC' || upperStr === 'F' || upperStr === 'FORECAST' || str === 'FCç±»') return 'FC';

            // ç²¾ç¡®åŒ¹é… - ç‰¹æ®ŠçŠ¶æ€
            if (str === 'é•¿æœŸ' || str === 'é•¿æœŸå®¢æˆ·' || str === 'é•¿æœŸè·Ÿè¿›') return 'é•¿æœŸ';
            if (str === 'å·²æˆ˜è´¥' || str === 'æˆ˜è´¥' || str === 'å¤±è´¥' || str === 'å·²å¤±è´¥') return 'å·²æˆ˜è´¥';
            if (str === 'å·²é”å•' || str === 'é”å•' || str === 'å·²æˆäº¤' || str === 'æˆäº¤') return 'å·²é”å•';
            if (str === 'ç±»') return 'C'; // å•ç‹¬çš„"ç±»"å­—é»˜è®¤ä¸ºCç±»

            // æ¨¡ç³ŠåŒ¹é…
            if (upperStr.includes('FC') || upperStr.includes('FORECAST')) return 'FC';
            if (str.includes('æˆ˜è´¥') || str.includes('å¤±è´¥')) return 'å·²æˆ˜è´¥';
            if (str.includes('é”å•') || str.includes('æˆäº¤')) return 'å·²é”å•';
            if (str.includes('é•¿æœŸ')) return 'é•¿æœŸ';

            // å­—æ¯å¼€å¤´åŒ¹é…
            if (upperStr.startsWith('A')) return 'A';
            if (upperStr.startsWith('B')) return 'B';
            if (upperStr.startsWith('C')) return 'C';

            // å…¶ä»–æƒ…å†µç»Ÿä¸€å½’ç±»ä¸º"å…¶ä»–"
            return str || 'å…¶ä»–';
        }

        // å­—æ®µæ¨¡ç³ŠåŒ¹é…åŠŸèƒ½
        function findFieldValue(row, possibleNames) {
            // ä¼˜å…ˆç²¾ç¡®åŒ¹é…
            for (const name of possibleNames) {
                if (row[name] !== undefined) {
                    return row[name];
                }
            }

            // æ¨¡ç³ŠåŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
            const rowKeys = Object.keys(row);
            for (const name of possibleNames) {
                const lowerName = name.toLowerCase();
                for (const key of rowKeys) {
                    if (key.toLowerCase().includes(lowerName) || lowerName.includes(key.toLowerCase())) {
                        return row[key];
                    }
                }
            }

            return null;
        }

        // åˆ†æåº—é•¿æ•°æ®ï¼ˆå¢å¼ºå­—æ®µè¯†åˆ«ï¼‰
        function analyzeManagerData(data) {
            // å®šä¹‰å­—æ®µåˆ«åæ˜ å°„
            const fieldAliases = {
                expert: ['ä¸“å®¶å§“å', 'ä¸“å®¶', 'é”€å”®', 'é¡¾é—®', 'é”€å”®é¡¾é—®', 'é”€å”®ä¸“å®¶', 'é”€å”®å§“å', 'ä¸“å®¶åç§°'],
                customer: ['å®¢æˆ·å§“å', 'å®¢æˆ·', 'å§“å', 'é¡¾å®¢', 'é¡¾å®¢å§“å', 'å®¢æˆ·åç§°', 'ç”¨æˆ·', 'ç”¨æˆ·å§“å'],
                level: ['å•†æœºç­‰çº§', 'å•†æœº', 'ç­‰çº§', 'çº§åˆ«', 'å®¢æˆ·ç­‰çº§', 'å•†æœºçº§åˆ«'],
                description: ['å®¢æˆ·æè¿°', 'æè¿°', 'å¤‡æ³¨', 'ä¿¡æ¯', 'å®¢æˆ·ä¿¡æ¯', 'è¯¦æƒ…', 'è¯´æ˜']
            };

            // æ•°æ®æ ¼å¼åŒ–ï¼šä½¿ç”¨æ¨¡ç³ŠåŒ¹é…
            const customers = data.map(row => {
                const expertValue = findFieldValue(row, fieldAliases.expert);
                const customerValue = findFieldValue(row, fieldAliases.customer);
                const levelValue = findFieldValue(row, fieldAliases.level);
                const descriptionValue = findFieldValue(row, fieldAliases.description);

                return {
                    expert: expertValue || 'æœªçŸ¥ä¸“å®¶',
                    customer: customerValue || 'æœªçŸ¥å®¢æˆ·',
                    level: parseOpportunityLevel(levelValue),
                    description: descriptionValue || ''
                };
            });

            // åˆ†ææ¯ä¸ªå®¢æˆ·çš„æ¢éœ€æƒ…å†µ
            const analyzedCustomers = customers.map(c => {
                const probeResult = analyzeNineQuestions(c.description);
                const completeCount = probeResult.filter(q => q.status === 'complete').length;
                const partialCount = probeResult.filter(q => q.status === 'partial').length;
                const incompleteCount = probeResult.filter(q => q.status === 'incomplete').length;
                const completionRate = ((completeCount + partialCount * 0.5) / 9 * 100).toFixed(0);

                return {
                    ...c,
                    probeResult,
                    completeCount,
                    partialCount,
                    incompleteCount,
                    completionRate: parseInt(completionRate)
                };
            });

            // æŒ‰ä¸“å®¶åˆ†ç»„
            const expertGroups = {};
            analyzedCustomers.forEach(c => {
                if (!expertGroups[c.expert]) {
                    expertGroups[c.expert] = [];
                }
                expertGroups[c.expert].push(c);
            });

            // ä¿å­˜åˆ°å…¨å±€
            managerData = {
                customers: analyzedCustomers,
                expertGroups
            };

            // åˆå§‹åŒ–ç­›é€‰æ•°æ®
            filteredData = managerData;

            // ä¿å­˜åˆ°localStorage
            saveManagerData(managerData);

            // æ˜¾ç¤ºåˆ†æç»“æœ
            displayManagerAnalysis(managerData);
        }

        // æ˜¾ç¤ºåº—é•¿åˆ†æç»“æœ
        function displayManagerAnalysis(data, isFiltered = false) {
            document.getElementById('managerAnalysis').style.display = 'block';

            // å¦‚æœæ²¡æœ‰å®¢æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
            if (!data.customers || data.customers.length === 0) {
                document.querySelector('.stats-grid').innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 40px; color: #999;">æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å®¢æˆ·</div>';
                document.getElementById('weaknessAnalysis').innerHTML = '';
                document.getElementById('expertList').innerHTML = '';
                return;
            }

            // æ•´ä½“ç»Ÿè®¡
            const totalCustomers = data.customers.length;

            // ç»Ÿè®¡æ‰€æœ‰å•†æœºç±»å‹
            const levelStats = {};
            data.customers.forEach(c => {
                levelStats[c.level] = (levelStats[c.level] || 0) + 1;
            });

            // å¹³å‡æ¢éœ€å®Œæˆåº¦
            const avgCompletion = Math.round(data.customers.reduce((sum, c) => sum + c.completionRate, 0) / totalCustomers);

            // åŠ¨æ€ç”Ÿæˆç»Ÿè®¡å¡ç‰‡
            let statsHtml = '';

            // æ€»å®¢æˆ·æ•°å¡ç‰‡
            statsHtml += '<div class="stat-card">';
            statsHtml += '<h3>æ€»å®¢æˆ·æ•°</h3>';
            statsHtml += `<div class="value">${totalCustomers}</div>`;
            statsHtml += '<div class="subtext">å·²å¯¼å…¥å®¢æˆ·</div>';
            statsHtml += '</div>';

            // æŒ‰å•†æœºç±»å‹ä¼˜å…ˆçº§æ’åºå¹¶ç”Ÿæˆå¡ç‰‡
            const levelOrder = ['A', 'B', 'C', 'FC', 'é•¿æœŸ', 'å·²é”å•', 'å·²æˆ˜è´¥'];
            const levelLabels = {
                'A': 'Aç±»å•†æœº',
                'B': 'Bç±»å•†æœº',
                'C': 'Cç±»å•†æœº',
                'FC': 'FCå•†æœº',
                'é•¿æœŸ': 'é•¿æœŸå®¢æˆ·',
                'å·²é”å•': 'å·²é”å•',
                'å·²æˆ˜è´¥': 'å·²æˆ˜è´¥'
            };
            const levelSubtext = {
                'A': 'é«˜æ„å‘å®¢æˆ·',
                'B': 'ä¸­æ„å‘å®¢æˆ·',
                'C': 'ä½æ„å‘å®¢æˆ·',
                'FC': 'é¢„æµ‹å•†æœº',
                'é•¿æœŸ': 'é•¿æœŸè·Ÿè¿›',
                'å·²é”å•': 'æˆäº¤å®¢æˆ·',
                'å·²æˆ˜è´¥': 'å·²å¤±è´¥'
            };

            // å…ˆæ˜¾ç¤ºå¸¸è§„ç±»å‹
            levelOrder.forEach(level => {
                if (levelStats[level]) {
                    statsHtml += '<div class="stat-card">';
                    statsHtml += `<h3>${levelLabels[level] || level}</h3>`;
                    statsHtml += `<div class="value">${levelStats[level]}</div>`;
                    statsHtml += `<div class="subtext">${levelSubtext[level] || 'å®¢æˆ·'}</div>`;
                    statsHtml += '</div>';
                }
            });

            // æ˜¾ç¤ºå…¶ä»–ç±»å‹
            Object.keys(levelStats).forEach(level => {
                if (!levelOrder.includes(level)) {
                    statsHtml += '<div class="stat-card">';
                    statsHtml += `<h3>${level}</h3>`;
                    statsHtml += `<div class="value">${levelStats[level]}</div>`;
                    statsHtml += '<div class="subtext">å®¢æˆ·</div>';
                    statsHtml += '</div>';
                }
            });

            // å¹³å‡æ¢éœ€å®Œæˆåº¦å¡ç‰‡
            statsHtml += '<div class="stat-card">';
            statsHtml += '<h3>å¹³å‡æ¢éœ€å®Œæˆåº¦</h3>';
            statsHtml += `<div class="value">${avgCompletion}%</div>`;
            statsHtml += '<div class="subtext">9ä¸ªç»´åº¦</div>';
            statsHtml += '</div>';

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡å®¹å™¨
            document.querySelector('.stats-grid').innerHTML = statsHtml;

            // å›¢é˜Ÿæ¢éœ€è–„å¼±é¡¹åˆ†æ
            const weaknessStats = {};
            NINE_QUESTIONS.forEach(q => {
                weaknessStats[q.id] = {
                    label: q.label.split('.')[1].trim(),
                    complete: 0,
                    incomplete: 0,
                    partial: 0,
                    total: totalCustomers
                };
            });

            data.customers.forEach(c => {
                c.probeResult.forEach(p => {
                    if (p.status === 'complete') {
                        weaknessStats[p.id].complete++;
                    } else if (p.status === 'incomplete') {
                        weaknessStats[p.id].incomplete++;
                    } else if (p.status === 'partial') {
                        weaknessStats[p.id].partial++;
                    }
                });
            });

            // è®¡ç®—æ¢éœ€å®Œæˆåº¦å¹¶æ’åºï¼ˆå®Œæˆåº¦è¶Šä½è¶Šé å‰ï¼‰
            const weaknessArray = Object.values(weaknessStats).map(w => {
                // å®Œæˆåº¦ = (å®Œå…¨æ¢éœ€æ•° + éƒ¨åˆ†æ¢éœ€æ•° * 0.5) / æ€»æ•°
                const completionRate = (w.complete + w.partial * 0.5) / w.total * 100;
                return {
                    ...w,
                    completionRate: completionRate
                };
            }).sort((a, b) => a.completionRate - b.completionRate); // æŒ‰å®Œæˆåº¦å‡åºæ’åºï¼Œè¶Šä½è¶Šé å‰

            let weaknessHtml = '';
            weaknessArray.slice(0, 5).forEach(w => {
                const percentage = w.completionRate.toFixed(0);
                let barClass = '';
                // å®Œæˆåº¦ä½äº40%ï¼šçº¢è‰²ï¼ˆå·®ï¼‰
                // å®Œæˆåº¦40-60%ï¼šæ©™è‰²ï¼ˆä¸­ç­‰ï¼‰
                // å®Œæˆåº¦é«˜äº60%ï¼šè“è‰²ï¼ˆå¥½ï¼‰
                if (percentage < 40) barClass = 'low';
                else if (percentage < 60) barClass = 'medium';

                weaknessHtml += '<div class="probe-bar">';
                weaknessHtml += `<div class="label">${w.label}</div>`;
                weaknessHtml += '<div class="bar-container">';
                weaknessHtml += `<div class="bar-fill ${barClass}" style="width: ${percentage}%">`;
                weaknessHtml += `<span class="percentage">${percentage}%</span>`;
                weaknessHtml += '</div>';
                weaknessHtml += '</div>';
                weaknessHtml += '</div>';
            });
            document.getElementById('weaknessAnalysis').innerHTML = weaknessHtml;

            // å„ä¸“å®¶è¯¦ç»†åˆ†æ
            let expertHtml = '';
            let expertIndex = 0;
            Object.entries(data.expertGroups).forEach(([expertName, customers]) => {
                const avgRate = Math.round(customers.reduce((sum, c) => sum + c.completionRate, 0) / customers.length);

                // ç»Ÿè®¡è¯¥ä¸“å®¶çš„å„ç±»å•†æœº
                const expertLevelStats = {};
                customers.forEach(c => {
                    expertLevelStats[c.level] = (expertLevelStats[c.level] || 0) + 1;
                });

                // ç”Ÿæˆå•†æœºç±»å‹ç»Ÿè®¡æ–‡æœ¬
                const levelOrder = ['A', 'B', 'C', 'FC', 'é•¿æœŸ', 'å·²é”å•', 'å·²æˆ˜è´¥'];
                const levelEmojis = {
                    'A': 'ğŸ”´',
                    'B': 'ğŸŸ ',
                    'C': 'ğŸ”µ',
                    'FC': 'ğŸŸ£',
                    'é•¿æœŸ': 'ğŸŸ¢',
                    'å·²é”å•': 'ğŸŸ¡',
                    'å·²æˆ˜è´¥': 'âšª'
                };

                let levelStatsText = '';
                levelOrder.forEach(level => {
                    if (expertLevelStats[level]) {
                        const emoji = levelEmojis[level] || 'âš«';
                        levelStatsText += `${emoji} ${level}: ${expertLevelStats[level]} `;
                    }
                });
                // æ·»åŠ å…¶ä»–ç±»å‹
                Object.keys(expertLevelStats).forEach(level => {
                    if (!levelOrder.includes(level)) {
                        levelStatsText += `âš« ${level}: ${expertLevelStats[level]} `;
                    }
                });

                const expertId = `expert-${expertIndex}`;
                expertIndex++;

                expertHtml += '<div class="expert-card">';

                // ä¸“å®¶å¤´éƒ¨ï¼ˆå¯ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰
                expertHtml += `<div class="expert-header" onclick="toggleExpertDetails('${expertId}')">`;
                expertHtml += '<div class="expert-name">';
                expertHtml += `<span class="expand-icon" id="${expertId}-icon">â–¶</span>`;
                expertHtml += expertName;
                expertHtml += '</div>';
                expertHtml += '<div class="expert-stats">';
                expertHtml += `<span>ğŸ“Š æ¢éœ€å®Œæˆåº¦: ${avgRate}%</span>`;
                expertHtml += `<span>ğŸ‘¥ å®¢æˆ·æ•°: ${customers.length}</span>`;
                expertHtml += `<span>${levelStatsText}</span>`;
                expertHtml += '</div>';
                expertHtml += '</div>';

                // è¯¦æƒ…åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰
                expertHtml += `<div class="expert-details" id="${expertId}">`;

                // è®¡ç®—è¯¥ä¸“å®¶çš„æ¢éœ€å®Œæˆåº¦ç»Ÿè®¡
                const expertProbeStats = {};
                NINE_QUESTIONS.forEach(q => {
                    expertProbeStats[q.id] = {
                        label: q.label.split('.')[1].trim(),
                        question: q.question,
                        complete: 0,
                        incomplete: 0,
                        partial: 0,
                        total: customers.length
                    };
                });
                customers.forEach(c => {
                    c.probeResult.forEach(p => {
                        if (p.status === 'complete') {
                            expertProbeStats[p.id].complete++;
                        } else if (p.status === 'incomplete') {
                            expertProbeStats[p.id].incomplete++;
                        } else if (p.status === 'partial') {
                            expertProbeStats[p.id].partial++;
                        }
                    });
                });

                // è®¡ç®—æ¢éœ€å®Œæˆåº¦å¹¶æ’åºï¼ˆå®Œæˆåº¦è¶Šä½è¶Šé å‰ï¼‰
                const expertProbeArray = Object.entries(expertProbeStats).map(([id, stats]) => {
                    const completionRate = (stats.complete + stats.partial * 0.5) / stats.total * 100;
                    return {
                        id: id,
                        ...stats,
                        completionRate: completionRate
                    };
                }).sort((a, b) => a.completionRate - b.completionRate);

                // ========== ä¸“å®¶æ¢éœ€èƒ½åŠ›é›·è¾¾å›¾ ==========
                const radarChartId = `radarChart-${expertId}`;
                expertHtml += '<div class="expert-radar-container">';
                expertHtml += '<h4>ğŸ“Š æ¢éœ€èƒ½åŠ›é›·è¾¾å›¾ï¼ˆ9ç»´åº¦åˆ†æï¼‰</h4>';
                expertHtml += `<canvas id="${radarChartId}" class="expert-radar-canvas"></canvas>`;
                expertHtml += '</div>';

                // å–å‰5ä¸ªè–„å¼±é¡¹
                const topWeaknessWithRate = expertProbeArray.slice(0, 5);

                // ä¿å­˜é›·è¾¾å›¾æ•°æ®ï¼ˆæ‰€æœ‰9ä¸ªç»´åº¦çš„å®Œæˆåº¦ï¼ŒæŒ‰åŸå§‹é¡ºåºï¼‰
                const radarDataForExpert = NINE_QUESTIONS.map(q => {
                    const stat = expertProbeStats[q.id];
                    const rate = (stat.complete + stat.partial * 0.5) / stat.total * 100;
                    return {
                        label: stat.label,
                        rate: rate
                    };
                });

                // å­˜å‚¨åˆ°å…¨å±€å˜é‡ï¼Œé”®ä¸ºexpertId
                expertRadarDataGlobal[expertId] = {
                    radarChartId: radarChartId,
                    expertName: expertName,
                    data: radarDataForExpert
                };

                if (topWeaknessWithRate.length > 0 && topWeaknessWithRate[0].completionRate < 100) {
                    expertHtml += '<h4 style="font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600;">âš ï¸ æ¢éœ€è–„å¼±é¡¹åˆ†æï¼ˆæŒ‰å®Œæˆåº¦ä»ä½åˆ°é«˜ï¼‰</h4>';

                    topWeaknessWithRate.forEach(w => {
                        const percentage = w.completionRate.toFixed(0);
                        let barClass = '';
                        if (percentage < 40) barClass = 'low';
                        else if (percentage < 60) barClass = 'medium';

                        expertHtml += '<div style="margin-bottom: 20px; padding: 15px; background: #fff9f0; border-radius: 10px; border-left: 4px solid #ff9800;">';

                        // æ¢éœ€é¡¹åç§°å’Œè¿›åº¦æ¡
                        expertHtml += '<div class="probe-bar" style="margin-bottom: 10px;">';
                        expertHtml += `<div class="label" style="font-weight: 600; color: #333;">${w.label}</div>`;
                        expertHtml += '<div class="bar-container">';
                        expertHtml += `<div class="bar-fill ${barClass}" style="width: ${percentage}%">`;
                        expertHtml += `<span class="percentage">${percentage}%</span>`;
                        expertHtml += '</div>';
                        expertHtml += '</div>';
                        expertHtml += '</div>';

                        // æ”¹è¿›å»ºè®®è¯æœ¯
                        expertHtml += '<div style="background: white; padding: 12px; border-radius: 8px; margin-top: 10px;">';
                        expertHtml += '<div style="font-size: 12px; color: #ff9800; font-weight: 600; margin-bottom: 8px;">ğŸ’¡ æ”¹è¿›è¯æœ¯å»ºè®®</div>';

                        // æ ¹æ®ä¸åŒçš„æ¢éœ€ç»´åº¦ç”Ÿæˆè¯æœ¯
                        const improvementScripts = generateImprovementScripts(w.id, w.question);
                        improvementScripts.forEach((script, idx) => {
                            expertHtml += `<div style="font-size: 12px; color: #666; line-height: 1.8; margin-bottom: ${idx === improvementScripts.length - 1 ? '0' : '8px'}; padding-left: 12px; position: relative;">`;
                            expertHtml += `<span style="position: absolute; left: 0; color: #ff9800; font-weight: bold;">${idx + 1}.</span>`;
                            expertHtml += script;
                            expertHtml += '</div>';
                        });

                        expertHtml += '</div>';
                        expertHtml += '</div>';
                    });
                } else {
                    expertHtml += '<div style="padding: 15px; text-align: center; color: #4caf50; font-size: 13px; background: #f1f8f4; border-radius: 8px; margin-bottom: 15px;">';
                    expertHtml += 'âœ“ è¯¥ä¸“å®¶æ¢éœ€å®Œæˆåº¦è‰¯å¥½ï¼Œæ— æ˜æ˜¾è–„å¼±é¡¹';
                    expertHtml += '</div>';
                }

                // å®¢æˆ·åˆ—è¡¨
                expertHtml += '<h4 style="font-size: 14px; color: #333; margin: 20px 0 12px; font-weight: 600;">ğŸ‘¥ å®¢æˆ·è¯¦æƒ…</h4>';
                expertHtml += '<table class="customer-table">';
                expertHtml += '<thead><tr><th>å®¢æˆ·å§“å</th><th>å•†æœºç­‰çº§</th><th>æ¢éœ€å®Œæˆåº¦</th><th>æ¢éœ€ä¸åˆ°ä½é¡¹</th></tr></thead>';
                expertHtml += '<tbody>';
                customers.forEach(c => {
                    const issues = c.probeResult.filter(p => p.status === 'incomplete' || p.status === 'partial');
                    expertHtml += '<tr>';
                    expertHtml += `<td>${c.customer}</td>`;
                    expertHtml += `<td><span class="level-badge ${c.level}">${c.level}ç±»</span></td>`;
                    expertHtml += `<td>${c.completionRate}% (${c.completeCount}/9)</td>`;
                    expertHtml += '<td>';
                    if (issues.length === 0) {
                        expertHtml += '<span style="color: #4caf50; font-size: 12px;">âœ“ æ¢éœ€å®Œæ•´</span>';
                    } else {
                        issues.forEach(issue => {
                            const badgeClass = issue.status === 'incomplete' ? 'critical' : 'warning';
                            expertHtml += `<span class="issue-badge ${badgeClass}">${issue.label.split('.')[1].trim()}</span>`;
                        });
                    }
                    expertHtml += '</td>';
                    expertHtml += '</tr>';
                });
                expertHtml += '</tbody></table>';

                expertHtml += '</div>'; // å…³é—­ expert-details
                expertHtml += '</div>'; // å…³é—­ expert-card
            });

            document.getElementById('expertList').innerHTML = expertHtml;
        }

        // ç»˜åˆ¶ä¸“å®¶æ¢éœ€èƒ½åŠ›é›·è¾¾å›¾
        function drawExpertRadarChart(canvasId, expertName, probeData) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;

            // æ£€æŸ¥æ˜¯å¦å·²ç»ç»˜åˆ¶è¿‡ï¼Œé¿å…é‡å¤ç»˜åˆ¶
            if (canvas.dataset.drawn === 'true') return;
            canvas.dataset.drawn = 'true';

            const ctx = canvas.getContext('2d');

            // å‡†å¤‡æ•°æ®
            const labels = probeData.map(d => d.label);
            const data = probeData.map(d => d.rate);

            // åˆ›å»ºé›·è¾¾å›¾
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `${expertName} - æ¢éœ€å®Œæˆåº¦`,
                        data: data,
                        backgroundColor: 'rgba(102, 126, 234, 0.2)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(102, 126, 234, 1)',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        r: {
                            beginAtZero: true,
                            min: 0,
                            max: 100,
                            ticks: {
                                stepSize: 20,
                                callback: function(value) {
                                    return value + '%';
                                },
                                font: {
                                    size: 11
                                }
                            },
                            pointLabels: {
                                font: {
                                    size: 12,
                                    weight: '600'
                                },
                                color: '#333'
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            },
                            angleLines: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom',
                            labels: {
                                font: {
                                    size: 12
                                },
                                padding: 15
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.r.toFixed(1) + '%';
                                }
                            }
                        }
                    }
                }
            });
        }

        // ç”Ÿæˆæ¢éœ€æ”¹è¿›è¯æœ¯å»ºè®®ï¼ˆæ ¹æ®å…·ä½“æ¢éœ€ç»´åº¦ï¼‰
        function generateImprovementScripts(probeId, question) {
            const scripts = {
                'energy_intention': [
                    'æ‚¨è¿™è¾¹æ˜¯æ‰“ç®—ä¹°å¢ç¨‹è¿˜æ˜¯çº¯ç”µå‘¢ï¼Ÿå¢ç¨‹çš„è¯æ²¡æœ‰ç»­èˆªç„¦è™‘ï¼Œçº¯ç”µçš„è¯ç”¨è½¦æˆæœ¬æ›´ä½ï¼Œå„æœ‰ä¼˜åŠ¿',
                    'å’±ä»¬ç†æƒ³æœ‰å¢ç¨‹å’Œçº¯ç”µä¸¤ç§ï¼Œæ‚¨å¹³æ—¶ç”¨è½¦æ˜¯å¸‚åŒºå¤šè¿˜æ˜¯ç»å¸¸è·‘é•¿é€”ï¼Ÿè¿™æ ·æˆ‘èƒ½å¸®æ‚¨æ¨èæ›´åˆé€‚çš„èƒ½æºå½¢å¼'
                ],
                'current_car': [
                    'æ‚¨ç°åœ¨å¼€çš„ä»€ä¹ˆè½¦å‘€ï¼Ÿæ˜¯æ‰“ç®—ç½®æ¢è¿˜æ˜¯å¢è´­ç¬¬äºŒè¾†è½¦å‘¢ï¼Ÿäº†è§£ä¸€ä¸‹èƒ½æ›´å¥½åœ°ç»™æ‚¨æ¨è',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨ç›®å‰çš„ç”¨è½¦æƒ…å†µï¼Œå®¶é‡Œç°åœ¨æœ‰è½¦å—ï¼Ÿæ˜¯ä»€ä¹ˆå“ç‰Œçš„ï¼Ÿæ‰“ç®—å–æ‰æ¢æ–°è½¦è¿˜æ˜¯å†ä¹°ä¸€è¾†ï¼Ÿ'
                ],
                'usage_scenario': [
                    'æ‚¨å¹³æ—¶ä¸»è¦ç”¨è½¦æ˜¯ä¸Šä¸‹ç­é€šå‹¤ï¼Œè¿˜æ˜¯å‘¨æœ«å¸¦å®¶äººå‡ºå»ç©æ¯”è¾ƒå¤šï¼Ÿ',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨çš„ç”¨è½¦åœºæ™¯ï¼Œæ˜¯å¸‚åŒºä¸ºä¸»è¿˜æ˜¯ç»å¸¸è·‘é•¿é€”ï¼Ÿæœ‰æ²¡æœ‰æ¥é€å­©å­ã€è‡ªé©¾æ¸¸è¿™äº›éœ€æ±‚ï¼Ÿ'
                ],
                'budget': [
                    'æ‚¨è¿™è¾¹è´­è½¦é¢„ç®—å¤§æ¦‚åœ¨ä»€ä¹ˆèŒƒå›´å‘¢ï¼Ÿè¿™æ ·æˆ‘èƒ½ç»™æ‚¨æ¨èæœ€åˆé€‚çš„è½¦å‹é…ç½®',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨çš„é¢„ç®—åŒºé—´ï¼Œå¤§æ¦‚å¤šå°‘ä¸‡å·¦å³ï¼Ÿå’±ä»¬ç†æƒ³æœ‰ä¸åŒä»·ä½çš„è½¦å‹å¯ä»¥é€‰æ‹©'
                ],
                'family_structure': [
                    'æ‚¨å®¶é‡Œå‡ å£äººå‘€ï¼Ÿæœ‰è€äººå’Œå­©å­å—ï¼Ÿè¿™ä¸ªå¯¹é€‰5åº§è¿˜æ˜¯6åº§è½¦å‹å¾ˆé‡è¦',
                    'äº†è§£ä¸€ä¸‹æ‚¨çš„å®¶åº­æƒ…å†µï¼Œå¹³æ—¶ç”¨è½¦ä¸»è¦æ˜¯å‡ ä¸ªäººï¼Ÿæœ‰æ²¡æœ‰å¸¦è€äººå­©å­å‡ºè¡Œçš„éœ€æ±‚ï¼Ÿ'
                ],
                'decision_maker': [
                    'è¿™æ¬¡ä¹°è½¦ä¸»è¦æ˜¯æ‚¨è‡ªå·±å†³å®šï¼Œè¿˜æ˜¯éœ€è¦å’Œå®¶äººå•†é‡ä¸€ä¸‹ï¼Ÿæˆ‘å¥½å®‰æ’åç»­çš„è¯•é©¾å’Œè®²è§£',
                    'æƒ³ç¡®è®¤ä¸€ä¸‹ï¼Œè´­è½¦å†³ç­–æ˜¯æ‚¨ä¸€ä¸ªäººåšä¸»ï¼Œè¿˜æ˜¯éœ€è¦çˆ±äººæˆ–è€…çˆ¶æ¯ä¸€èµ·å‚ä¸ï¼Ÿå’±ä»¬å¯ä»¥ä¸€èµ·çº¦ä¸ªæ—¶é—´è¯¦ç»†èŠèŠ'
                ],
                'key_features': [
                    'æ‚¨ä¹°è½¦æœ€çœ‹é‡å“ªäº›æ–¹é¢å‘¢ï¼Ÿæ˜¯ç»­èˆªã€æ™ºèƒ½é©¾é©¶ã€ç©ºé—´èˆ’é€‚æ€§ï¼Œè¿˜æ˜¯å®‰å…¨é…ç½®ï¼Ÿ',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨æœ€å…³æ³¨çš„åŠŸèƒ½ç‚¹ï¼Œæ¯”å¦‚ç»­èˆªé‡Œç¨‹ã€æ™ºèƒ½é©¾é©¶ã€ç©ºé—´å¤§å°ã€å……ç”µé€Ÿåº¦è¿™äº›ï¼Œæ‚¨ä¼˜å…ˆè€ƒè™‘å“ªäº›ï¼Ÿ'
                ],
                'competitor_comparison': [
                    'æ‚¨æœ€è¿‘è¿˜åœ¨çœ‹å“ªäº›å“ç‰Œçš„è½¦å‘€ï¼Ÿè”šæ¥ã€å°é¹ã€é—®ç•Œè¿™äº›æœ‰åœ¨å¯¹æ¯”å—ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹å·®å¼‚',
                    'é™¤äº†å’±ä»¬ç†æƒ³ï¼Œæ‚¨è¿˜æœ‰åœ¨çœ‹å…¶ä»–å“ç‰Œå—ï¼Ÿäº†è§£ä¸€ä¸‹èƒ½å¸®æ‚¨åšæ›´å‡†ç¡®çš„å¯¹æ¯”åˆ†æ'
                ],
                'purchase_timing': [
                    'æ‚¨è¿™è¾¹è®¡åˆ’ä»€ä¹ˆæ—¶å€™ç”¨ä¸Šè½¦å‘¢ï¼Ÿæ˜¯æ¯”è¾ƒæ€¥è¿˜æ˜¯å¯ä»¥å†çœ‹çœ‹ï¼Ÿäº†è§£ä¸€ä¸‹å¥½ç»™æ‚¨å®‰æ’è¯•é©¾å’Œäº¤ä»˜',
                    'æƒ³ç¡®è®¤ä¸€ä¸‹æ‚¨çš„è´­è½¦æ—¶é—´ï¼Œæ˜¯è¿‘æœŸå°±è¦ï¼Œè¿˜æ˜¯3ä¸ªæœˆã€åŠå¹´å†…ï¼Ÿè¿™æ ·æˆ‘èƒ½å¸®æ‚¨è§„åˆ’å¥½è¯•é©¾å’Œè®¢è½¦èŠ‚å¥'
                ]
            };

            return scripts[probeId] || [
                'å»ºè®®å¤šè¯¢é—®å®¢æˆ·å…·ä½“éœ€æ±‚ï¼Œäº†è§£æ›´å¤šç»†èŠ‚ä¿¡æ¯',
                'å¯ä»¥ç”¨å¼€æ”¾å¼é—®é¢˜å¼•å¯¼å®¢æˆ·ï¼Œè®©å®¢æˆ·å¤šè¯´è¯´è‡ªå·±çš„æƒ³æ³•å’Œé¡¾è™‘'
            ];
        }

        // åˆ‡æ¢ä¸“å®¶è¯¦æƒ…æ˜¾ç¤º/éšè—
        function toggleExpertDetails(expertId) {
            const detailsDiv = document.getElementById(expertId);
            const icon = document.getElementById(expertId + '-icon');

            if (detailsDiv.classList.contains('show')) {
                detailsDiv.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                detailsDiv.classList.add('show');
                icon.classList.add('expanded');

                // å±•å¼€æ—¶ç»˜åˆ¶é›·è¾¾å›¾
                const expertData = expertRadarDataGlobal[expertId];
                if (expertData) {
                    // å»¶è¿Ÿç»˜åˆ¶ï¼Œç¡®ä¿DOMå·²å®Œå…¨å±•ç¤º
                    setTimeout(() => {
                        drawExpertRadarChart(expertData.radarChartId, expertData.expertName, expertData.data);
                    }, 50);
                }
            }
        }
    </script>
</body>
</html>