<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½å®¢æˆ·ç®¡ç†ç³»ç»Ÿ v2.0 - CELNæ¨¡å‹ + æ¢éœ€ä¹é—®</title>
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 20px;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            font-size: 14px;
            opacity: 0.95;
        }

        /* è§’è‰²åˆ‡æ¢å™¨ */
        .role-switcher {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 25px;
        }

        .role-btn {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 25px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .role-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.6);
            transform: translateY(-2px);
        }

        .role-btn.active {
            background: white;
            color: #667eea;
            border-color: white;
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.3);
        }

        /* é¡µé¢å®¹å™¨ */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 500px 1fr;
            gap: 20px;
            align-items: start;
        }

        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .card h2 {
            font-size: 20px;
            color: #333;
            margin-bottom: 18px;
            display: flex;
            align-items: center;
            font-weight: 600;
        }

        .card h2::before {
            content: '';
            width: 4px;
            height: 22px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin-right: 10px;
            border-radius: 2px;
        }

        .input-section {
            position: sticky;
            top: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-size: 13px;
            color: #666;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 14px;
            line-height: 1.6;
            font-family: inherit;
            resize: vertical;
            min-height: 260px;
            transition: all 0.3s;
        }

        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .hint {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.5;
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #f5f5f5;
            color: #666;
            box-shadow: none;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: #e8e8e8;
            box-shadow: none;
        }

        .result-section {
            margin-bottom: 20px;
        }

        .result-section h3 {
            font-size: 17px;
            color: #333;
            margin-bottom: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        /* CELNæ ‡ç­¾ */
        .celn-tags {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 18px;
        }

        .celn-tag {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 14px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.3s;
        }

        .celn-tag:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .celn-tag .dimension {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 4px;
        }

        .celn-tag .name {
            font-size: 11px;
            color: #666;
            margin-bottom: 6px;
        }

        .celn-tag .value {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .celn-tag.high {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .celn-tag.high .dimension,
        .celn-tag.high .name,
        .celn-tag.high .value {
            color: white;
        }

        .celn-tag.medium {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .celn-tag.medium .dimension,
        .celn-tag.medium .name,
        .celn-tag.medium .value {
            color: white;
        }

        /* æ¢éœ€ä¹é—® + å…³é”®è¯ç»“åˆå±•ç¤º */
        .probe-grid {
            display: grid;
            gap: 10px;
        }

        .probe-item {
            background: #f8f9fa;
            padding: 12px 14px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .probe-item.incomplete {
            border-left-color: #ff6b6b;
            background: #fff5f5;
        }

        .probe-item.partial {
            border-left-color: #ffa500;
            background: #fff8e6;
        }

        .probe-item .question-label {
            font-size: 13px;
            color: #667eea;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .probe-item.incomplete .question-label {
            color: #ff6b6b;
        }

        .probe-item.partial .question-label {
            color: #ffa500;
        }

        .probe-item .answer {
            font-size: 13px;
            color: #333;
            line-height: 1.5;
            flex: 1;
        }

        .probe-item .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            white-space: nowrap;
            margin-left: 10px;
        }

        .probe-item .status-badge.complete {
            background: #d4edda;
            color: #155724;
        }

        .probe-item .status-badge.incomplete {
            background: #f8d7da;
            color: #721c24;
        }

        .probe-item .status-badge.partial {
            background: #fff3cd;
            color: #856404;
        }

        /* è¯æœ¯æ¨è */
        .script-box {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .script-box h4 {
            font-size: 15px;
            color: #333;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .script-box p {
            font-size: 13px;
            color: #333;
            line-height: 1.8;
        }

        .script-box.probing {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }

        .script-box.closing {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .script-box.objection_handling {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
        }

        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: #999;
        }

        .empty-state .icon {
            font-size: 56px;
            margin-bottom: 14px;
        }

        .empty-state p {
            font-size: 14px;
        }

        .key-points {
            background: #f0f7ff;
            padding: 14px;
            border-radius: 10px;
            margin-top: 14px;
        }

        .key-points h4 {
            font-size: 13px;
            color: #667eea;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .key-points ul {
            list-style: none;
            padding: 0;
        }

        .key-points li {
            font-size: 12px;
            color: #333;
            line-height: 1.8;
            padding-left: 16px;
            position: relative;
        }

        .key-points li::before {
            content: 'âœ“';
            position: absolute;
            left: 0;
            color: #667eea;
            font-weight: bold;
        }

        .example-box {
            background: #fff9e6;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 14px;
            border-left: 3px solid #faad14;
        }

        .example-box .title {
            font-size: 12px;
            color: #faad14;
            font-weight: 600;
            margin-bottom: 6px;
        }

        .example-box .content {
            font-size: 12px;
            color: #666;
            line-height: 1.6;
        }

        /* åº—é•¿é¡µé¢æ ·å¼ */
        .upload-area {
            border: 2px dashed #667eea;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            background: #f8f9ff;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 25px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.drag-over {
            border-color: #764ba2;
            background: #e8ebff;
        }

        .upload-area .icon {
            font-size: 48px;
            margin-bottom: 12px;
        }

        .upload-area p {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .upload-area .hint {
            font-size: 12px;
            color: #999;
        }

        input[type="file"] {
            display: none;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            text-align: center;
        }

        .stat-card h3 {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 6px;
        }

        .stat-card .subtext {
            font-size: 12px;
            color: #999;
        }

        /* æ¢éœ€å®Œæˆåº¦æ¡ */
        .probe-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .probe-bar .label {
            font-size: 12px;
            color: #666;
            min-width: 120px;
        }

        .probe-bar .bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .probe-bar .bar-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
        }

        .probe-bar .bar-fill.low {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        }

        .probe-bar .bar-fill.medium {
            background: linear-gradient(135deg, #ffa500 0%, #ff8c00 100%);
        }

        .probe-bar .percentage {
            font-size: 11px;
            color: white;
            font-weight: 600;
        }

        /* ä¸“å®¶åˆ—è¡¨ */
        .expert-list {
            display: grid;
            gap: 20px;
        }

        .expert-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        }

        .expert-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .expert-header:hover {
            background: #f8f9ff;
            margin: -5px -10px 15px -10px;
            padding: 5px 10px 20px 10px;
            border-radius: 8px;
        }

        .expert-name {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .expand-icon {
            font-size: 14px;
            color: #667eea;
            transition: transform 0.3s;
        }

        .expand-icon.expanded {
            transform: rotate(90deg);
        }

        .expert-stats {
            display: flex;
            gap: 20px;
            font-size: 13px;
            color: #666;
        }

        .expert-stats span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .expert-details {
            display: none;
            animation: slideDown 0.3s ease-out;
        }

        .expert-details.show {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .weakness-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-bottom: 15px;
        }

        .weakness-item {
            background: #fff5f5;
            padding: 10px;
            border-radius: 8px;
            border-left: 3px solid #ff6b6b;
            font-size: 12px;
        }

        .weakness-item .label {
            color: #d32f2f;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .weakness-item .count {
            color: #666;
            font-size: 11px;
        }

        .customer-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        .customer-table th {
            background: #f8f9fa;
            padding: 10px;
            text-align: left;
            font-size: 12px;
            color: #666;
            font-weight: 600;
            border-bottom: 2px solid #e8e8e8;
        }

        .customer-table td {
            padding: 10px;
            font-size: 12px;
            color: #333;
            border-bottom: 1px solid #f0f0f0;
        }

        .customer-table tr:hover {
            background: #f8f9ff;
        }

        .issue-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .issue-badge.critical {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .issue-badge.warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .level-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .level-badge.A {
            background: #ffe5e5;
            color: #d32f2f;
        }

        .level-badge.B {
            background: #fff3e0;
            color: #f57c00;
        }

        .level-badge.C {
            background: #e3f2fd;
            color: #1976d2;
        }

        .level-badge.FC {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .level-badge.é•¿æœŸ {
            background: #e8f5e9;
            color: #388e3c;
        }

        .level-badge.å·²æˆ˜è´¥ {
            background: #fafafa;
            color: #757575;
        }

        .level-badge.å·²é”å• {
            background: #fff9c4;
            color: #f57f17;
        }

        .level-badge.å…¶ä»– {
            background: #f5f5f5;
            color: #616161;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .input-section {
                position: relative;
                top: 0;
            }

            .celn-tags {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— æ™ºèƒ½å®¢æˆ·ç®¡ç†ç³»ç»Ÿ v2.0</h1>
            <p>åŸºäºCELNæ¨¡å‹ + æ¢éœ€ä¹é—®çš„æ™ºèƒ½å®¢æˆ·ç”»åƒåˆ†æç³»ç»Ÿ</p>
        </div>

        <!-- è§’è‰²åˆ‡æ¢å™¨ -->
        <div class="role-switcher">
            <button class="role-btn active" onclick="switchRole('expert')">
                ğŸ¯ ä¸“å®¶è§†å›¾
            </button>
            <button class="role-btn" onclick="switchRole('manager')">
                ğŸ“Š åº—é•¿è§†å›¾
            </button>
        </div>

        <!-- ä¸“å®¶è§†å›¾ -->
        <div id="expertPage" class="page active">
            <div class="main-grid">
                <!-- å·¦ä¾§ï¼šè¾“å…¥åŒºåŸŸ -->
                <div class="input-section">
                    <div class="card">
                        <h2>å®¢æˆ·ä¿¡æ¯å½•å…¥</h2>

                        <div class="example-box">
                            <div class="title">ğŸ’¡ è¾“å…¥æç¤º</div>
                            <div class="content">
                                è¯·ç”¨è‡ªç„¶è¯­è¨€æè¿°å®¢æˆ·ï¼ŒåŒ…å«ï¼šèƒ½æºå½¢å¼ã€ç”¨è½¦æƒ…å†µã€ç”¨è½¦åœºæ™¯ã€è´­è½¦é¢„ç®—ã€å®¶åº­ç»“æ„ã€å†³ç­–äººã€å…³æ³¨åŠŸèƒ½ã€ç«å“å¯¹æ¯”ã€è´­ä¹°æ—¶é—´ç­‰ä¿¡æ¯
                            </div>
                        </div>

                        <div class="form-group">
                            <label style="display: flex; justify-content: space-between; align-items: center;">
                                <span>å®¢æˆ·æè¿°ï¼ˆè‡ªç„¶è¯­è¨€è¾“å…¥ï¼‰</span>
                            </label>
                            <textarea id="customerInput" placeholder="ä¾‹å¦‚ï¼š

å®¢æˆ·æ˜¯ä¸€ä½30å²çš„ç”·æ€§ï¼Œç›®å‰åœ¨ä¸€å®¶äº’è”ç½‘å…¬å¸æ‹…ä»»äº§å“ç»ç†ã€‚ä»–æƒ³ä¹°ä¸€è¾†æ–°èƒ½æºSUVï¼Œé¢„ç®—åœ¨30-35ä¸‡ä¹‹é—´ï¼Œä¸»è¦ç”¨äºå®¶åº­å‡ºè¡Œå’Œå‘¨æœ«å¸¦å­©å­å»éƒŠæ¸¸ã€‚

å†³ç­–äººæ˜¯ä»–æœ¬äººï¼Œä½†éœ€è¦å’Œå¦»å­å•†é‡ã€‚ä»–ç›®å‰åœ¨å¯¹æ¯”ç†æƒ³L7å’Œè”šæ¥ES6è¿™ä¸¤æ¬¾è½¦å‹ï¼Œè®¡åˆ’åœ¨3ä¸ªæœˆå†…å®Œæˆè´­ä¹°ã€‚

ä»–æ¯”è¾ƒå…³æ³¨çš„æ˜¯ç»­èˆªé‡Œç¨‹å’Œæ™ºèƒ½é©¾é©¶åŠŸèƒ½ï¼Œæ‹…å¿ƒæ–°èƒ½æºè½¦åœ¨å†¬å¤©ç»­èˆªä¼šå¤§å¹…ç¼©æ°´ï¼ŒåŒæ—¶ä¹Ÿå…³å¿ƒå……ç”µä¾¿åˆ©æ€§ã€‚

ä»–ä½åœ¨æœé˜³åŒºï¼Œä¹‹å‰åœ¨ä¸‰é‡Œå±¯å’Œæœ›äº¬çš„ç†æƒ³é—¨åº—éƒ½çœ‹è¿‡è½¦ã€‚æ²Ÿé€šè®°å½•ï¼š1.24ç”µè¯æ²Ÿé€šã€1.17åˆ°åº—è¯•é©¾ã€1.10é¦–æ¬¡æ¥è§¦ã€‚ä»–ä¸»è¦é¡¾è™‘è¿˜æ˜¯åœ¨ç«å“å¯¹æ¯”ä¸Šï¼Œå¯¹é‡‘èæ”¿ç­–æ¯”è¾ƒæ•æ„Ÿï¼Œæƒ³äº†è§£ä½æ¯è´·æ¬¾æ–¹æ¡ˆï¼Œæ‰‹ä¸Šæœ‰ä¸€è¾†å®é©¬3ç³»æƒ³ç½®æ¢ã€‚"></textarea>
                            <div class="hint">ğŸ” ç³»ç»Ÿå°†æ™ºèƒ½è¯†åˆ«å…³é”®è¯ï¼Œå¹¶åŸºäºæ¢éœ€ä¹é—®è¿›è¡Œåˆ†æ</div>
                        </div>

                        <button class="btn" onclick="analyzeCustomer()">
                            ğŸ¤– æ™ºèƒ½åˆ†æå®¢æˆ·ç”»åƒ
                        </button>

                        <button class="btn btn-secondary" onclick="fillExample()">
                            ğŸ“ å¡«å……ç¤ºä¾‹æ•°æ®
                        </button>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šåˆ†æç»“æœ -->
                <div class="card">
                    <h2>AIåˆ†æç»“æœ</h2>
                    <div id="resultArea">
                        <div class="empty-state">
                            <div class="icon">ğŸ“Š</div>
                            <p>è¯·åœ¨å·¦ä¾§è¾“å…¥å®¢æˆ·ä¿¡æ¯åç‚¹å‡»"æ™ºèƒ½åˆ†æ"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- åº—é•¿è§†å›¾ -->
        <div id="managerPage" class="page">
            <div class="card">
                <h2>å®¢æˆ·ç®¡ç†Excelå¯¼å…¥</h2>

                <div class="upload-area" id="uploadArea" onclick="document.getElementById('excelFile').click()">
                    <div class="icon">ğŸ“</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å®¢æˆ·ç®¡ç†Excelæ–‡ä»¶</p>
                    <div class="hint">æ”¯æŒ .xlsx / .xls æ ¼å¼ï¼Œéœ€åŒ…å«ï¼šä¸“å®¶å§“åã€å®¢æˆ·å§“åã€å•†æœºç­‰çº§(A/B/C/FC)ã€å®¢æˆ·æè¿°ç­‰å­—æ®µ</div>
                </div>
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="handleFileUpload(event)">

                <div id="managerAnalysis" style="display: none;">
                    <!-- æ•´ä½“ç»Ÿè®¡ -->
                    <h3 style="font-size: 18px; margin-bottom: 15px; color: #333;">ğŸ“ˆ æ•´ä½“å•†æœºç»Ÿè®¡</h3>
                    <div class="stats-grid">
                        <!-- ç»Ÿè®¡å¡ç‰‡å°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>

                    <!-- æ¢éœ€è–„å¼±é¡¹åˆ†æ -->
                    <h3 style="font-size: 18px; margin: 25px 0 15px; color: #333;">âš ï¸ å›¢é˜Ÿæ¢éœ€è–„å¼±é¡¹ TOP5ï¼ˆæŒ‰å®Œæˆåº¦ä»ä½åˆ°é«˜ï¼‰</h3>
                    <div id="weaknessAnalysis"></div>

                    <!-- ä¸“å®¶åˆ—è¡¨ -->
                    <h3 style="font-size: 18px; margin: 25px 0 15px; color: #333;">ğŸ‘¥ å„ä¸“å®¶è¯¦ç»†åˆ†æ</h3>
                    <div id="expertList" class="expert-list"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let managerData = null;

        // å¸‚åœºè½¦å‹ä»·æ ¼åº“ï¼ˆå•ä½ï¼šä¸‡å…ƒï¼‰
        const VEHICLE_PRICE_DB = {
            // ç†æƒ³è½¦å‹
            'L6': { brand: 'ç†æƒ³', price: 25, range: [24, 28] },
            'L7': { brand: 'ç†æƒ³', price: 35, range: [33, 38] },
            'L8': { brand: 'ç†æƒ³', price: 40, range: [40, 50] },
            'L9': { brand: 'ç†æƒ³', price: 50, range: [45, 55] },
            'MEGA': { brand: 'ç†æƒ³', price: 56, range: [55, 60] },
            'i6': { brand: 'ç†æƒ³', price: 27, range: [25, 30] },
            'i8': { brand: 'ç†æƒ³', price: 41, range: [36, 46] },

            // è”šæ¥
            'ES6': { brand: 'è”šæ¥', price: 35, range: [35, 44] },
            'ES7': { brand: 'è”šæ¥', price: 43, range: [42, 52] },
            'ES8': { brand: 'è”šæ¥', price: 50, range: [49, 59] },
            'ET5': { brand: 'è”šæ¥', price: 30, range: [29, 35] },
            'ET7': { brand: 'è”šæ¥', price: 43, range: [42, 52] },
            'EC6': { brand: 'è”šæ¥', price: 36, range: [35, 44] },

            // å°é¹
            'G6': { brand: 'å°é¹', price: 23, range: [20, 28] },
            'G9': { brand: 'å°é¹', price: 30, range: [26, 40] },
            'P7': { brand: 'å°é¹', price: 25, range: [23, 33] },
            'X9': { brand: 'å°é¹', price: 36, range: [36, 42] },

            // é—®ç•Œ
            'M5': { brand: 'é—®ç•Œ', price: 26, range: [25, 30] },
            'M7': { brand: 'é—®ç•Œ', price: 28, range: [25, 35] },
            'M9': { brand: 'é—®ç•Œ', price: 47, range: [47, 57] },

            // ç‰¹æ–¯æ‹‰
            'Model 3': { brand: 'ç‰¹æ–¯æ‹‰', price: 26, range: [23, 34] },
            'Model Y': { brand: 'ç‰¹æ–¯æ‹‰', price: 28, range: [25, 36] },
            'Model S': { brand: 'ç‰¹æ–¯æ‹‰', price: 70, range: [70, 85] },
            'Model X': { brand: 'ç‰¹æ–¯æ‹‰', price: 75, range: [75, 90] },

            // æ¯”äºšè¿ª
            'æ±‰': { brand: 'æ¯”äºšè¿ª', price: 22, range: [18, 32] },
            'å”': { brand: 'æ¯”äºšè¿ª', price: 23, range: [20, 33] },
            'æµ·è±¹': { brand: 'æ¯”äºšè¿ª', price: 22, range: [18, 28] },
            'ä»°æœ›U8': { brand: 'æ¯”äºšè¿ª', price: 110, range: [110, 120] },

            // è…¾åŠ¿
            'D9': { brand: 'è…¾åŠ¿', price: 37, range: [34, 47] },
            'N7': { brand: 'è…¾åŠ¿', price: 30, range: [30, 38] },
            'N8': { brand: 'è…¾åŠ¿', price: 32, range: [32, 40] },

            // ææ°ª
            '001': { brand: 'ææ°ª', price: 30, range: [27, 38] },
            '009': { brand: 'ææ°ª', price: 50, range: [50, 59] },
            'X': { brand: 'ææ°ª', price: 30, range: [30, 38] },

            // ä¼ ç»Ÿè±ªåå“ç‰Œ
            'GL8': { brand: 'åˆ«å…‹', price: 28, range: [23, 53] },
            'åŸƒå°”æ³•': { brand: 'ä¸°ç”°', price: 85, range: [82, 92] },
            'Vçº§': { brand: 'å¥”é©°', price: 50, range: [48, 65] },
            'Q5': { brand: 'å¥¥è¿ª', price: 41, range: [39, 50] },
            'Q7': { brand: 'å¥¥è¿ª', price: 70, range: [69, 86] },
            '3ç³»': { brand: 'å®é©¬', price: 32, range: [30, 40] },
            '5ç³»': { brand: 'å®é©¬', price: 44, range: [43, 66] },
            'X3': { brand: 'å®é©¬', price: 40, range: [39, 48] },
            'X5': { brand: 'å®é©¬', price: 62, range: [60, 85] },
            'GLC': { brand: 'å¥”é©°', price: 42, range: [40, 50] },
            'GLE': { brand: 'å¥”é©°', price: 71, range: [70, 90] }
        };

        // è½¦å‹åç§°çš„å„ç§å˜ä½“ï¼ˆç”¨äºæ¨¡ç³ŠåŒ¹é…ï¼‰
        const VEHICLE_ALIASES = {
            'model3': 'Model 3',
            'modely': 'Model Y',
            'models': 'Model S',
            'modelx': 'Model X',
            'gl8': 'GL8',
            'q5': 'Q5',
            'q7': 'Q7',
            'x3': 'X3',
            'x5': 'X5',
            'es6': 'ES6',
            'es7': 'ES7',
            'es8': 'ES8',
            'et5': 'ET5',
            'et7': 'ET7',
            'ec6': 'EC6',
            'g6': 'G6',
            'g9': 'G9',
            'p7': 'P7',
            'x9': 'X9',
            'm5': 'M5',
            'm7': 'M7',
            'm9': 'M9',
            'd9': 'D9',
            'n7': 'N7',
            'n8': 'N8',
            'l6': 'L6',
            'l7': 'L7',
            'l8': 'L8',
            'l9': 'L9',
            'i6': 'i6',
            'i8': 'i8',
            'ææ°ª001': '001',
            'ææ°ª009': '009',
            'ææ°ªX': 'X',
            'ä»°æœ›u8': 'ä»°æœ›U8',
            'u8': 'ä»°æœ›U8'
        };

        // æå–æ—¥æœŸï¼ˆæ”¯æŒå¤šç§æ ¼å¼ï¼‰
        function extractDates(text) {
            const dates = new Set();
            const currentYear = new Date().getFullYear();
            const currentMonth = new Date().getMonth() + 1;

            // æ ¼å¼1: 0126, 1226 (MMDD)
            const pattern1 = /(\d{4})(?![.\-å¹´æœˆ])/g;
            let match;
            while ((match = pattern1.exec(text)) !== null) {
                const str = match[1];
                const month = parseInt(str.substring(0, 2));
                const day = parseInt(str.substring(2, 4));
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    // åˆ¤æ–­å¹´ä»½ï¼šå¦‚æœæœˆä»½>å½“å‰æœˆä»½ï¼Œè¯´æ˜æ˜¯å»å¹´çš„
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            // æ ¼å¼2: 1-26, 12-26 (M-DD æˆ– MM-DD)
            const pattern2 = /(\d{1,2})-(\d{1,2})(?![å¹´æœˆ])/g;
            while ((match = pattern2.exec(text)) !== null) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            // æ ¼å¼3: 1.26, 12.26 (M.DD æˆ– MM.DD)
            const pattern3 = /(\d{1,2})\.(\d{1,2})(?![å¹´æœˆ])/g;
            while ((match = pattern3.exec(text)) !== null) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            // æ ¼å¼4: 1æœˆ26æ—¥, 12æœˆ26æ—¥
            const pattern4 = /(\d{1,2})æœˆ(\d{1,2})[æ—¥å·]/g;
            while ((match = pattern4.exec(text)) !== null) {
                const month = parseInt(match[1]);
                const day = parseInt(match[2]);
                if (month >= 1 && month <= 12 && day >= 1 && day <= 31) {
                    const year = month > currentMonth ? currentYear - 1 : currentYear;
                    dates.add(`${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`);
                }
            }

            return Array.from(dates).sort();
        }

        // è¯†åˆ«è½¦å‹ï¼ˆåŒ…æ‹¬æ¨¡ç³ŠåŒ¹é…å’Œä¸Šä¸‹æ–‡ç†è§£ï¼‰
        function extractVehicles(text) {
            const found = new Set();
            const textLower = text.toLowerCase().replace(/\s+/g, '');

            // å“ç‰Œå…³é”®è¯æ˜ å°„ï¼ˆç”¨äºä¸Šä¸‹æ–‡æ¨æ–­ï¼‰
            const brandKeywords = {
                'é—®ç•Œ': ['é—®ç•Œ', 'aito'],
                'è”šæ¥': ['è”šæ¥', 'nio'],
                'å°é¹': ['å°é¹', 'xpeng'],
                'ç†æƒ³': ['ç†æƒ³', 'li'],
                'ç‰¹æ–¯æ‹‰': ['ç‰¹æ–¯æ‹‰', 'tesla'],
                'æ¯”äºšè¿ª': ['æ¯”äºšè¿ª', 'byd'],
                'è…¾åŠ¿': ['è…¾åŠ¿', 'denza'],
                'ææ°ª': ['ææ°ª', 'zeekr'],
                'å¥”é©°': ['å¥”é©°', 'benz', 'mercedes'],
                'å®é©¬': ['å®é©¬', 'bmw'],
                'å¥¥è¿ª': ['å¥¥è¿ª', 'audi'],
                'åˆ«å…‹': ['åˆ«å…‹', 'buick'],
                'ä¸°ç”°': ['ä¸°ç”°', 'toyota']
            };

            // å…ˆæ£€æµ‹æ–‡æœ¬ä¸­å‡ºç°çš„å“ç‰Œ
            const detectedBrands = [];
            for (const [brand, keywords] of Object.entries(brandKeywords)) {
                for (const keyword of keywords) {
                    if (textLower.includes(keyword.toLowerCase())) {
                        detectedBrands.push(brand);
                        break;
                    }
                }
            }

            // ä¸Šä¸‹æ–‡ç›¸å…³çš„æ¨¡ç³Šè½¦å‹åŒ¹é…ï¼ˆå¦‚M8ã€M7ç­‰ï¼‰
            const ambiguousModels = {
                'm8': ['é—®ç•Œ', 'å®é©¬'],
                'm7': ['é—®ç•Œ', 'å®é©¬'],
                'm5': ['é—®ç•Œ', 'å®é©¬'],
                'm9': ['é—®ç•Œ'],
                'l6': ['ç†æƒ³'],
                'l7': ['ç†æƒ³'],
                'l8': ['ç†æƒ³'],
                'l9': ['ç†æƒ³'],
                'i6': ['ç†æƒ³'],
                'i8': ['ç†æƒ³', 'å®é©¬'],
                'es6': ['è”šæ¥'],
                'es7': ['è”šæ¥'],
                'es8': ['è”šæ¥'],
                'et5': ['è”šæ¥'],
                'et7': ['è”šæ¥'],
                'g6': ['å°é¹'],
                'g9': ['å°é¹'],
                'p7': ['å°é¹'],
                'x9': ['å°é¹'],
                'd9': ['è…¾åŠ¿']
            };

            // å¯¹äºæ¨¡ç³Šè½¦å‹ï¼Œæ ¹æ®ä¸Šä¸‹æ–‡æ¨æ–­å“ç‰Œ
            for (const [modelKey, possibleBrands] of Object.entries(ambiguousModels)) {
                if (textLower.includes(modelKey)) {
                    // å¦‚æœä¸Šä¸‹æ–‡ä¸­æœ‰æ˜ç¡®å“ç‰Œï¼Œä½¿ç”¨è¯¥å“ç‰Œ
                    const matchedBrand = possibleBrands.find(brand => detectedBrands.includes(brand));
                    if (matchedBrand) {
                        // æŸ¥æ‰¾è¯¥å“ç‰Œä¸‹çš„åŒ¹é…è½¦å‹
                        for (const [model, info] of Object.entries(VEHICLE_PRICE_DB)) {
                            if (info.brand === matchedBrand && model.toLowerCase() === modelKey) {
                                found.add(model);
                            }
                        }
                    } else {
                        // å¦‚æœæ²¡æœ‰æ˜ç¡®å“ç‰Œï¼Œé»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªå¯èƒ½çš„å“ç‰Œ
                        const defaultBrand = possibleBrands[0];
                        for (const [model, info] of Object.entries(VEHICLE_PRICE_DB)) {
                            if (info.brand === defaultBrand && model.toLowerCase() === modelKey) {
                                found.add(model);
                            }
                        }
                    }
                }
            }

            // åˆ«ååŒ¹é…
            for (const [alias, standard] of Object.entries(VEHICLE_ALIASES)) {
                if (textLower.includes(alias.toLowerCase())) {
                    found.add(standard);
                }
            }

            // ç›´æ¥åŒ¹é…è½¦å‹åº“ä¸­çš„å®Œæ•´åç§°
            for (const model of Object.keys(VEHICLE_PRICE_DB)) {
                const modelLower = model.toLowerCase().replace(/\s+/g, '');
                if (textLower.includes(modelLower)) {
                    found.add(model);
                }
            }

            return Array.from(found);
        }

        // æ ¹æ®è½¦å‹æ¨æ–­é¢„ç®—åŒºé—´
        function estimateBudgetFromVehicles(vehicles) {
            if (vehicles.length === 0) return null;

            const prices = vehicles.map(v => VEHICLE_PRICE_DB[v]).filter(p => p);
            if (prices.length === 0) return null;

            // å–æ‰€æœ‰è½¦å‹ä»·æ ¼çš„æœ€å°å€¼å’Œæœ€å¤§å€¼ä½œä¸ºé¢„ç®—åŒºé—´
            const minPrice = Math.min(...prices.map(p => p.range[0]));
            const maxPrice = Math.max(...prices.map(p => p.range[1]));

            return {
                min: minPrice,
                max: maxPrice,
                avg: Math.round((minPrice + maxPrice) / 2)
            };
        }

        // è§’è‰²åˆ‡æ¢
        function switchRole(role) {
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.role-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // åˆ‡æ¢é¡µé¢
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            if (role === 'expert') {
                document.getElementById('expertPage').classList.add('active');
            } else if (role === 'manager') {
                document.getElementById('managerPage').classList.add('active');
            }
        }

        // æ¢éœ€ä¹é—®é…ç½®
        const NINE_QUESTIONS = [
            {
                id: 'energy_intention',
                label: '1. èƒ½æºå½¢å¼-è´­è½¦æ„å‘',
                question: 'æ‰“ç®—ä¹°å¢ç¨‹è¿˜æ˜¯çº¯ç”µï¼Ÿ',
                keywords: ['å¢ç¨‹', 'çº¯ç”µ', 'æ–°èƒ½æº', 'ç”µåŠ¨'],
                extract: (text) => {
                    if (text.includes('å¢ç¨‹')) return { answer: 'å¢ç¨‹', status: 'complete' };
                    if (text.includes('çº¯ç”µ')) return { answer: 'çº¯ç”µ', status: 'complete' };
                    if (text.includes('æ–°èƒ½æº') || text.includes('ç”µåŠ¨')) return { answer: 'æ–°èƒ½æºï¼ˆæœªæ˜ç¡®å¢ç¨‹/çº¯ç”µï¼‰', status: 'partial' };
                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'current_car',
                label: '2. ç”¨è½¦æƒ…å†µ',
                question: 'ç°åœ¨å¼€ä»€ä¹ˆè½¦ï¼Ÿç½®æ¢è¿˜æ˜¯å¢è´­ï¼Ÿ',
                keywords: ['ç½®æ¢', 'å¢è´­', 'æ—§è½¦', 'ç°åœ¨å¼€', 'ç›®å‰å¼€'],
                extract: (text) => {
                    let answer = [];
                    let status = 'incomplete';

                    if (text.includes('ç½®æ¢') || text.includes('ä»¥æ—§æ¢æ–°')) {
                        answer.push('ç½®æ¢');
                        status = 'partial';
                    } else if (text.includes('å¢è´­') || text.includes('ç¬¬äºŒè¾†')) {
                        answer.push('å¢è´­');
                        status = 'partial';
                    }

                    const carBrands = ['å¥”é©°', 'å®é©¬', 'BMW', 'å¥¥è¿ª', 'ç‰¹æ–¯æ‹‰', 'è”šæ¥', 'å°é¹', 'ç†æƒ³', 'æ¯”äºšè¿ª', 'ä¸°ç”°', 'æœ¬ç”°', 'å¤§ä¼—'];
                    const foundBrands = carBrands.filter(brand => text.includes(brand));
                    if (foundBrands.length > 0) {
                        answer.push(`å½“å‰è½¦ï¼š${foundBrands.join('ã€')}`);
                        status = answer.length >= 2 ? 'complete' : 'partial';
                    }

                    return {
                        answer: answer.length > 0 ? answer.join('ï¼Œ') : 'æ¢éœ€ä¸åˆ°ä½',
                        status: answer.length === 0 ? 'incomplete' : status
                    };
                }
            },
            {
                id: 'usage_scenario',
                label: '3. ç”¨è½¦åœºæ™¯',
                question: 'å¸‚å†…é€šå‹¤çŸ­é€”è¿˜æ˜¯é•¿é€”è‡ªé©¾ï¼Ÿ',
                keywords: ['é€šå‹¤', 'ä¸Šä¸‹ç­', 'çŸ­é€”', 'é•¿é€”', 'è‡ªé©¾', 'å¸‚å†…', 'éƒŠæ¸¸', 'æ—…æ¸¸'],
                extract: (text) => {
                    let scenarios = [];
                    if (text.includes('é€šå‹¤') || text.includes('ä¸Šä¸‹ç­')) scenarios.push('é€šå‹¤');
                    if (text.includes('çŸ­é€”') || text.includes('å¸‚å†…')) scenarios.push('å¸‚å†…çŸ­é€”');
                    if (text.includes('é•¿é€”') || text.includes('è‡ªé©¾') || text.includes('æ—…æ¸¸')) scenarios.push('é•¿é€”è‡ªé©¾');
                    if (text.includes('éƒŠæ¸¸') || text.includes('å‘¨æœ«')) scenarios.push('å‘¨æœ«å‡ºæ¸¸');
                    if (text.includes('æ¥é€å­©å­') || text.includes('æ¥å¨ƒ')) scenarios.push('æ¥é€å­©å­');
                    if (text.includes('å®¶åº­å‡ºè¡Œ')) scenarios.push('å®¶åº­å‡ºè¡Œ');

                    if (scenarios.length === 0) return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                    return { answer: scenarios.join('ã€'), status: 'complete' };
                }
            },
            {
                id: 'budget',
                label: '4. è´­è½¦é¢„ç®—',
                question: 'é¢„ç®—å¤§è‡´èŒƒå›´ï¼Ÿ',
                keywords: ['é¢„ç®—', 'ä¸‡', 'ä»·æ ¼'],
                extract: (text) => {
                    // å…ˆå°è¯•ç›´æ¥åŒ¹é…é¢„ç®—
                    const budgetMatch = text.match(/(\d+)[-~åˆ°](\d+)ä¸‡/);
                    if (budgetMatch) {
                        return { answer: `${budgetMatch[1]}-${budgetMatch[2]}ä¸‡ï¼ˆæ˜ç¡®ï¼‰`, status: 'complete' };
                    }
                    const singleBudget = text.match(/é¢„ç®—[çº¦å¤§æ¦‚å·¦å³]*(\d+)ä¸‡/);
                    if (singleBudget) {
                        return { answer: `çº¦${singleBudget[1]}ä¸‡ï¼ˆæ˜ç¡®ï¼‰`, status: 'complete' };
                    }

                    // å¦‚æœæ²¡æœ‰ç›´æ¥é¢„ç®—ï¼Œé€šè¿‡è½¦å‹æ¨æ–­
                    const vehicles = extractVehicles(text);
                    const estimatedBudget = estimateBudgetFromVehicles(vehicles);
                    if (estimatedBudget) {
                        return {
                            answer: `${estimatedBudget.min}-${estimatedBudget.max}ä¸‡ï¼ˆæ ¹æ®å¯¹æ¯”è½¦å‹æ¨æ–­ï¼‰`,
                            status: 'partial'
                        };
                    }

                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'family_structure',
                label: '5. å®¶åº­ç»“æ„',
                question: 'æƒ³çœ‹å“ªæ¬¾è½¦/å®¶é‡Œå‡ å£äººï¼Ÿ',
                keywords: ['å£äºº', 'å®¶åº­', 'å­©å­', 'è€äºº', 'å¤«å¦»', 'L6', 'L7', 'L8', 'L9', 'MEGA'],
                extract: (text) => {
                    let answer = [];

                    const familyMatch = text.match(/(\d+)å£äºº/);
                    if (familyMatch) {
                        answer.push(`${familyMatch[1]}å£äºº`);
                    } else {
                        let count = 0;
                        if (text.includes('å¤«å¦»') || text.includes('å¦»å­') || text.includes('è€å©†') || text.includes('è€å…¬')) count += 2;
                        if (text.includes('å­©å­') || text.includes('å°å­©') || text.includes('å„¿å­') || text.includes('å¥³å„¿')) count += 1;
                        if (text.includes('è€äºº') || text.includes('çˆ¶æ¯')) count += 2;
                        if (count > 0) answer.push(`çº¦${count}+å£äºº`);
                    }

                    const models = ['L6', 'L7', 'L8', 'L9', 'MEGA'];
                    const foundModels = models.filter(m => text.includes(m));
                    if (foundModels.length > 0) {
                        answer.push(`æ„å‘ï¼š${foundModels.join('ã€')}`);
                    }

                    if (answer.length === 0) return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                    return { answer: answer.join('ï¼Œ'), status: answer.length >= 2 ? 'complete' : 'partial' };
                }
            },
            {
                id: 'decision_maker',
                label: '6. å†³ç­–äºº',
                question: 'ä¸»è¦æ˜¯è°åœ¨ç”¨è½¦/è°å†³ç­–ï¼Ÿ',
                keywords: ['æœ¬äºº', 'è‡ªå·±', 'å®¶äºº', 'å¦»å­', 'è€å©†', 'è€å…¬', 'çˆ¶æ¯', 'å•†é‡'],
                extract: (text) => {
                    if (text.includes('æœ¬äºº') || text.includes('è‡ªå·±')) {
                        if (text.includes('å•†é‡') || text.includes('å®¶äºº') || text.includes('å¦»å­') || text.includes('è€å©†')) {
                            return { answer: 'æœ¬äººä¸»å¯¼ï¼Œéœ€å®¶åº­å•†é‡', status: 'complete' };
                        }
                        return { answer: 'æœ¬äººå†³ç­–', status: 'complete' };
                    }
                    if (text.includes('å®¶äºº') || text.includes('å¦»å­') || text.includes('è€å©†') || text.includes('è€å…¬')) {
                        return { answer: 'å®¶åº­å…±åŒå†³ç­–', status: 'partial' };
                    }
                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'key_features',
                label: '7. å…³æ³¨åŠŸèƒ½',
                question: 'æœ€çœ‹é‡ä»€ä¹ˆåŠŸèƒ½ï¼Ÿ',
                keywords: ['ç»­èˆª', 'æ™ºèƒ½é©¾é©¶', 'ç©ºé—´', 'èˆ’é€‚', 'å®‰å…¨', 'å……ç”µ', 'é…ç½®', 'åŠ¨åŠ›', 'æ“æ§'],
                extract: (text) => {
                    const concerns = ['ç»­èˆª', 'æ™ºèƒ½é©¾é©¶', 'ç©ºé—´', 'èˆ’é€‚', 'å®‰å…¨', 'å……ç”µ', 'ä»·æ ¼', 'ä¿å€¼ç‡', 'å”®å', 'é…ç½®', 'åŠ¨åŠ›', 'æ“æ§', 'å¤–è§‚', 'å†…é¥°'];
                    const found = concerns.filter(c => text.includes(c));
                    if (found.length === 0) return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                    return { answer: found.join('ã€'), status: 'complete' };
                }
            },
            {
                id: 'competitor_comparison',
                label: '8. ç«å“å¯¹æ¯”',
                question: 'æœ€è¿‘åœ¨çœ‹ä»€ä¹ˆå…¶ä»–è½¦ï¼Ÿ',
                keywords: ['è”šæ¥', 'å°é¹', 'é—®ç•Œ', 'ç‰¹æ–¯æ‹‰', 'æ¯”äºšè¿ª', 'å¯¹æ¯”', 'æ¯”è¾ƒ'],
                extract: (text) => {
                    // ä½¿ç”¨å¢å¼ºçš„è½¦å‹è¯†åˆ«
                    const vehicles = extractVehicles(text);
                    const brands = new Set();
                    const models = [];

                    vehicles.forEach(v => {
                        const vehicleInfo = VEHICLE_PRICE_DB[v];
                        if (vehicleInfo) {
                            brands.add(vehicleInfo.brand);
                            // åªè®°å½•éç†æƒ³å“ç‰Œçš„è½¦å‹
                            if (vehicleInfo.brand !== 'ç†æƒ³') {
                                models.push(`${vehicleInfo.brand} ${v}`);
                            }
                        }
                    });

                    // ç§»é™¤ç†æƒ³å“ç‰Œï¼ˆå› ä¸ºæ˜¯æœ¬å“ï¼‰
                    brands.delete('ç†æƒ³');

                    if (models.length > 0) {
                        return { answer: models.join('ã€'), status: 'complete' };
                    }

                    if (brands.size > 0) {
                        return { answer: Array.from(brands).join('ã€'), status: 'partial' };
                    }

                    // å›é€€åˆ°åŸæœ‰çš„å“ç‰Œå…³é”®è¯åŒ¹é…
                    const brandKeywords = ['è”šæ¥', 'å°é¹', 'é—®ç•Œ', 'ç‰¹æ–¯æ‹‰', 'æ¯”äºšè¿ª', 'è…¾åŠ¿', 'ææ°ª', 'å¥”é©°', 'å®é©¬', 'å¥¥è¿ª'];
                    const found = brandKeywords.filter(c => text.includes(c));
                    if (found.length > 0) {
                        return { answer: found.join('ã€'), status: 'partial' };
                    }

                    if (text.includes('å¯¹æ¯”') || text.includes('æ¯”è¾ƒ')) {
                        return { answer: 'æœ‰å¯¹æ¯”ï¼Œä½†å“ç‰Œ/è½¦å‹æœªæ˜ç¡®', status: 'partial' };
                    }

                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            },
            {
                id: 'purchase_timing',
                label: '9. è´­ä¹°æ—¶é—´',
                question: 'è®¡åˆ’ä»€ä¹ˆæ—¶å€™ç”¨è½¦ï¼Ÿ',
                keywords: ['ç«‹å³', 'é©¬ä¸Š', 'ä¸€ä¸ªæœˆ', 'ä¸‰ä¸ªæœˆ', 'åŠå¹´', 'ä»Šå¹´', 'æ˜å¹´'],
                extract: (text) => {
                    if (text.match(/ç«‹å³|é©¬ä¸Š|è¿™å‘¨|æœ¬å‘¨|ä»Šå¤©|ç°åœ¨å°±ä¹°/)) return { answer: 'ç«‹å³è´­ä¹°', status: 'complete' };
                    if (text.match(/ä¸€ä¸ªæœˆ|1ä¸ªæœˆ|æœˆå†…|è¿‘æœŸ/)) return { answer: '1ä¸ªæœˆå†…', status: 'complete' };
                    if (text.match(/ä¸‰ä¸ªæœˆ|3ä¸ªæœˆ|å­£åº¦å†…/)) return { answer: '3ä¸ªæœˆå†…', status: 'complete' };
                    if (text.match(/åŠå¹´|6ä¸ªæœˆ/)) return { answer: 'åŠå¹´å†…', status: 'partial' };
                    if (text.match(/è§‚æœ›|å†çœ‹çœ‹|ä¸æ€¥|ç­‰ç­‰/)) return { answer: 'è§‚æœ›ä¸­', status: 'partial' };
                    return { answer: 'æ¢éœ€ä¸åˆ°ä½', status: 'incomplete' };
                }
            }
        ];

        // CELNæ¨¡å‹é…ç½®
        const CELN_CONFIG = {
            C: {
                name: 'è´­è½¦æ„å‘',
                keywords: {
                    high: ['æƒ³ä¹°', 'è¦ä¹°', 'å‡†å¤‡ä¹°', 'è®¡åˆ’è´­ä¹°', 'æ˜ç¡®è´­ä¹°', 'ç¡®å®šè¦ä¹°'],
                    medium: ['è€ƒè™‘', 'æ‰“ç®—', 'æœ‰æ„å‘', 'çœ‹çœ‹'],
                    low: ['äº†è§£', 'éšä¾¿çœ‹çœ‹', 'å…ˆçœ‹çœ‹'],
                },
                labels: {
                    high: 'é«˜æ„å‘',
                    medium: 'ä¸­æ„å‘',
                    low: 'ä½æ„å‘',
                }
            },
            E: {
                name: 'èƒ½æºç±»å‹',
                keywords: {
                    new_energy: ['æ–°èƒ½æº', 'ç”µåŠ¨', 'çº¯ç”µ', 'å¢ç¨‹'],
                    fuel: ['ç‡ƒæ²¹', 'æ±½æ²¹', 'æŸ´æ²¹'],
                    hybrid: ['æ··åŠ¨', 'æ··åˆåŠ¨åŠ›'],
                },
                labels: {
                    new_energy: 'æ–°èƒ½æº',
                    fuel: 'ç‡ƒæ²¹',
                    hybrid: 'æ··åŠ¨',
                }
            },
            L: {
                name: 'å“ç‰Œåå¥½',
                keywords: {
                    ideal: ['ç†æƒ³', 'L6', 'L7', 'L8', 'L9', 'MEGA'],
                    comparing: ['å¯¹æ¯”', 'æ¯”è¾ƒ', 'è¿˜åœ¨çœ‹', 'è”šæ¥', 'å°é¹', 'é—®ç•Œ', 'ç‰¹æ–¯æ‹‰'],
                },
                labels: {
                    ideal: 'ç†æƒ³',
                    comparing: 'å¯¹æ¯”ä¸­',
                }
            },
            N: {
                name: 'è´­ä¹°æ—¶æœº',
                keywords: {
                    immediate: ['ç«‹å³', 'é©¬ä¸Š', 'è¿™å‘¨', 'æœ¬å‘¨', 'ä»Šå¤©', 'ç°åœ¨å°±ä¹°'],
                    within_month: ['ä¸€ä¸ªæœˆ', '1ä¸ªæœˆ', 'æœˆå†…', 'è¿‘æœŸ'],
                    within_3months: ['ä¸‰ä¸ªæœˆ', '3ä¸ªæœˆ', 'å­£åº¦å†…'],
                    wait_and_see: ['è§‚æœ›', 'å†çœ‹çœ‹', 'ä¸æ€¥', 'ç­‰ç­‰'],
                },
                labels: {
                    immediate: 'ç«‹å³',
                    within_month: '1æœˆå†…',
                    within_3months: '3æœˆå†…',
                    wait_and_see: 'è§‚æœ›',
                }
            }
        };

        // ========== ä¸“å®¶è§†å›¾åŠŸèƒ½ ==========

        // å¡«å……ç¤ºä¾‹æ•°æ®
        function fillExample() {
            document.getElementById('customerInput').value =
`å®¢æˆ·æ˜¯ä¸€ä½30å²çš„ç”·æ€§ï¼Œç›®å‰åœ¨ä¸€å®¶äº’è”ç½‘å…¬å¸æ‹…ä»»äº§å“ç»ç†ã€‚ä»–æƒ³ä¹°ä¸€è¾†æ–°èƒ½æºSUVï¼Œé¢„ç®—åœ¨30-35ä¸‡ä¹‹é—´ï¼Œä¸»è¦ç”¨äºå®¶åº­å‡ºè¡Œå’Œå‘¨æœ«å¸¦å­©å­å»éƒŠæ¸¸ã€‚

å†³ç­–äººæ˜¯ä»–æœ¬äººï¼Œä½†éœ€è¦å’Œå¦»å­å•†é‡ã€‚ä»–ç›®å‰åœ¨å¯¹æ¯”ç†æƒ³L7å’Œè”šæ¥ES6è¿™ä¸¤æ¬¾è½¦å‹ï¼Œè®¡åˆ’åœ¨3ä¸ªæœˆå†…å®Œæˆè´­ä¹°ã€‚

ä»–æ¯”è¾ƒå…³æ³¨çš„æ˜¯ç»­èˆªé‡Œç¨‹å’Œæ™ºèƒ½é©¾é©¶åŠŸèƒ½ï¼Œæ‹…å¿ƒæ–°èƒ½æºè½¦åœ¨å†¬å¤©ç»­èˆªä¼šå¤§å¹…ç¼©æ°´ï¼ŒåŒæ—¶ä¹Ÿå…³å¿ƒå……ç”µä¾¿åˆ©æ€§ã€‚

ä»–ä½åœ¨æœé˜³åŒºï¼Œä¹‹å‰åœ¨ä¸‰é‡Œå±¯å’Œæœ›äº¬çš„ç†æƒ³é—¨åº—éƒ½çœ‹è¿‡è½¦ã€‚æ²Ÿé€šè®°å½•ï¼š1.24ç”µè¯æ²Ÿé€šã€1.17åˆ°åº—è¯•é©¾ã€1.10é¦–æ¬¡æ¥è§¦ã€‚ä»–ä¸»è¦é¡¾è™‘è¿˜æ˜¯åœ¨ç«å“å¯¹æ¯”ä¸Šï¼Œå¯¹é‡‘èæ”¿ç­–æ¯”è¾ƒæ•æ„Ÿï¼Œæƒ³äº†è§£ä½æ¯è´·æ¬¾æ–¹æ¡ˆï¼Œæ‰‹ä¸Šæœ‰ä¸€è¾†å®é©¬3ç³»æƒ³ç½®æ¢ã€‚`;
        }

        // åˆ†æCELN
        function analyzeCELN(text) {
            return {
                C: analyzeIntention(text),
                E: analyzeEnergyType(text),
                L: analyzeBrandPreference(text),
                N: analyzeTiming(text)
            };
        }

        function analyzeIntention(text) {
            const config = CELN_CONFIG.C.keywords;
            for (const keyword of config.high) {
                if (text.includes(keyword)) return 'high';
            }
            for (const keyword of config.medium) {
                if (text.includes(keyword)) return 'medium';
            }
            for (const keyword of config.low) {
                if (text.includes(keyword)) return 'low';
            }
            return 'medium';
        }

        function analyzeEnergyType(text) {
            const config = CELN_CONFIG.E.keywords;
            for (const keyword of config.new_energy) {
                if (text.includes(keyword)) return 'new_energy';
            }
            for (const keyword of config.fuel) {
                if (text.includes(keyword)) return 'fuel';
            }
            for (const keyword of config.hybrid) {
                if (text.includes(keyword)) return 'hybrid';
            }
            return 'new_energy';
        }

        function analyzeBrandPreference(text) {
            const config = CELN_CONFIG.L.keywords;
            let hasIdeal = false;
            let hasComparing = false;

            for (const keyword of config.ideal) {
                if (text.includes(keyword)) hasIdeal = true;
            }
            for (const keyword of config.comparing) {
                if (text.includes(keyword)) hasComparing = true;
            }

            if (hasIdeal && hasComparing) return 'comparing';
            if (hasIdeal) return 'ideal';
            return 'comparing';
        }

        function analyzeTiming(text) {
            const config = CELN_CONFIG.N.keywords;
            for (const keyword of config.immediate) {
                if (text.includes(keyword)) return 'immediate';
            }
            for (const keyword of config.within_month) {
                if (text.includes(keyword)) return 'within_month';
            }
            for (const keyword of config.within_3months) {
                if (text.includes(keyword)) return 'within_3months';
            }
            for (const keyword of config.wait_and_see) {
                if (text.includes(keyword)) return 'wait_and_see';
            }
            return 'within_3months';
        }

        // åˆ†ææ¢éœ€ä¹é—®
        function analyzeNineQuestions(text) {
            return NINE_QUESTIONS.map(q => {
                const result = q.extract(text);
                return {
                    ...q,
                    ...result
                };
            });
        }

        // æå–å…³é”®è¯ï¼ˆæ¢éœ€ä¹é—®æœªä½“ç°çš„ä¿¡æ¯ï¼‰
        function extractKeywords(text) {
            const keywords = {};

            // ç”¨è½¦ç”¨é€”
            const purposes = ['å®¶åº­', 'å•†åŠ¡', 'é€šå‹¤', 'ä¸Šä¸‹ç­', 'æ—…æ¸¸', 'éƒŠæ¸¸', 'æ¥é€å­©å­', 'ä»£æ­¥'];
            keywords.purpose = purposes.filter(p => text.includes(p));

            // æ„å‘è½¦å‹
            const vehicles = extractVehicles(text);
            keywords.models = vehicles.filter(v => {
                const info = VEHICLE_PRICE_DB[v];
                return info && info.brand === 'ç†æƒ³';
            });

            // ç«å“è½¦å‹
            keywords.competitors = vehicles.filter(v => {
                const info = VEHICLE_PRICE_DB[v];
                return info && info.brand !== 'ç†æƒ³';
            }).map(v => {
                const info = VEHICLE_PRICE_DB[v];
                return `${info.brand} ${v}`;
            });

            // å…³æ³¨ç‚¹
            const concerns = ['ç»­èˆª', 'æ™ºèƒ½é©¾é©¶', 'ç©ºé—´', 'èˆ’é€‚', 'å®‰å…¨', 'å……ç”µ', 'ä»·æ ¼', 'ä¿å€¼ç‡', 'å”®å', 'é…ç½®', 'åŠ¨åŠ›', 'æ“æ§', 'å¤–è§‚', 'å†…é¥°'];
            keywords.concerns = concerns.filter(c => text.includes(c));

            // çœ‹è½¦é—¨åº—
            const stores = ['ä¸‰é‡Œå±¯', 'æœ›äº¬', 'å›½è´¸', 'å¤§å…´', 'äº¦åº„', 'äº”æ£µæ¾', 'è¥¿å•', 'å»ºå›½é—¨', 'åè´¸', 'èŠ³è‰åœ°'];
            keywords.visitedStores = stores.filter(s => text.includes(s));

            // å±…ä½åœ°å€
            const locations = ['æœé˜³', 'æµ·æ·€', 'ä¸œåŸ', 'è¥¿åŸ', 'ä¸°å°', 'å¤§å…´', 'é¡ºä¹‰', 'é€šå·', 'æ˜Œå¹³', 'çŸ³æ™¯å±±'];
            keywords.residenceLocation = locations.find(l => text.includes(l)) || null;

            // é‡‘èæ•æ„Ÿåº¦
            if (text.includes('å…¨æ¬¾') || text.includes('ä¸€æ¬¡æ€§ä»˜æ¬¾')) {
                keywords.financeSensitivity = 'ä¸æ•æ„Ÿ(å…¨æ¬¾)';
            } else if (text.includes('ä½æ¯') || text.includes('è´·æ¬¾') || text.includes('åˆ†æœŸ') || text.includes('é‡‘è') || text.includes('æŒ‰æ­')) {
                keywords.financeSensitivity = 'æ•æ„Ÿ';
            } else {
                keywords.financeSensitivity = 'æœªçŸ¥';
            }

            // äºŒæ‰‹è½¦ç½®æ¢
            if (text.includes('ç½®æ¢') || text.includes('æ—§è½¦') || text.includes('å–è½¦') || text.includes('ä»¥æ—§æ¢æ–°')) {
                keywords.hasTradeIn = true;
                // å°è¯•æå–æ—§è½¦å“ç‰Œ/è½¦å‹
                const carBrands = ['å¥”é©°', 'å®é©¬', 'BMW', 'å¥¥è¿ª', 'ç‰¹æ–¯æ‹‰', 'è”šæ¥', 'å°é¹', 'ç†æƒ³', 'æ¯”äºšè¿ª', 'è…¾åŠ¿', 'ææ°ª', 'é—®ç•Œ', 'ä¸°ç”°', 'æœ¬ç”°', 'å¤§ä¼—', 'åˆ«å…‹'];
                const foundBrand = carBrands.find(brand => text.includes(brand));

                // å°è¯•è¯†åˆ«å…·ä½“è½¦å‹
                const allVehicles = extractVehicles(text);
                const tradeInVehicle = allVehicles.find(v => {
                    const info = VEHICLE_PRICE_DB[v];
                    return info && info.brand !== 'ç†æƒ³';
                });

                if (tradeInVehicle) {
                    const info = VEHICLE_PRICE_DB[tradeInVehicle];
                    keywords.tradeInInfo = `${info.brand} ${tradeInVehicle}`;
                } else if (foundBrand) {
                    keywords.tradeInInfo = foundBrand;
                } else {
                    keywords.tradeInInfo = 'æœªçŸ¥';
                }
            } else {
                keywords.hasTradeIn = false;
            }

            // è·Ÿè¿›æ¬¡æ•°ï¼ˆä½¿ç”¨æ—¥æœŸæå–ï¼‰
            const dates = extractDates(text);
            keywords.followUpCount = dates.length;

            // é¡¾è™‘ç±»åˆ«
            const concernCategories = {
                'ç«å“': 'competitor',
                'å¯¹æ¯”': 'competitor',
                'äº¤ä»˜': 'delivery',
                'å‘¨æœŸ': 'delivery',
                'èˆ†è®º': 'public_opinion',
                'å£ç¢‘': 'public_opinion',
                'å“ç‰Œ': 'brand',
                'ä»·æ ¼': 'price',
                'å“è´¨': 'quality',
                'è´¨é‡': 'quality'
            };

            for (const [key, value] of Object.entries(concernCategories)) {
                if (text.includes(key)) {
                    keywords.concernCategory = value;
                    break;
                }
            }

            return keywords;
        }

        // ç”Ÿæˆç²¾ç®€è¯æœ¯ï¼ˆæœ€å¤š2ä¸ªï¼šç¬¬ä¸€ä¸ªæ ¹æ®è·Ÿè¿›æ¬¡æ•°ï¼Œç¬¬äºŒä¸ªæ ¹æ®é¡¾è™‘ç‚¹ï¼‰
        function generateImprovedScripts(celn, nineQuestions, keywords) {
            const scripts = [];
            const followUpCount = keywords.followUpCount || 0;

            // ====== ç¬¬ä¸€ä¸ªè¯æœ¯ï¼šæ ¹æ®è·Ÿè¿›æ¬¡æ•° ======

            if (followUpCount === 0) {
                // é¦–æ¬¡æ¥è§¦ï¼šå»ºç«‹ä¿¡ä»» + äº†è§£éœ€æ±‚
                scripts.push({
                    type: 'greeting',
                    title: 'ğŸ‘‹ é¦–æ¬¡æ¥è§¦è¯æœ¯',
                    content: `æ‚¨å¥½ï¼å¾ˆé«˜å…´è®¤è¯†æ‚¨ï¼Œæˆ‘æ˜¯ç†æƒ³æ±½è½¦çš„ä¸“å±é¡¾é—®ã€‚${keywords.models && keywords.models.length > 0 ? 'çœ‹æ‚¨å¯¹' + keywords.models.join('ã€') + 'æ¯”è¾ƒæ„Ÿå…´è¶£' : 'æ„Ÿè°¢æ‚¨å…³æ³¨ç†æƒ³æ±½è½¦'}ï¼Œ${keywords.purpose && keywords.purpose.length > 0 ? 'å¹³æ—¶ä¸»è¦' + keywords.purpose.join('ã€') + 'ç”¨è½¦æ˜¯å§' : 'ä¸çŸ¥é“æ‚¨å¹³æ—¶ä¸»è¦ä»€ä¹ˆåœºæ™¯ç”¨è½¦å‘¢'}ï¼Ÿæˆ‘å…ˆäº†è§£ä¸€ä¸‹æ‚¨çš„éœ€æ±‚ï¼Œè¿™æ ·èƒ½æ›´å‡†ç¡®åœ°ç»™æ‚¨æ¨èåˆé€‚çš„è½¦å‹å’Œé…ç½®ã€‚`,
                    stage: 'é¦–æ¬¡æ¥è§¦'
                });
            } else if (followUpCount >= 1 && followUpCount <= 2) {
                // è·Ÿè¿›1-2æ¬¡ï¼šé‚€çº¦è¯•é©¾ + åŠ¨æ€ä½“éªŒ
                if (keywords.visitedStores && keywords.visitedStores.length > 0) {
                    scripts.push({
                        type: 'test_drive',
                        title: 'ğŸš— æ·±åº¦è¯•é©¾é‚€çº¦',
                        content: `${keywords.visitedStores.join('ã€')}é‚£è¾¹æ‚¨ä¹‹å‰å»çœ‹è¿‡äº†æ˜¯å§ï¼Ÿé™æ€çœ‹è½¦åªèƒ½äº†è§£ä¸ªå¤§æ¦‚ï¼Œ${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'ç†æƒ³æ±½è½¦'}çœŸæ­£çš„äº§å“åŠ›è¿˜æ˜¯å¾—å¼€èµ·æ¥æ‰èƒ½æ„Ÿå—åˆ°ã€‚ç‰¹åˆ«æ˜¯å’±ä»¬çš„æ™ºèƒ½é©¾é©¶ã€åŠ é€Ÿæ€§èƒ½ã€é™è°§æ€§è¿™äº›ï¼Œåœ¨è·¯ä¸Šè·‘ä¸€åœˆæ‚¨å°±èƒ½ç›´è§‚æ„Ÿå—å·®å¼‚åœ¨å“ªå„¿ã€‚æˆ‘ç»™æ‚¨çº¦ä¸ªå®Œæ•´çš„è¯•é©¾ï¼Œå¤§æ¦‚ä¸€å°æ—¶å·¦å³ï¼ŒåŸå¸‚é“è·¯ã€é«˜é€Ÿéƒ½èƒ½ä½“éªŒåˆ°ï¼Œæ‚¨çœ‹è¿™å‘¨æœ«å“ªå¤©æ–¹ä¾¿ï¼Ÿ`,
                        stage: 'è¯•é©¾é‚€çº¦'
                    });
                } else {
                    scripts.push({
                        type: 'test_drive',
                        title: 'ğŸš— è¯•é©¾é‚€çº¦',
                        content: `å’±ä»¬ä¹‹å‰èŠè¿‡æ‚¨${keywords.purpose && keywords.purpose.length > 0 ? 'ä¸»è¦' + keywords.purpose.join('ã€') + 'ç”¨è½¦' : 'çš„åŸºæœ¬éœ€æ±‚'}ï¼Œå‚æ•°é…ç½®éƒ½èƒ½åœ¨ç½‘ä¸Šçœ‹åˆ°ï¼Œä½†çœŸæ­£çš„ä¹˜åæ„Ÿå—ã€é©¾é©¶è´¨æ„Ÿï¼Œè¿˜æ˜¯å¾—æ‚¨äº²è‡ªä¸Šè½¦ä½“éªŒä¸€ä¸‹ã€‚${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'ç†æƒ³æ±½è½¦'}çš„æ™ºèƒ½åº§èˆ±ã€è¾…åŠ©é©¾é©¶ã€åŠ¨åŠ›å“åº”ï¼Œæ‚¨å®é™…å¼€ä¸€å¼€å°±çŸ¥é“å’Œä¼ ç»Ÿè½¦æœ‰å¤šå¤§åŒºåˆ«äº†ã€‚æˆ‘å¸®æ‚¨é¢„çº¦ä¸ªè¯•é©¾å§ï¼Œæ‚¨çœ‹è¿™å‘¨å“ªå¤©æœ‰ç©ºï¼Ÿ`,
                        stage: 'è¯•é©¾é‚€çº¦'
                    });
                }
            } else if (followUpCount >= 3) {
                // è·Ÿè¿›3æ¬¡ä»¥ä¸Šï¼šè¿›å…¥è°ˆå•é˜¶æ®µï¼Œç»™æ”¿ç­–ã€è¡¥è´´ã€ä¿ƒæˆ
                scripts.push({
                    type: 'closing',
                    title: 'ğŸ¯ æƒç›Šæ”¿ç­–ä»‹ç»',
                    content: `å“¥/å§ï¼Œè·Ÿæ‚¨è¯´ä¸ªå¥½æ¶ˆæ¯ï¼Œå’±ä»¬è¿™è¾¹æœ€è¿‘æœ‰äº†æ–°çš„è´­è½¦æƒç›Šæ”¿ç­–ï¼Œç‰¹åˆ«é€‚åˆæ‚¨è¿™ç§æƒ…å†µã€‚æˆ‘ç»™æ‚¨è¯¦ç»†ä»‹ç»ä¸€ä¸‹ï¼š\n\nã€æ­¤å¤„éœ€æ ¹æ®æœ€æ–°å®˜æ–¹æ”¿ç­–å¡«å†™ã€‘\nâ€¢ é™æ—¶è´­è½¦æƒç›Šï¼šåŒ…æ‹¬ç§¯åˆ†ç¤¼åŒ…ã€å……ç”µæ¡©å®‰è£…è¡¥è´´ã€ä¿é™©ä¼˜æƒ ç­‰\n${keywords.financeSensitivity === 'æ•æ„Ÿ' ? 'â€¢ é‡‘èæ–¹æ¡ˆï¼šä½æ¯ç”šè‡³0æ¯æ–¹æ¡ˆï¼Œèƒ½å¸®æ‚¨çœä¸å°‘åˆ©æ¯\n' : ''}${keywords.hasTradeIn ? 'â€¢ ç½®æ¢è¡¥è´´ï¼šæ‚¨é‚£è¾†' + keywords.tradeInInfo + 'å¯ä»¥æŠµä¸€éƒ¨åˆ†è½¦æ¬¾ï¼Œè¿˜æœ‰é¢å¤–çš„ç½®æ¢è¡¥è´´\n' : ''}\nè¿™äº›æƒç›Šéƒ½æ˜¯æœ‰æ—¶æ•ˆçš„ï¼Œå¦‚æœæ‚¨è¿‘æœŸèƒ½å®šä¸‹æ¥ï¼Œæ­£å¥½èƒ½å¸®æ‚¨æŠŠè¿™äº›ä¼˜æƒ éƒ½é”å®šäº†ã€‚æ‚¨çœ‹è¿˜æœ‰ä»€ä¹ˆé¡¾è™‘å—ï¼Ÿå’±ä»¬ä¸€èµ·çœ‹çœ‹èƒ½ä¸èƒ½è§£å†³ã€‚`,
                    stage: 'è°ˆå•é˜¶æ®µ'
                });
            }

            // ====== ç¬¬äºŒä¸ªè¯æœ¯ï¼šæ ¹æ®ä¸»è¦é¡¾è™‘ç‚¹ï¼ˆä¼˜å…ˆçº§æ’åºï¼‰======

            // ä¼˜å…ˆçº§1ï¼šå®¶åº­å†³ç­–é¡¾è™‘ï¼ˆå®¶äººä¸åŒæ„ï¼‰
            const decisionProbe = nineQuestions.find(q => q.id === 'decision_maker');
            if (decisionProbe && decisionProbe.answer && (decisionProbe.answer.includes('å•†é‡') || decisionProbe.answer.includes('å®¶åº­'))) {
                scripts.push({
                    type: 'family_decision',
                    title: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶åº­å†³ç­–è¯æœ¯',
                    content: `äº†è§£æ‚¨ä¹Ÿéå¸¸é‡è§†å®¶äººçš„æƒ³æ³•ï¼Œè¿™ä¸ªå†³å®šç¡®å®éœ€è¦å…¨å®¶äººéƒ½æ»¡æ„ã€‚æˆ‘å»ºè®®æ‚¨è¯•é©¾çš„æ—¶å€™æŠŠçˆ±äºº${decisionProbe.answer.includes('çˆ¶æ¯') || decisionProbe.answer.includes('è€äºº') ? 'å’Œçˆ¶æ¯' : ''}ä¹Ÿå¸¦ä¸Šæ¥æ·±åº¦è¯•é©¾ä¸€æ¬¡ã€‚${keywords.models && keywords.models.length > 0 ? keywords.models[0] + 'çš„' : 'å’±ä»¬'}${keywords.purpose && keywords.purpose.includes('å®¶åº­') ? 'ç¬¬äºŒæ’ã€ç¬¬ä¸‰æ’çš„ç©ºé—´å’Œèˆ’é€‚åº¦' : 'æ•´ä½“ä¹˜åèˆ’é€‚æ€§'}ï¼Œå®¶äººå®é™…åè¿›å»ä½“éªŒï¼Œæ¯”æ‚¨ä¸€ä¸ªäººçœ‹å¼ºå¤šäº†ã€‚è€Œä¸”å’±ä»¬é—¨åº—æœ‰å®¶åº­ä½“éªŒåŒºï¼Œå°æœ‹å‹ä¹Ÿæœ‰åœ°æ–¹ç©ï¼Œä¸ä¼šæ— èŠã€‚è®©å®¶äººäº²èº«æ„Ÿå—ä¸€ä¸‹ï¼Œä»–ä»¬è‚¯å®šä¹Ÿä¼šå–œæ¬¢çš„ã€‚`,
                    stage: 'å®¶åº­å†³ç­–é¡¾è™‘åŒ–è§£'
                });
                return scripts;
            }

            // ä¼˜å…ˆçº§2ï¼šç«å“å¯¹æ¯”é¡¾è™‘
            const competitorProbe = nineQuestions.find(q => q.id === 'competitor_comparison');
            if (competitorProbe && competitorProbe.status !== 'incomplete' && competitorProbe.answer && competitorProbe.answer !== 'æ¢éœ€ä¸åˆ°ä½') {
                const competitorAnswer = competitorProbe.answer;
                let competitorScript = '';

                if (competitorAnswer.includes('ç‰¹æ–¯æ‹‰') && competitorAnswer.includes('Model Y')) {
                    competitorScript = `çŸ¥é“æ‚¨åœ¨å¯¹æ¯”ç‰¹æ–¯æ‹‰Model Yï¼Œå…¶å®${keywords.models && keywords.models.length > 0 && keywords.models[0] === 'i6' ? 'i6' : 'å’±ä»¬çš„è½¦'}å’ŒModel Yç›¸æ¯”ï¼Œç©ºé—´ç¡®å®è¦å¤§ä¸å°‘ï¼Œä¹˜åæ„Ÿå—ä¹Ÿæ›´èˆ’é€‚ã€‚è€Œä¸”å’±ä»¬çš„é™è°§æ€§æ˜¯åŒä»·ä½å…¨è¡Œä¸šç¬¬ä¸€ï¼Œèƒ½ç»™æ‚¨å¸¦æ¥æœ€èˆ’æœçš„é©¾ä¹˜ä½“éªŒã€‚ä¹°è½¦ä¹°çš„å°±æ˜¯ä¸€ä¸ªèˆ’å¿ƒï¼Œæ‚¨è¯´æ˜¯ä¸ï¼Ÿç‰¹æ–¯æ‹‰çš„ç§‘æŠ€æ„Ÿç¡®å®ä¸é”™ï¼Œä½†å’±ä»¬ç†æƒ³åœ¨å®¶åº­åœºæ™¯çš„é€‚é…ä¸Šåšå¾—æ›´ç»†è‡´ï¼Œè¿™ä¸ªæ‚¨è¯•é©¾ä¸€ä¸‹å°±èƒ½æ„Ÿå—åˆ°å·®åˆ«ã€‚`;
                } else if (competitorAnswer.includes('è”šæ¥')) {
                    competitorScript = `æ‚¨åœ¨å¯¹æ¯”è”šæ¥æ˜¯å§ï¼Ÿè”šæ¥ç¡®å®æ˜¯ä¸ªå¥½å“ç‰Œï¼ŒæœåŠ¡åšå¾—å¾ˆåˆ°ä½ã€‚ä¸è¿‡å’±ä»¬ä¸¤å®¶çš„ä¾§é‡ç‚¹ä¸å¤ªä¸€æ ·ï¼Œç†æƒ³æ›´æ³¨é‡å®¶åº­åœºæ™¯çš„å®ç”¨æ€§ï¼Œåƒ6åº§å¸ƒå±€ã€å†°ç®±å½©ç”µå¤§æ²™å‘ï¼Œè¿™äº›éƒ½æ˜¯ä¸ºå®¶åº­é•¿é€”å‡ºè¡Œä¸“é—¨è®¾è®¡çš„ã€‚è€Œä¸”å¢ç¨‹æŠ€æœ¯è®©æ‚¨å®Œå…¨ä¸ç”¨æ‹…å¿ƒç»­èˆªé—®é¢˜ï¼Œè¿™ç‚¹å¯¹å®¶åº­ç”¨æˆ·æ¥è¯´å¤ªå‹å¥½äº†ã€‚è”šæ¥çš„æ¢ç”µæ˜¯æ–¹ä¾¿ï¼Œä½†æ‚¨å¾—ä¿è¯å‘¨è¾¹æ¢ç”µç«™è¦†ç›–å¤Ÿå¥½ï¼Œè€Œä¸”æ¢ç”µä¹Ÿæ˜¯è¦é¢å¤–ä»˜è´¹çš„ã€‚æ‚¨å¯ä»¥ä¸¤è¾¹éƒ½è¯•é©¾æ„Ÿå—ä¸€ä¸‹ï¼Œçœ‹å“ªä¸ªæ›´ç¬¦åˆæ‚¨çš„ç”¨è½¦ä¹ æƒ¯ã€‚`;
                } else if (competitorAnswer.includes('é—®ç•Œ')) {
                    competitorScript = `æ‚¨åœ¨å¯¹æ¯”é—®ç•Œ${competitorAnswer.includes('M9') ? 'M9' : competitorAnswer.includes('M8') ? 'M8' : competitorAnswer.includes('M7') ? 'M7' : ''}æ˜¯å§ï¼Ÿé—®ç•Œè¿™ä¸¤å¹´ç¡®å®èµ·æ¥å¾—æŒºå¿«çš„ã€‚ä¸è¿‡å’±ä»¬ç†æƒ³åœ¨å“ç‰Œå£ç¢‘ã€ç”¨æˆ·ç¤¾åŒºæ´»è·ƒåº¦ä¸Šæ›´æœ‰ä¼˜åŠ¿ï¼Œè€Œä¸”åœ¨å¢ç¨‹æŠ€æœ¯çš„æˆç†Ÿåº¦ä¸Šï¼Œç†æƒ³æ˜¯åšå¾—æœ€æ—©ä¹Ÿæœ€ç¨³å®šçš„ã€‚${keywords.models && keywords.models.length > 0 ? keywords.models[0] + 'çš„' : 'å’±ä»¬'}NVHé™è°§æ€§ã€ç©ºé—´åˆ©ç”¨ç‡ä¹Ÿéƒ½æ˜¯è¡Œä¸šé¢†å…ˆçš„ã€‚æ‚¨è¦æ˜¯å®¶åº­ç”¨è½¦ï¼Œç†æƒ³çš„6åº§å¸ƒå±€ç¬¬äºŒæ’ç‹¬ç«‹åº§æ¤…ï¼Œåèµ·æ¥æ¯”7åº§èˆ’æœå¤šäº†ã€‚`;
                } else if (competitorAnswer.includes('å°é¹')) {
                    competitorScript = `æ‚¨åœ¨å¯¹æ¯”å°é¹æ˜¯å§ï¼Ÿå°é¹çš„æ™ºèƒ½åŒ–ç¡®å®åšå¾—ä¸é”™ã€‚ä¸è¿‡å’±ä»¬ç†æƒ³åœ¨ç©ºé—´ã€èˆ’é€‚æ€§ä¸Šçš„è¡¨ç°æ›´çªå‡ºï¼Œç‰¹åˆ«é€‚åˆå®¶åº­ç”¨æˆ·ã€‚è€Œä¸”å¢ç¨‹æŠ€æœ¯è®©æ‚¨å®Œå…¨æ²¡æœ‰ç»­èˆªç„¦è™‘ï¼Œæƒ³å»å“ªå„¿å°±å»å“ªå„¿ï¼Œä¸ç”¨å¤©å¤©æƒ³ç€å……ç”µçš„äº‹å„¿ã€‚å°é¹çš„çº¯ç”µè½¦å¸‚åŒºé€šå‹¤æ˜¯æ²¡é—®é¢˜ï¼Œä½†è¦æ˜¯ç»å¸¸é•¿é€”è‡ªé©¾ï¼Œå¢ç¨‹çš„ä¾¿åˆ©æ€§å°±ä½“ç°å‡ºæ¥äº†ã€‚`;
                } else {
                    competitorScript = `çŸ¥é“æ‚¨åœ¨å¯¹æ¯”${competitorAnswer}ï¼Œè¿™æ˜¯éå¸¸æ˜æ™ºçš„å†³ç­–ã€‚ä¸åŒå“ç‰Œç¡®å®å„æœ‰ç‰¹ç‚¹ã€‚${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'ç†æƒ³æ±½è½¦'}çš„æ ¸å¿ƒä¼˜åŠ¿åœ¨äºï¼šå¢ç¨‹æŠ€æœ¯å®Œå…¨æ²¡æœ‰é‡Œç¨‹ç„¦è™‘ï¼Œ6åº§å¸ƒå±€ä¸ºå®¶åº­å‡ºè¡Œæ·±åº¦ä¼˜åŒ–ï¼ŒAD Maxæ™ºèƒ½é©¾é©¶ä½“éªŒå¾ˆæ£’ï¼Œè€Œä¸”æ–°åŠ¿åŠ›é‡Œä¿å€¼ç‡æœ€é«˜ã€‚æ‚¨æœ€çœ‹é‡å“ªæ–¹é¢ï¼Ÿæˆ‘å¯ä»¥é’ˆå¯¹æ€§åœ°è·Ÿæ‚¨èŠèŠç†æƒ³åœ¨è¿™äº›æ–¹é¢çš„è¡¨ç°ã€‚`;
                }

                scripts.push({
                    type: 'competitor',
                    title: 'âš–ï¸ ç«å“å¯¹æ¯”åº”å¯¹',
                    content: competitorScript,
                    stage: 'ç«å“å¯¹æ¯”é¡¾è™‘åŒ–è§£'
                });
                return scripts;
            }

            // ä¼˜å…ˆçº§3ï¼šå…·ä½“æ€§èƒ½é¡¾è™‘ï¼ˆç»­èˆªã€ç©ºé—´ã€ä»·æ ¼ç­‰ï¼‰
            if (keywords.concerns && keywords.concerns.length > 0) {
                const concernsStr = keywords.concerns.join('ã€');
                let concernContent = `æ‚¨æåˆ°æ¯”è¾ƒå…³æ³¨${concernsStr}ï¼Œè¿™äº›ç¡®å®æ˜¯ä¹°è½¦çš„é‡è¦è€ƒé‡ã€‚æˆ‘è·Ÿæ‚¨è¯´è¯´å’±ä»¬åœ¨è¿™äº›æ–¹é¢çš„è¡¨ç°ï¼š\n\n`;

                if (keywords.concerns.includes('ç»­èˆª')) {
                    concernContent += 'â€¢ ç»­èˆªï¼šå¢ç¨‹è½¦å‹çº¯ç”µèƒ½è·‘200å¤šå…¬é‡Œï¼Œæ—¥å¸¸é€šå‹¤å®Œå…¨å¤Ÿç”¨ã€‚é•¿é€”çš„è¯åŠ æ²¹å°±è¡Œï¼Œç»¼åˆç»­èˆª1000å…¬é‡Œä»¥ä¸Šï¼Œå®Œå…¨ä¸ç”¨æ‹…å¿ƒè¶´çª\n';
                }
                if (keywords.concerns.includes('æ™ºèƒ½é©¾é©¶')) {
                    concernContent += 'â€¢ æ™ºèƒ½é©¾é©¶ï¼šå’±ä»¬çš„AD Maxç³»ç»Ÿï¼Œé«˜é€ŸNOAå’ŒåŸå¸‚NOAä½“éªŒéƒ½ç‰¹åˆ«å¥½ï¼Œæ˜¯ç›®å‰é‡äº§è½¦é‡Œæ™ºèƒ½é©¾é©¶åšå¾—æœ€å¥½çš„ä¹‹ä¸€ã€‚æ‚¨è¯•é©¾çš„æ—¶å€™å¯ä»¥é‡ç‚¹ä½“éªŒä¸€ä¸‹\n';
                }
                if (keywords.concerns.includes('å……ç”µ')) {
                    concernContent += 'â€¢ å……ç”µï¼šå¢ç¨‹è½¦å‹æœ€å¤§çš„å¥½å¤„å°±æ˜¯ä¸ç”¨ç„¦è™‘å……ç”µã€‚æ—¥å¸¸æœ‰æ¡ä»¶å°±å……ç”µï¼Œç”¨ç”µæˆæœ¬ä½ï¼›é•¿é€”æˆ–è€…æ¥ä¸åŠå……å°±åŠ æ²¹ï¼Œç‰¹åˆ«çµæ´»\n';
                }
                if (keywords.concerns.includes('ä¿å€¼ç‡')) {
                    concernContent += 'â€¢ ä¿å€¼ç‡ï¼šç†æƒ³åœ¨æ–°åŠ¿åŠ›é‡Œä¿å€¼ç‡æ˜¯æœ€é«˜çš„ï¼Œä¸‰å¹´èƒ½åˆ°70%ä»¥ä¸Šã€‚è¿™ä¸ªæ‚¨å¯ä»¥å»äºŒæ‰‹è½¦å¸‚åœºçœ‹çœ‹ï¼Œç†æƒ³çš„ä¿å€¼ç¡®å®å¥½\n';
                }
                if (keywords.concerns.includes('ç©ºé—´')) {
                    concernContent += `â€¢ ç©ºé—´ï¼š${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬çš„è½¦'}ç©ºé—´ç»å¯¹å¤Ÿç”¨ï¼Œç‰¹åˆ«æ˜¯ç¬¬äºŒæ’ï¼Œåèµ·æ¥æ¯”å¾ˆå¤šDçº§è½¦éƒ½èˆ’æœ\n`;
                }
                if (keywords.concerns.includes('å®‰å…¨')) {
                    concernContent += 'â€¢ å®‰å…¨ï¼šå’±ä»¬åœ¨ä¸­ä¿ç ”çš„æµ‹è¯•æˆç»©éƒ½æ˜¯ä¼˜ç§€ï¼Œå®‰å…¨é…ç½®ä¹Ÿæ˜¯æ‹‰æ»¡çš„ï¼Œè¿™æ–¹é¢æ‚¨å®Œå…¨å¯ä»¥æ”¾å¿ƒ\n';
                }
                if (keywords.concerns.includes('ä»·æ ¼')) {
                    concernContent += `â€¢ ä»·æ ¼ï¼š${keywords.models && keywords.models.length > 0 ? keywords.models[0] : 'å’±ä»¬çš„è½¦å‹'}çš„é…ç½®åœ¨åŒä»·ä½é‡Œæ˜¯å¾ˆåšé“çš„ï¼Œè€Œä¸”ä¿å€¼ç‡é«˜ï¼Œç»¼åˆç®—ä¸‹æ¥æ€§ä»·æ¯”å¾ˆçªå‡º\n`;
                }

                concernContent += '\næ‚¨å¯¹è¿™äº›æ–¹é¢è¿˜æœ‰ä»€ä¹ˆå…·ä½“æƒ³äº†è§£çš„å—ï¼Ÿå’±ä»¬å¯ä»¥ç»†èŠã€‚';

                scripts.push({
                    type: 'concern',
                    title: 'ğŸ’¡ æ ¸å¿ƒé¡¾è™‘è§£ç­”',
                    content: concernContent,
                    stage: 'æ€§èƒ½é¡¾è™‘åŒ–è§£'
                });
                return scripts;
            }

            // ä¼˜å…ˆçº§4ï¼šé‡‘èæ”¿ç­–æ•æ„Ÿ
            if (keywords.financeSensitivity === 'æ•æ„Ÿ') {
                scripts.push({
                    type: 'finance',
                    title: 'ğŸ’³ é‡‘èæ–¹æ¡ˆæ¨è',
                    content: `æ‚¨å¯¹é‡‘èæ–¹æ¡ˆæ¯”è¾ƒå…³æ³¨ï¼Œæˆ‘è¿™è¾¹ç»™æ‚¨ä»‹ç»å‡ ç§æ–¹æ¡ˆï¼š\n\nã€æ­¤å¤„éœ€æ ¹æ®æœ€æ–°å®˜æ–¹é‡‘èæ”¿ç­–å¡«å†™ã€‘\nâ€¢ ä½é¦–ä»˜æ–¹æ¡ˆï¼ˆ15%èµ·ï¼‰ï¼šæ‰‹å¤´èµ„é‡‘å¯ä»¥çµæ´»è¿ç”¨\nâ€¢ 0æ¯/ä½æ¯æ–¹æ¡ˆï¼šèƒ½çœä¸‹æ¥çš„åˆ©æ¯ä¸æ˜¯å°æ•°ç›®\nâ€¢ å¼¹æ€§å°¾æ¬¾æ–¹æ¡ˆï¼šæœˆä¾›å‹åŠ›å°ï¼Œåˆ°æœŸå¯é€‰æ‹©ç»­è´·æˆ–ä»˜æ¸…\n\n${nineQuestions.find(q => q.id === 'budget')?.answer ? 'æŒ‰æ‚¨' + nineQuestions.find(q => q.id === 'budget').answer.replace('ï¼ˆæ˜ç¡®ï¼‰', '').replace('ï¼ˆæ ¹æ®å¯¹æ¯”è½¦å‹æ¨æ–­ï¼‰', '') + 'çš„é¢„ç®—' : 'æ ¹æ®æ‚¨çš„æƒ…å†µ'}ï¼Œæˆ‘å¯ä»¥å¸®æ‚¨è¯¦ç»†ç®—ä¸€ä¸‹æ¯ä¸ªæ–¹æ¡ˆçš„æœˆä¾›å’Œæ€»æˆæœ¬ï¼Œæ‚¨çœ‹å“ªç§æ›´åˆé€‚ï¼Ÿ`,
                    stage: 'é‡‘èæ–¹æ¡ˆæ¨è'
                });
                return scripts;
            }

            // ä¼˜å…ˆçº§5ï¼šç½®æ¢éœ€æ±‚
            if (keywords.hasTradeIn) {
                scripts.push({
                    type: 'trade_in',
                    title: 'ğŸ”„ ç½®æ¢æ–¹æ¡ˆæ¨è',
                    content: `æ‚¨é‚£è¾†${keywords.tradeInInfo}æ­£å¥½å¯ä»¥ç½®æ¢ï¼Œè¿™æ ·èƒ½æŠµä¸€éƒ¨åˆ†è½¦æ¬¾ï¼Œè¿˜èƒ½äº«å—é¢å¤–çš„ç½®æ¢è¡¥è´´ã€‚\n\nå’±ä»¬ç½®æ¢æµç¨‹ç‰¹åˆ«ç®€å•ï¼š\n1. åˆä½œçš„è¯„ä¼°å¸ˆå…è´¹ä¸Šé—¨è¯„ä¼°\n2. ä»·æ ¼é€æ˜ï¼Œæ‚¨å¯ä»¥æ‹¿å»è·Ÿå¸‚åœºä»·å¯¹æ¯”\n3. ä»·æ ¼æ»¡æ„çš„è¯ï¼Œç›´æ¥æŠµæ‰£æ–°è½¦è½¦æ¬¾\n4. è¿˜æœ‰é¢å¤–çš„ç½®æ¢è¡¥è´´ã€å…·ä½“é‡‘é¢éœ€å’¨è¯¢é—¨åº—ã€‘\n\nè€Œä¸”æ—§è½¦å¯ä»¥ä¸€ç›´å¼€åˆ°æ–°è½¦äº¤ä»˜ï¼Œä¸è€½è¯¯æ‚¨ç”¨è½¦ã€‚æ‚¨çœ‹è¦ä¸æˆ‘å…ˆå®‰æ’è¯„ä¼°å¸ˆç»™æ‚¨çš„è½¦ä¼°ä¸ªä»·ï¼Ÿ`,
                    stage: 'ç½®æ¢æ–¹æ¡ˆæ¨è'
                });
                return scripts;
            }

            return scripts;
        }

        // æ™ºèƒ½åˆ†æå®¢æˆ·
        function analyzeCustomer() {
            const input = document.getElementById('customerInput').value.trim();

            if (!input) {
                alert('è¯·è¾“å…¥å®¢æˆ·æè¿°ä¿¡æ¯');
                return;
            }

            const celnResult = analyzeCELN(input);
            const nineQuestionsResult = analyzeNineQuestions(input);
            const keywords = extractKeywords(input);
            const scripts = generateImprovedScripts(celnResult, nineQuestionsResult, keywords);

            displayResult(celnResult, nineQuestionsResult, keywords, scripts);
        }

        // æ˜¾ç¤ºç»“æœ
        function displayResult(celn, nineQuestions, keywords, scripts) {
            let html = '';

            // CELNæ ‡ç­¾
            html += '<div class="result-section">';
            html += '<h3>ğŸ“Š CELNæ¨¡å‹åˆ†æ</h3>';
            html += '<div class="celn-tags">';

            html += `<div class="celn-tag ${celn.C}">`;
            html += '<div class="dimension">C</div>';
            html += '<div class="name">è´­è½¦æ„å‘</div>';
            html += `<div class="value">${CELN_CONFIG.C.labels[celn.C]}</div>`;
            html += '</div>';

            html += `<div class="celn-tag ${celn.E === 'new_energy' ? 'high' : 'medium'}">`;
            html += '<div class="dimension">E</div>';
            html += '<div class="name">èƒ½æºç±»å‹</div>';
            html += `<div class="value">${CELN_CONFIG.E.labels[celn.E]}</div>`;
            html += '</div>';

            html += `<div class="celn-tag ${celn.L === 'ideal' ? 'high' : 'medium'}">`;
            html += '<div class="dimension">L</div>';
            html += '<div class="name">å“ç‰Œåå¥½</div>';
            html += `<div class="value">${CELN_CONFIG.L.labels[celn.L]}</div>`;
            html += '</div>';

            html += `<div class="celn-tag ${celn.N === 'immediate' ? 'high' : 'medium'}">`;
            html += '<div class="dimension">N</div>';
            html += '<div class="name">è´­ä¹°æ—¶æœº</div>';
            html += `<div class="value">${CELN_CONFIG.N.labels[celn.N]}</div>`;
            html += '</div>';

            html += '</div>';
            html += '</div>';

            // æ²Ÿé€šè®°å½•ç»Ÿè®¡ï¼ˆæ–°å¢ï¼‰
            const input = document.getElementById('customerInput').value.trim();
            const dates = extractDates(input);
            if (dates.length > 0) {
                html += '<div class="result-section">';
                html += '<h3>ğŸ“ æ²Ÿé€šè®°å½•</h3>';
                html += '<div style="background: #f0f7ff; padding: 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += `<div style="font-size: 15px; font-weight: 600; color: #333; margin-bottom: 8px;">`;
                html += `å·²è·Ÿè¿› <span style="color: #667eea; font-size: 20px;">${dates.length}</span> æ¬¡`;
                html += '</div>';
                html += `<div style="font-size: 13px; color: #666; line-height: 1.6;">`;
                html += `æ²Ÿé€šæ—¥æœŸï¼š${dates.join(' â†’ ')}`;
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            // æ¢éœ€ä¹é—®
            html += '<div class="result-section">';
            html += '<h3>ğŸ¯ æ¢éœ€ä¹é—®åˆ†æ</h3>';
            html += '<div class="probe-grid">';

            nineQuestions.forEach(q => {
                html += `<div class="probe-item ${q.status}">`;
                html += '<div style="flex: 1;">';
                html += `<div class="question-label">${q.label}</div>`;
                html += `<div class="answer">${q.answer}</div>`;
                html += '</div>';
                html += `<div class="status-badge ${q.status}">`;
                if (q.status === 'complete') html += 'âœ“ å·²æ¢éœ€';
                else if (q.status === 'partial') html += 'âš  éƒ¨åˆ†æ¢éœ€';
                else html += 'âœ— å¾…æ¢éœ€';
                html += '</div>';
                html += '</div>';
            });

            html += '</div>';
            html += '</div>';

            // è¡¥å……å…³é”®è¯ä¿¡æ¯ï¼ˆæ¢éœ€ä¹é—®æœªä½“ç°çš„ï¼‰
            html += '<div class="result-section">';
            html += '<h3>ğŸ·ï¸ è¡¥å……ä¿¡æ¯</h3>';
            html += '<div class="keyword-grid" style="display: grid; gap: 10px;">';

            let hasKeywords = false;

            if (keywords.models && keywords.models.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">æ„å‘è½¦å‹</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.models.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.competitors && keywords.competitors.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">ç«å“è½¦å‹</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.competitors.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.purpose && keywords.purpose.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">ç”¨è½¦åœºæ™¯</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.purpose.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.concerns && keywords.concerns.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">å…³æ³¨ç‚¹</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.concerns.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.visitedStores && keywords.visitedStores.length > 0) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">çœ‹è½¦é—¨åº—</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.visitedStores.join('ã€')}</div>`;
                html += '</div>';
            }

            if (keywords.residenceLocation) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">å±…ä½åœ°å€</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.residenceLocation}</div>`;
                html += '</div>';
            }

            if (keywords.financeSensitivity && keywords.financeSensitivity !== 'æœªçŸ¥') {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">é‡‘èæ•æ„Ÿåº¦</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">${keywords.financeSensitivity}</div>`;
                html += '</div>';
            }

            if (keywords.hasTradeIn) {
                hasKeywords = true;
                html += '<div class="keyword-item" style="background: #f8f9fa; padding: 12px 14px; border-radius: 10px; border-left: 4px solid #667eea;">';
                html += '<div class="category" style="font-size: 13px; color: #667eea; font-weight: 600; margin-bottom: 4px;">äºŒæ‰‹è½¦ç½®æ¢</div>';
                html += `<div class="keywords" style="font-size: 13px; color: #333; line-height: 1.5;">æœ‰ç½®æ¢éœ€æ±‚ï¼ˆ${keywords.tradeInInfo}ï¼‰</div>`;
                html += '</div>';
            }

            if (!hasKeywords) {
                html += '<div style="text-align: center; padding: 20px; color: #999; font-size: 13px;">æš‚æ— è¡¥å……ä¿¡æ¯</div>';
            }

            html += '</div>';
            html += '</div>';

            // è¯æœ¯æ¨è
            html += '<div class="result-section">';
            html += '<h3>ğŸ’¬ æ™ºèƒ½è¯æœ¯æ¨è</h3>';

            if (scripts.length === 0) {
                html += '<div style="text-align: center; padding: 20px; color: #999; font-size: 14px;">æš‚æ— è¯æœ¯æ¨è</div>';
            } else {
                scripts.forEach(script => {
                    html += `<div class="script-box ${script.type}">`;
                    html += `<h4>${script.title}</h4>`;
                    if (script.stage) {
                        html += `<div style="font-size: 12px; color: #666; margin-bottom: 8px;">ğŸ“ ${script.stage}</div>`;
                    }
                    html += `<p style="white-space: pre-line;">${script.content}</p>`;
                    html += '</div>';
                });
            }

            // æ¢éœ€å®Œæˆåº¦ç»Ÿè®¡
            const completeCount = nineQuestions.filter(q => q.status === 'complete').length;
            const partialCount = nineQuestions.filter(q => q.status === 'partial').length;
            const incompleteCount = nineQuestions.filter(q => q.status === 'incomplete').length;

            html += '<div class="key-points" style="background: #fff3e6; margin-top: 16px;">';
            html += '<h4>ğŸ“ˆ æ¢éœ€å®Œæˆåº¦</h4>';
            html += '<ul>';
            html += `<li>å®Œå…¨æ¢éœ€ï¼š${completeCount}/9 é¡¹</li>`;
            html += `<li>éƒ¨åˆ†æ¢éœ€ï¼š${partialCount}/9 é¡¹</li>`;
            html += `<li>å¾…æ¢éœ€ï¼š${incompleteCount}/9 é¡¹</li>`;
            if (incompleteCount > 0) {
                html += `<li><strong>å»ºè®®ï¼š</strong>é‡ç‚¹è¡¥å…… ${nineQuestions.filter(q => q.status === 'incomplete').map(q => q.label.split('.')[1].trim()).slice(0, 3).join('ã€')} ç­‰ä¿¡æ¯</li>`;
            }
            html += '</ul>';
            html += '</div>';

            html += '</div>';

            document.getElementById('resultArea').innerHTML = html;
        }

        // ========== åº—é•¿è§†å›¾åŠŸèƒ½ ==========

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });

                    // è¯»å–ç¬¬ä¸€ä¸ªsheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                    // è§£æå¹¶åˆ†ææ•°æ®
                    analyzeManagerData(jsonData);
                } catch (error) {
                    alert('Excelæ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ã€‚\n\néœ€è¦åŒ…å«å­—æ®µï¼šä¸“å®¶å§“åã€å®¢æˆ·å§“åã€å•†æœºç­‰çº§ã€å®¢æˆ·æè¿°');
                    console.error(error);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // æ‹–æ‹½ä¸Šä¼ 
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('drag-over');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) {
                document.getElementById('excelFile').files = e.dataTransfer.files;
                handleFileUpload({ target: { files: [file] } });
            }
        });

        // æ™ºèƒ½è¯†åˆ«å•†æœºç­‰çº§å­—æ®µ
        function findOpportunityLevelField(row) {
            // å¯èƒ½çš„å­—æ®µåï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰
            const possibleFields = [
                'å•†æœºç­‰çº§', 'å•†æœºç±»å‹', 'å•†æœº', 'ç­‰çº§', 'ç±»å‹',
                'å•†æœºçŠ¶æ€', 'çŠ¶æ€', 'çº§åˆ«', 'åˆ†ç±»'
            ];

            for (const field of possibleFields) {
                if (row.hasOwnProperty(field) && row[field]) {
                    return row[field];
                }
            }

            return null;
        }

        // æ™ºèƒ½è¯†åˆ«å•†æœºç­‰çº§
        function parseOpportunityLevel(levelStr) {
            if (!levelStr) return 'å…¶ä»–';

            // è½¬æ¢ä¸ºå­—ç¬¦ä¸²å¹¶å»é™¤ç©ºæ ¼
            const str = String(levelStr).trim();
            const upperStr = str.toUpperCase();

            // ç²¾ç¡®åŒ¹é… - A/B/C/FC
            if (upperStr === 'A' || upperStr === 'Aç±»' || upperStr === 'Aç±»å•†æœº' || str === 'Aç±»') return 'A';
            if (upperStr === 'B' || upperStr === 'Bç±»' || upperStr === 'Bç±»å•†æœº' || str === 'Bç±»') return 'B';
            if (upperStr === 'C' || upperStr === 'Cç±»' || upperStr === 'Cç±»å•†æœº' || str === 'Cç±»') return 'C';
            if (upperStr === 'FC' || upperStr === 'F' || upperStr === 'FORECAST' || str === 'FCç±»') return 'FC';

            // ç²¾ç¡®åŒ¹é… - ç‰¹æ®ŠçŠ¶æ€
            if (str === 'é•¿æœŸ' || str === 'é•¿æœŸå®¢æˆ·' || str === 'é•¿æœŸè·Ÿè¿›') return 'é•¿æœŸ';
            if (str === 'å·²æˆ˜è´¥' || str === 'æˆ˜è´¥' || str === 'å¤±è´¥' || str === 'å·²å¤±è´¥') return 'å·²æˆ˜è´¥';
            if (str === 'å·²é”å•' || str === 'é”å•' || str === 'å·²æˆäº¤' || str === 'æˆäº¤') return 'å·²é”å•';
            if (str === 'ç±»') return 'C'; // å•ç‹¬çš„"ç±»"å­—é»˜è®¤ä¸ºCç±»

            // æ¨¡ç³ŠåŒ¹é…
            if (upperStr.includes('FC') || upperStr.includes('FORECAST')) return 'FC';
            if (str.includes('æˆ˜è´¥') || str.includes('å¤±è´¥')) return 'å·²æˆ˜è´¥';
            if (str.includes('é”å•') || str.includes('æˆäº¤')) return 'å·²é”å•';
            if (str.includes('é•¿æœŸ')) return 'é•¿æœŸ';

            // å­—æ¯å¼€å¤´åŒ¹é…
            if (upperStr.startsWith('A')) return 'A';
            if (upperStr.startsWith('B')) return 'B';
            if (upperStr.startsWith('C')) return 'C';

            // å…¶ä»–æƒ…å†µç»Ÿä¸€å½’ç±»ä¸º"å…¶ä»–"
            return str || 'å…¶ä»–';
        }

        // åˆ†æåº—é•¿æ•°æ®
        function analyzeManagerData(data) {
            // æ•°æ®æ ¼å¼åŒ–ï¼šæ”¯æŒå¤šç§å­—æ®µå
            const customers = data.map(row => {
                const levelRaw = findOpportunityLevelField(row);
                return {
                    expert: row['ä¸“å®¶å§“å'] || row['é”€å”®'] || row['é¡¾é—®'] || row['é”€å”®é¡¾é—®'] || 'æœªçŸ¥ä¸“å®¶',
                    customer: row['å®¢æˆ·å§“å'] || row['å§“å'] || row['å®¢æˆ·'] || 'æœªçŸ¥å®¢æˆ·',
                    level: parseOpportunityLevel(levelRaw),
                    description: row['å®¢æˆ·æè¿°'] || row['æè¿°'] || row['å¤‡æ³¨'] || row['ä¿¡æ¯'] || ''
                };
            });

            // åˆ†ææ¯ä¸ªå®¢æˆ·çš„æ¢éœ€æƒ…å†µ
            const analyzedCustomers = customers.map(c => {
                const probeResult = analyzeNineQuestions(c.description);
                const completeCount = probeResult.filter(q => q.status === 'complete').length;
                const partialCount = probeResult.filter(q => q.status === 'partial').length;
                const incompleteCount = probeResult.filter(q => q.status === 'incomplete').length;
                const completionRate = ((completeCount + partialCount * 0.5) / 9 * 100).toFixed(0);

                return {
                    ...c,
                    probeResult,
                    completeCount,
                    partialCount,
                    incompleteCount,
                    completionRate: parseInt(completionRate)
                };
            });

            // æŒ‰ä¸“å®¶åˆ†ç»„
            const expertGroups = {};
            analyzedCustomers.forEach(c => {
                if (!expertGroups[c.expert]) {
                    expertGroups[c.expert] = [];
                }
                expertGroups[c.expert].push(c);
            });

            // ä¿å­˜åˆ°å…¨å±€
            managerData = {
                customers: analyzedCustomers,
                expertGroups
            };

            // æ˜¾ç¤ºåˆ†æç»“æœ
            displayManagerAnalysis(managerData);
        }

        // æ˜¾ç¤ºåº—é•¿åˆ†æç»“æœ
        function displayManagerAnalysis(data) {
            document.getElementById('managerAnalysis').style.display = 'block';

            // æ•´ä½“ç»Ÿè®¡
            const totalCustomers = data.customers.length;

            // ç»Ÿè®¡æ‰€æœ‰å•†æœºç±»å‹
            const levelStats = {};
            data.customers.forEach(c => {
                levelStats[c.level] = (levelStats[c.level] || 0) + 1;
            });

            // å¹³å‡æ¢éœ€å®Œæˆåº¦
            const avgCompletion = Math.round(data.customers.reduce((sum, c) => sum + c.completionRate, 0) / totalCustomers);

            // åŠ¨æ€ç”Ÿæˆç»Ÿè®¡å¡ç‰‡
            let statsHtml = '';

            // æ€»å®¢æˆ·æ•°å¡ç‰‡
            statsHtml += '<div class="stat-card">';
            statsHtml += '<h3>æ€»å®¢æˆ·æ•°</h3>';
            statsHtml += `<div class="value">${totalCustomers}</div>`;
            statsHtml += '<div class="subtext">å·²å¯¼å…¥å®¢æˆ·</div>';
            statsHtml += '</div>';

            // æŒ‰å•†æœºç±»å‹ä¼˜å…ˆçº§æ’åºå¹¶ç”Ÿæˆå¡ç‰‡
            const levelOrder = ['A', 'B', 'C', 'FC', 'é•¿æœŸ', 'å·²é”å•', 'å·²æˆ˜è´¥'];
            const levelLabels = {
                'A': 'Aç±»å•†æœº',
                'B': 'Bç±»å•†æœº',
                'C': 'Cç±»å•†æœº',
                'FC': 'FCå•†æœº',
                'é•¿æœŸ': 'é•¿æœŸå®¢æˆ·',
                'å·²é”å•': 'å·²é”å•',
                'å·²æˆ˜è´¥': 'å·²æˆ˜è´¥'
            };
            const levelSubtext = {
                'A': 'é«˜æ„å‘å®¢æˆ·',
                'B': 'ä¸­æ„å‘å®¢æˆ·',
                'C': 'ä½æ„å‘å®¢æˆ·',
                'FC': 'é¢„æµ‹å•†æœº',
                'é•¿æœŸ': 'é•¿æœŸè·Ÿè¿›',
                'å·²é”å•': 'æˆäº¤å®¢æˆ·',
                'å·²æˆ˜è´¥': 'å·²å¤±è´¥'
            };

            // å…ˆæ˜¾ç¤ºå¸¸è§„ç±»å‹
            levelOrder.forEach(level => {
                if (levelStats[level]) {
                    statsHtml += '<div class="stat-card">';
                    statsHtml += `<h3>${levelLabels[level] || level}</h3>`;
                    statsHtml += `<div class="value">${levelStats[level]}</div>`;
                    statsHtml += `<div class="subtext">${levelSubtext[level] || 'å®¢æˆ·'}</div>`;
                    statsHtml += '</div>';
                }
            });

            // æ˜¾ç¤ºå…¶ä»–ç±»å‹
            Object.keys(levelStats).forEach(level => {
                if (!levelOrder.includes(level)) {
                    statsHtml += '<div class="stat-card">';
                    statsHtml += `<h3>${level}</h3>`;
                    statsHtml += `<div class="value">${levelStats[level]}</div>`;
                    statsHtml += '<div class="subtext">å®¢æˆ·</div>';
                    statsHtml += '</div>';
                }
            });

            // å¹³å‡æ¢éœ€å®Œæˆåº¦å¡ç‰‡
            statsHtml += '<div class="stat-card">';
            statsHtml += '<h3>å¹³å‡æ¢éœ€å®Œæˆåº¦</h3>';
            statsHtml += `<div class="value">${avgCompletion}%</div>`;
            statsHtml += '<div class="subtext">9ä¸ªç»´åº¦</div>';
            statsHtml += '</div>';

            // æ›´æ–°ç»Ÿè®¡å¡ç‰‡å®¹å™¨
            document.querySelector('.stats-grid').innerHTML = statsHtml;

            // å›¢é˜Ÿæ¢éœ€è–„å¼±é¡¹åˆ†æ
            const weaknessStats = {};
            NINE_QUESTIONS.forEach(q => {
                weaknessStats[q.id] = {
                    label: q.label.split('.')[1].trim(),
                    complete: 0,
                    incomplete: 0,
                    partial: 0,
                    total: totalCustomers
                };
            });

            data.customers.forEach(c => {
                c.probeResult.forEach(p => {
                    if (p.status === 'complete') {
                        weaknessStats[p.id].complete++;
                    } else if (p.status === 'incomplete') {
                        weaknessStats[p.id].incomplete++;
                    } else if (p.status === 'partial') {
                        weaknessStats[p.id].partial++;
                    }
                });
            });

            // è®¡ç®—æ¢éœ€å®Œæˆåº¦å¹¶æ’åºï¼ˆå®Œæˆåº¦è¶Šä½è¶Šé å‰ï¼‰
            const weaknessArray = Object.values(weaknessStats).map(w => {
                // å®Œæˆåº¦ = (å®Œå…¨æ¢éœ€æ•° + éƒ¨åˆ†æ¢éœ€æ•° * 0.5) / æ€»æ•°
                const completionRate = (w.complete + w.partial * 0.5) / w.total * 100;
                return {
                    ...w,
                    completionRate: completionRate
                };
            }).sort((a, b) => a.completionRate - b.completionRate); // æŒ‰å®Œæˆåº¦å‡åºæ’åºï¼Œè¶Šä½è¶Šé å‰

            let weaknessHtml = '';
            weaknessArray.slice(0, 5).forEach(w => {
                const percentage = w.completionRate.toFixed(0);
                let barClass = '';
                // å®Œæˆåº¦ä½äº40%ï¼šçº¢è‰²ï¼ˆå·®ï¼‰
                // å®Œæˆåº¦40-60%ï¼šæ©™è‰²ï¼ˆä¸­ç­‰ï¼‰
                // å®Œæˆåº¦é«˜äº60%ï¼šè“è‰²ï¼ˆå¥½ï¼‰
                if (percentage < 40) barClass = 'low';
                else if (percentage < 60) barClass = 'medium';

                weaknessHtml += '<div class="probe-bar">';
                weaknessHtml += `<div class="label">${w.label}</div>`;
                weaknessHtml += '<div class="bar-container">';
                weaknessHtml += `<div class="bar-fill ${barClass}" style="width: ${percentage}%">`;
                weaknessHtml += `<span class="percentage">${percentage}%</span>`;
                weaknessHtml += '</div>';
                weaknessHtml += '</div>';
                weaknessHtml += '</div>';
            });
            document.getElementById('weaknessAnalysis').innerHTML = weaknessHtml;

            // å„ä¸“å®¶è¯¦ç»†åˆ†æ
            let expertHtml = '';
            let expertIndex = 0;
            Object.entries(data.expertGroups).forEach(([expertName, customers]) => {
                const avgRate = Math.round(customers.reduce((sum, c) => sum + c.completionRate, 0) / customers.length);

                // ç»Ÿè®¡è¯¥ä¸“å®¶çš„å„ç±»å•†æœº
                const expertLevelStats = {};
                customers.forEach(c => {
                    expertLevelStats[c.level] = (expertLevelStats[c.level] || 0) + 1;
                });

                // ç”Ÿæˆå•†æœºç±»å‹ç»Ÿè®¡æ–‡æœ¬
                const levelOrder = ['A', 'B', 'C', 'FC', 'é•¿æœŸ', 'å·²é”å•', 'å·²æˆ˜è´¥'];
                const levelEmojis = {
                    'A': 'ğŸ”´',
                    'B': 'ğŸŸ ',
                    'C': 'ğŸ”µ',
                    'FC': 'ğŸŸ£',
                    'é•¿æœŸ': 'ğŸŸ¢',
                    'å·²é”å•': 'ğŸŸ¡',
                    'å·²æˆ˜è´¥': 'âšª'
                };

                let levelStatsText = '';
                levelOrder.forEach(level => {
                    if (expertLevelStats[level]) {
                        const emoji = levelEmojis[level] || 'âš«';
                        levelStatsText += `${emoji} ${level}: ${expertLevelStats[level]} `;
                    }
                });
                // æ·»åŠ å…¶ä»–ç±»å‹
                Object.keys(expertLevelStats).forEach(level => {
                    if (!levelOrder.includes(level)) {
                        levelStatsText += `âš« ${level}: ${expertLevelStats[level]} `;
                    }
                });

                const expertId = `expert-${expertIndex}`;
                expertIndex++;

                expertHtml += '<div class="expert-card">';

                // ä¸“å®¶å¤´éƒ¨ï¼ˆå¯ç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰
                expertHtml += `<div class="expert-header" onclick="toggleExpertDetails('${expertId}')">`;
                expertHtml += '<div class="expert-name">';
                expertHtml += `<span class="expand-icon" id="${expertId}-icon">â–¶</span>`;
                expertHtml += expertName;
                expertHtml += '</div>';
                expertHtml += '<div class="expert-stats">';
                expertHtml += `<span>ğŸ“Š æ¢éœ€å®Œæˆåº¦: ${avgRate}%</span>`;
                expertHtml += `<span>ğŸ‘¥ å®¢æˆ·æ•°: ${customers.length}</span>`;
                expertHtml += `<span>${levelStatsText}</span>`;
                expertHtml += '</div>';
                expertHtml += '</div>';

                // è¯¦æƒ…åŒºåŸŸï¼ˆé»˜è®¤éšè—ï¼‰
                expertHtml += `<div class="expert-details" id="${expertId}">`;

                // è®¡ç®—è¯¥ä¸“å®¶çš„æ¢éœ€å®Œæˆåº¦ç»Ÿè®¡
                const expertProbeStats = {};
                NINE_QUESTIONS.forEach(q => {
                    expertProbeStats[q.id] = {
                        label: q.label.split('.')[1].trim(),
                        question: q.question,
                        complete: 0,
                        incomplete: 0,
                        partial: 0,
                        total: customers.length
                    };
                });
                customers.forEach(c => {
                    c.probeResult.forEach(p => {
                        if (p.status === 'complete') {
                            expertProbeStats[p.id].complete++;
                        } else if (p.status === 'incomplete') {
                            expertProbeStats[p.id].incomplete++;
                        } else if (p.status === 'partial') {
                            expertProbeStats[p.id].partial++;
                        }
                    });
                });

                // è®¡ç®—æ¢éœ€å®Œæˆåº¦å¹¶æ’åºï¼ˆå®Œæˆåº¦è¶Šä½è¶Šé å‰ï¼‰
                const expertProbeArray = Object.entries(expertProbeStats).map(([id, stats]) => {
                    const completionRate = (stats.complete + stats.partial * 0.5) / stats.total * 100;
                    return {
                        id: id,
                        ...stats,
                        completionRate: completionRate
                    };
                }).sort((a, b) => a.completionRate - b.completionRate);

                // å–å‰5ä¸ªè–„å¼±é¡¹
                const topWeaknessWithRate = expertProbeArray.slice(0, 5);

                if (topWeaknessWithRate.length > 0 && topWeaknessWithRate[0].completionRate < 100) {
                    expertHtml += '<h4 style="font-size: 14px; color: #333; margin-bottom: 12px; font-weight: 600;">âš ï¸ æ¢éœ€è–„å¼±é¡¹åˆ†æï¼ˆæŒ‰å®Œæˆåº¦ä»ä½åˆ°é«˜ï¼‰</h4>';

                    topWeaknessWithRate.forEach(w => {
                        const percentage = w.completionRate.toFixed(0);
                        let barClass = '';
                        if (percentage < 40) barClass = 'low';
                        else if (percentage < 60) barClass = 'medium';

                        expertHtml += '<div style="margin-bottom: 20px; padding: 15px; background: #fff9f0; border-radius: 10px; border-left: 4px solid #ff9800;">';

                        // æ¢éœ€é¡¹åç§°å’Œè¿›åº¦æ¡
                        expertHtml += '<div class="probe-bar" style="margin-bottom: 10px;">';
                        expertHtml += `<div class="label" style="font-weight: 600; color: #333;">${w.label}</div>`;
                        expertHtml += '<div class="bar-container">';
                        expertHtml += `<div class="bar-fill ${barClass}" style="width: ${percentage}%">`;
                        expertHtml += `<span class="percentage">${percentage}%</span>`;
                        expertHtml += '</div>';
                        expertHtml += '</div>';
                        expertHtml += '</div>';

                        // æ”¹è¿›å»ºè®®è¯æœ¯
                        expertHtml += '<div style="background: white; padding: 12px; border-radius: 8px; margin-top: 10px;">';
                        expertHtml += '<div style="font-size: 12px; color: #ff9800; font-weight: 600; margin-bottom: 8px;">ğŸ’¡ æ”¹è¿›è¯æœ¯å»ºè®®</div>';

                        // æ ¹æ®ä¸åŒçš„æ¢éœ€ç»´åº¦ç”Ÿæˆè¯æœ¯
                        const improvementScripts = generateImprovementScripts(w.id, w.question);
                        improvementScripts.forEach((script, idx) => {
                            expertHtml += `<div style="font-size: 12px; color: #666; line-height: 1.8; margin-bottom: ${idx === improvementScripts.length - 1 ? '0' : '8px'}; padding-left: 12px; position: relative;">`;
                            expertHtml += `<span style="position: absolute; left: 0; color: #ff9800; font-weight: bold;">${idx + 1}.</span>`;
                            expertHtml += script;
                            expertHtml += '</div>';
                        });

                        expertHtml += '</div>';
                        expertHtml += '</div>';
                    });
                } else {
                    expertHtml += '<div style="padding: 15px; text-align: center; color: #4caf50; font-size: 13px; background: #f1f8f4; border-radius: 8px; margin-bottom: 15px;">';
                    expertHtml += 'âœ“ è¯¥ä¸“å®¶æ¢éœ€å®Œæˆåº¦è‰¯å¥½ï¼Œæ— æ˜æ˜¾è–„å¼±é¡¹';
                    expertHtml += '</div>';
                }

                // å®¢æˆ·åˆ—è¡¨
                expertHtml += '<h4 style="font-size: 14px; color: #333; margin: 20px 0 12px; font-weight: 600;">ğŸ‘¥ å®¢æˆ·è¯¦æƒ…</h4>';
                expertHtml += '<table class="customer-table">';
                expertHtml += '<thead><tr><th>å®¢æˆ·å§“å</th><th>å•†æœºç­‰çº§</th><th>æ¢éœ€å®Œæˆåº¦</th><th>æ¢éœ€ä¸åˆ°ä½é¡¹</th></tr></thead>';
                expertHtml += '<tbody>';
                customers.forEach(c => {
                    const issues = c.probeResult.filter(p => p.status === 'incomplete' || p.status === 'partial');
                    expertHtml += '<tr>';
                    expertHtml += `<td>${c.customer}</td>`;
                    expertHtml += `<td><span class="level-badge ${c.level}">${c.level}ç±»</span></td>`;
                    expertHtml += `<td>${c.completionRate}% (${c.completeCount}/9)</td>`;
                    expertHtml += '<td>';
                    if (issues.length === 0) {
                        expertHtml += '<span style="color: #4caf50; font-size: 12px;">âœ“ æ¢éœ€å®Œæ•´</span>';
                    } else {
                        issues.forEach(issue => {
                            const badgeClass = issue.status === 'incomplete' ? 'critical' : 'warning';
                            expertHtml += `<span class="issue-badge ${badgeClass}">${issue.label.split('.')[1].trim()}</span>`;
                        });
                    }
                    expertHtml += '</td>';
                    expertHtml += '</tr>';
                });
                expertHtml += '</tbody></table>';

                expertHtml += '</div>'; // å…³é—­ expert-details
                expertHtml += '</div>'; // å…³é—­ expert-card
            });

            document.getElementById('expertList').innerHTML = expertHtml;
        }

        // ç”Ÿæˆæ¢éœ€æ”¹è¿›è¯æœ¯å»ºè®®ï¼ˆæ ¹æ®å…·ä½“æ¢éœ€ç»´åº¦ï¼‰
        function generateImprovementScripts(probeId, question) {
            const scripts = {
                'energy_intention': [
                    'æ‚¨è¿™è¾¹æ˜¯æ‰“ç®—ä¹°å¢ç¨‹è¿˜æ˜¯çº¯ç”µå‘¢ï¼Ÿå¢ç¨‹çš„è¯æ²¡æœ‰ç»­èˆªç„¦è™‘ï¼Œçº¯ç”µçš„è¯ç”¨è½¦æˆæœ¬æ›´ä½ï¼Œå„æœ‰ä¼˜åŠ¿',
                    'å’±ä»¬ç†æƒ³æœ‰å¢ç¨‹å’Œçº¯ç”µä¸¤ç§ï¼Œæ‚¨å¹³æ—¶ç”¨è½¦æ˜¯å¸‚åŒºå¤šè¿˜æ˜¯ç»å¸¸è·‘é•¿é€”ï¼Ÿè¿™æ ·æˆ‘èƒ½å¸®æ‚¨æ¨èæ›´åˆé€‚çš„èƒ½æºå½¢å¼'
                ],
                'current_car': [
                    'æ‚¨ç°åœ¨å¼€çš„ä»€ä¹ˆè½¦å‘€ï¼Ÿæ˜¯æ‰“ç®—ç½®æ¢è¿˜æ˜¯å¢è´­ç¬¬äºŒè¾†è½¦å‘¢ï¼Ÿäº†è§£ä¸€ä¸‹èƒ½æ›´å¥½åœ°ç»™æ‚¨æ¨è',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨ç›®å‰çš„ç”¨è½¦æƒ…å†µï¼Œå®¶é‡Œç°åœ¨æœ‰è½¦å—ï¼Ÿæ˜¯ä»€ä¹ˆå“ç‰Œçš„ï¼Ÿæ‰“ç®—å–æ‰æ¢æ–°è½¦è¿˜æ˜¯å†ä¹°ä¸€è¾†ï¼Ÿ'
                ],
                'usage_scenario': [
                    'æ‚¨å¹³æ—¶ä¸»è¦ç”¨è½¦æ˜¯ä¸Šä¸‹ç­é€šå‹¤ï¼Œè¿˜æ˜¯å‘¨æœ«å¸¦å®¶äººå‡ºå»ç©æ¯”è¾ƒå¤šï¼Ÿ',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨çš„ç”¨è½¦åœºæ™¯ï¼Œæ˜¯å¸‚åŒºä¸ºä¸»è¿˜æ˜¯ç»å¸¸è·‘é•¿é€”ï¼Ÿæœ‰æ²¡æœ‰æ¥é€å­©å­ã€è‡ªé©¾æ¸¸è¿™äº›éœ€æ±‚ï¼Ÿ'
                ],
                'budget': [
                    'æ‚¨è¿™è¾¹è´­è½¦é¢„ç®—å¤§æ¦‚åœ¨ä»€ä¹ˆèŒƒå›´å‘¢ï¼Ÿè¿™æ ·æˆ‘èƒ½ç»™æ‚¨æ¨èæœ€åˆé€‚çš„è½¦å‹é…ç½®',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨çš„é¢„ç®—åŒºé—´ï¼Œå¤§æ¦‚å¤šå°‘ä¸‡å·¦å³ï¼Ÿå’±ä»¬ç†æƒ³æœ‰ä¸åŒä»·ä½çš„è½¦å‹å¯ä»¥é€‰æ‹©'
                ],
                'family_structure': [
                    'æ‚¨å®¶é‡Œå‡ å£äººå‘€ï¼Ÿæœ‰è€äººå’Œå­©å­å—ï¼Ÿè¿™ä¸ªå¯¹é€‰5åº§è¿˜æ˜¯6åº§è½¦å‹å¾ˆé‡è¦',
                    'äº†è§£ä¸€ä¸‹æ‚¨çš„å®¶åº­æƒ…å†µï¼Œå¹³æ—¶ç”¨è½¦ä¸»è¦æ˜¯å‡ ä¸ªäººï¼Ÿæœ‰æ²¡æœ‰å¸¦è€äººå­©å­å‡ºè¡Œçš„éœ€æ±‚ï¼Ÿ'
                ],
                'decision_maker': [
                    'è¿™æ¬¡ä¹°è½¦ä¸»è¦æ˜¯æ‚¨è‡ªå·±å†³å®šï¼Œè¿˜æ˜¯éœ€è¦å’Œå®¶äººå•†é‡ä¸€ä¸‹ï¼Ÿæˆ‘å¥½å®‰æ’åç»­çš„è¯•é©¾å’Œè®²è§£',
                    'æƒ³ç¡®è®¤ä¸€ä¸‹ï¼Œè´­è½¦å†³ç­–æ˜¯æ‚¨ä¸€ä¸ªäººåšä¸»ï¼Œè¿˜æ˜¯éœ€è¦çˆ±äººæˆ–è€…çˆ¶æ¯ä¸€èµ·å‚ä¸ï¼Ÿå’±ä»¬å¯ä»¥ä¸€èµ·çº¦ä¸ªæ—¶é—´è¯¦ç»†èŠèŠ'
                ],
                'key_features': [
                    'æ‚¨ä¹°è½¦æœ€çœ‹é‡å“ªäº›æ–¹é¢å‘¢ï¼Ÿæ˜¯ç»­èˆªã€æ™ºèƒ½é©¾é©¶ã€ç©ºé—´èˆ’é€‚æ€§ï¼Œè¿˜æ˜¯å®‰å…¨é…ç½®ï¼Ÿ',
                    'æƒ³äº†è§£ä¸€ä¸‹æ‚¨æœ€å…³æ³¨çš„åŠŸèƒ½ç‚¹ï¼Œæ¯”å¦‚ç»­èˆªé‡Œç¨‹ã€æ™ºèƒ½é©¾é©¶ã€ç©ºé—´å¤§å°ã€å……ç”µé€Ÿåº¦è¿™äº›ï¼Œæ‚¨ä¼˜å…ˆè€ƒè™‘å“ªäº›ï¼Ÿ'
                ],
                'competitor_comparison': [
                    'æ‚¨æœ€è¿‘è¿˜åœ¨çœ‹å“ªäº›å“ç‰Œçš„è½¦å‘€ï¼Ÿè”šæ¥ã€å°é¹ã€é—®ç•Œè¿™äº›æœ‰åœ¨å¯¹æ¯”å—ï¼Ÿæˆ‘å¯ä»¥å¸®æ‚¨è¯¦ç»†åˆ†æä¸€ä¸‹å·®å¼‚',
                    'é™¤äº†å’±ä»¬ç†æƒ³ï¼Œæ‚¨è¿˜æœ‰åœ¨çœ‹å…¶ä»–å“ç‰Œå—ï¼Ÿäº†è§£ä¸€ä¸‹èƒ½å¸®æ‚¨åšæ›´å‡†ç¡®çš„å¯¹æ¯”åˆ†æ'
                ],
                'purchase_timing': [
                    'æ‚¨è¿™è¾¹è®¡åˆ’ä»€ä¹ˆæ—¶å€™ç”¨ä¸Šè½¦å‘¢ï¼Ÿæ˜¯æ¯”è¾ƒæ€¥è¿˜æ˜¯å¯ä»¥å†çœ‹çœ‹ï¼Ÿäº†è§£ä¸€ä¸‹å¥½ç»™æ‚¨å®‰æ’è¯•é©¾å’Œäº¤ä»˜',
                    'æƒ³ç¡®è®¤ä¸€ä¸‹æ‚¨çš„è´­è½¦æ—¶é—´ï¼Œæ˜¯è¿‘æœŸå°±è¦ï¼Œè¿˜æ˜¯3ä¸ªæœˆã€åŠå¹´å†…ï¼Ÿè¿™æ ·æˆ‘èƒ½å¸®æ‚¨è§„åˆ’å¥½è¯•é©¾å’Œè®¢è½¦èŠ‚å¥'
                ]
            };

            return scripts[probeId] || [
                'å»ºè®®å¤šè¯¢é—®å®¢æˆ·å…·ä½“éœ€æ±‚ï¼Œäº†è§£æ›´å¤šç»†èŠ‚ä¿¡æ¯',
                'å¯ä»¥ç”¨å¼€æ”¾å¼é—®é¢˜å¼•å¯¼å®¢æˆ·ï¼Œè®©å®¢æˆ·å¤šè¯´è¯´è‡ªå·±çš„æƒ³æ³•å’Œé¡¾è™‘'
            ];
        }

        // åˆ‡æ¢ä¸“å®¶è¯¦æƒ…æ˜¾ç¤º/éšè—
        function toggleExpertDetails(expertId) {
            const detailsDiv = document.getElementById(expertId);
            const icon = document.getElementById(expertId + '-icon');

            if (detailsDiv.classList.contains('show')) {
                detailsDiv.classList.remove('show');
                icon.classList.remove('expanded');
            } else {
                detailsDiv.classList.add('show');
                icon.classList.add('expanded');
            }
        }
    </script>
</body>
</html>